<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App ‚Äî v3 fix-rows</title>
<style>
:root{--fg:#111;--bg:#f7f7f7;--panel:#fff;--accent:#0a7;}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;background:#0a7;color:#fff;padding:12px 16px;display:flex;gap:10px;align-items:center;z-index:5}
header h1{font-size:18px;margin:0 8px 0 0}
header nav button{background:#fff;color:#0a7;border:none;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
main{max-width:980px;margin:16px auto;padding:0 12px}
.card{background:var(--panel);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px 14px;margin:14px 0}
label{font-size:12px;opacity:.8;display:block;margin-bottom:4px}
input,select,button{font-size:14px;padding:10px;border:1px solid #ddd;border-radius:10px;width:100%}
.row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.btn{background:var(--accent);color:#fff;border:none;font-weight:700;cursor:pointer}
.btn.secondary{background:#444}
.btn.warn{background:#d33}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:center;background:#fff;padding:8px 10px;border:1px solid #eee}
th{background:#f0f9f4;font-weight:700}
.small{font-size:12px;opacity:.75}
.badge{display:inline-block;background:#eef;border:1px solid #dde;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px}
.rungTitle{font-weight:700;margin:14px 0 6px}
footer{margin:24px 0;text-align:center;font-size:12px;opacity:.7}
.hidden{display:none}
.note{background:#fff6d6;border:1px solid #ffe29b;border-radius:10px;padding:8px 10px;margin:8px 0}
</style>
</head>
<body>
<header>
  <h1>üìà Ladder App</h1>
  <nav>
    <button id="tabLadders">Ladders</button>
    <button id="tabCharts" class="secondary">Charts</button>
  </nav>
  <div class="small" style="margin-left:auto">Auto‚Äësave enabled</div>
</header>

<main>
<section id="laddersView" class="card">
  <div class="row">
    <div>
      <label>Ticker / Name</label>
      <input id="ticker" placeholder="e.g., RIOT">
    </div>
    <div>
      <label>Rungs</label>
      <select id="rungs">
        <option value="2">2 rungs</option>
        <option value="3" selected>3 rungs</option>
        <option value="4">4 rungs</option>
      </select>
    </div>
    <div>
      <label>Start Price</label>
      <input id="startPrice" type="number" step="0.01" placeholder="current price">
    </div>
    <div>
      <label>Default Shares / row</label>
      <input id="defShares" type="number" min="0" step="1" value="1">
    </div>
  </div>

  <div class="note small">Presets (locked): Sell +2.5%, +4.5%, +7%, +10% (first 2‚Äì4 rungs based on selection). Buyback 1%, 2.5%, 3.5%, 5% (rungs 1‚Äì4). 20 cycles. <b>Rows should step upward each cycle.</b></div>

  <div class="row" style="margin-top:8px">
    <button class="btn" id="addAsset">+ Add / Replace Asset</button>
    <button class="btn secondary" id="exportJson">Export JSON</button>
    <button class="btn secondary" id="importJson">Import JSON</button>
    <span></span>
  </div>
</section>

<section id="assets"></section>

<section id="chartsView" class="card hidden">
  <h2>Totals & Charts</h2>
  <div class="row">
    <div>
      <label>Year</label>
      <input id="chartYear" type="number" value="2025">
    </div>
    <div>
      <label>&nbsp;</label>
      <button class="btn" id="btnYearTotal">Year Total</button>
    </div>
    <div>
      <label>From</label>
      <input id="fromDate" type="date">
    </div>
    <div>
      <label>To</label>
      <input id="toDate" type="date">
    </div>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn" id="btnUpdateChart">Update Chart</button>
  </div>
  <canvas id="plChart" height="300" style="margin-top:12px;background:#fff;border:1px solid #eee;border-radius:10px"></canvas>
  <div class="small note">Chart uses realized P/L data (when you fill in Actual Buy/Sell/Qty on ladder rows). Demo includes placeholder points until you record real trades.</div>
</section>

<footer>v3 fix-rows ‚Ä¢ If values don‚Äôt update, tap ‚ÄúBuild Ladder‚Äù.</footer>
</main>

<script>
// --- Math helpers ---
function pct(n){return +n/100}
function currency(n){return '$'+(+n).toFixed(2)}

// Presets locked
const SELL_STEPS=[2.5,4.5,7,10]
const BUYBACKS=[1,2.5,3.5,5]

// State in localStorage
const KEY='ladder_app_v3_state'
let state = JSON.parse(localStorage.getItem(KEY)||'{"assets":[]}')

// Tab switching
const laddersView=document.getElementById('laddersView')
const chartsView=document.getElementById('chartsView')
document.getElementById('tabLadders').onclick=()=>{laddersView.classList.remove('hidden');chartsView.classList.add('hidden')}
document.getElementById('tabCharts').onclick=()=>{chartsView.classList.remove('hidden');laddersView.classList.add('hidden');renderChart()}

// Add/replace asset
document.getElementById('addAsset').onclick=()=>{
  const ticker=(document.getElementById('ticker').value||'ASSET').toUpperCase()
  const rungs=parseInt(document.getElementById('rungs').value,10)
  const start=parseFloat(document.getElementById('startPrice').value||'0')
  const defShares=parseInt(document.getElementById('defShares').value||'1',10)

  if(!start||start<=0){alert('Enter a valid Start Price');return}

  // Build ladder data for 20 cycles per rung
  const ladders=[]
  for(let r=0;r<rungs;r++){
    const sellPct = SELL_STEPS[r]
    const buyPct  = BUYBACKS[r]
    let sell = start*(1+pct(sellPct))  // first cycle sell
    let buy  = sell*(1-pct(buyPct))    // first cycle buy just below that sell
    const rows=[]
    for(let i=1;i<=20;i++){
      rows.push({
        cycle:i,
        plannedBuy:+buy.toFixed(2),
        plannedSell:+sell.toFixed(2),
        profitPerShare:+(sell-buy).toFixed(2),
        plannedShares:defShares,
        buyDate:'',
        sellDate:'',
        actualBuy:'',
        actualSell:'',
        filledQty:'',
        realizedPL:''
      })
      // Step UP for next cycle: sell grows by the same sellPct over previous sell
      sell = sell*(1+pct(sellPct))
      buy  = sell*(1-pct(buyPct))
    }
    ladders.push({rung:r+1,sellPct,buyPct,rows})
  }

  // Replace or add
  const existingIndex = state.assets.findIndex(a=>a.ticker===ticker)
  const asset = {ticker,start,rungs,defShares,ladders}
  if(existingIndex>=0) state.assets[existingIndex]=asset; else state.assets.push(asset)
  save(); renderAssets()
}

// Export / Import
document.getElementById('exportJson').onclick=()=>{
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'})
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='ladder_backup.json';a.click()
}
document.getElementById('importJson').onclick=()=>{
  const inp=document.createElement('input');inp.type='file';inp.accept='application/json'
  inp.onchange=e=>{
    const file=e.target.files[0]; if(!file) return
    const fr=new FileReader(); fr.onload=()=>{state=JSON.parse(fr.result); save(); renderAssets()}; fr.readAsText(file)
  }
  inp.click()
}

// Save
function save(){ localStorage.setItem(KEY,JSON.stringify(state)) }

// Render assets and tables
function renderAssets(){
  const host=document.getElementById('assets')
  host.innerHTML=''
  state.assets.forEach((a,ai)=>{
    const card=document.createElement('section'); card.className='card'
    const hdr=document.createElement('div')
    hdr.innerHTML=`<h2 style="margin:0 0 8px"> ${a.ticker} <span class="badge">${a.rungs} rung(s)</span> <span class="badge">start ${currency(a.start)}</span></h2>
    <div class="small">Rungs use locked defaults: Sell +2.5%, +4.5%, +7%, +10% ‚Ä¢ Buyback 1%, 2.5%, 3.5%, 5% ‚Ä¢ 20 cycles. Edit any cell inline.</div>
    <div class="row" style="margin-top:8px">
      <button class="btn" data-build="${ai}">Build Ladder</button>
      <button class="btn secondary" data-csv="${ai}">Export CSV</button>
      <button class="btn warn" data-del="${ai}">Delete Ladder</button>
    </div>`
    card.appendChild(hdr)

    a.ladders.forEach(r=>{
      const title=document.createElement('div'); title.className='rungTitle'
      title.textContent=`${a.ticker} ‚Äî Rung ${r.rung}   ‚Ä¢  Sell +${r.sellPct}%   ‚Ä¢  Buyback ${r.buyPct}%`
      card.appendChild(title)

      const tbl=document.createElement('table')
      tbl.innerHTML=`<thead><tr>
        <th>#</th><th>Planned Buy</th><th>Planned Sell</th><th>Profit/Share</th>
        <th>Planned Shares</th><th>Planned Total</th>
        <th>Buy Date</th><th>Sell Date</th><th>Actual Buy</th><th>Actual Sell</th><th>Filled Qty</th><th>Realized P/L</th>
      </tr></thead><tbody></tbody>`
      const tb=tbl.querySelector('tbody')
      r.rows.forEach((row,ri)=>{
        const tr=document.createElement('tr')
        const total= row.plannedShares ? (row.plannedShares*(row.plannedSell-row.plannedBuy)) : 0
        tr.innerHTML=`
          <td>${row.cycle}</td>
          <td><input type="number" step="0.01" value="${row.plannedBuy}"></td>
          <td><input type="number" step="0.01" value="${row.plannedSell}"></td>
          <td>${currency(row.profitPerShare)}</td>
          <td><input type="number" step="1" value="${row.plannedShares}"></td>
          <td>${currency(total)}</td>
          <td><input type="date" value="${row.buyDate}"></td>
          <td><input type="date" value="${row.sellDate}"></td>
          <td><input type="number" step="0.01" value="${row.actualBuy}"></td>
          <td><input type="number" step="0.01" value="${row.actualSell}"></td>
          <td><input type="number" step="1" value="${row.filledQty}"></td>
          <td>${row.realizedPL?currency(row.realizedPL):'$0.00'}</td>`
        // inputs save-onchange
        const inputs = tr.querySelectorAll('input')
        inputs.forEach((inp,idx)=>{
          inp.addEventListener('change', ()=>{
            const keys=['plannedBuy','plannedSell',null,'plannedShares',null,'buyDate','sellDate','actualBuy','actualSell','filledQty']
            const keyMap={0:'plannedBuy',1:'plannedSell',3:'plannedShares',5:'buyDate',6:'sellDate',7:'actualBuy',8:'actualSell',9:'filledQty'}
            const k=keyMap[idx]
            if(k){ r.rows[ri][k]= inp.type==='number'? parseFloat(inp.value||'0'):inp.value }
            // auto compute realized if actuals filled
            const q = parseFloat(r.rows[ri].filledQty||0)
            const ab = parseFloat(r.rows[ri].actualBuy||0)
            const as = parseFloat(r.rows[ri].actualSell||0)
            if(q>0 && ab>0 && as>0){
              r.rows[ri].realizedPL = +( (as-ab)*q ).toFixed(2)
              tr.querySelectorAll('td')[11].textContent = currency(r.rows[ri].realizedPL)
            }
            save()
          })
        })
        tb.appendChild(tr)
      })
      card.appendChild(tbl)
    })

    host.appendChild(card)

    // Hook buttons
    card.querySelectorAll('[data-build]').forEach(btn=>btn.onclick=()=>{
      // Rebuild with same parameters
      const a2 = state.assets[ai]
      const start=a2.start, rungs=a2.rungs, defShares=a2.defShares
      const rebuilt=[]
      for(let r=0;r<rungs;r++){
        const sellPct = SELL_STEPS[r]
        const buyPct  = BUYBACKS[r]
        let sell = start*(1+pct(sellPct))
        let buy  = sell*(1-pct(buyPct))
        const rows=[]
        for(let i=1;i<=20;i++){
          rows.push({
            cycle:i,
            plannedBuy:+buy.toFixed(2),
            plannedSell:+sell.toFixed(2),
            profitPerShare:+(sell-buy).toFixed(2),
            plannedShares:defShares,
            buyDate:'',sellDate:'',actualBuy:'',actualSell:'',filledQty:'',realizedPL:''
          })
          sell = sell*(1+pct(sellPct))
          buy  = sell*(1-pct(buyPct))
        }
        rebuilt.push({rung:r+1,sellPct,buyPct,rows})
      }
      state.assets[ai].ladders=rebuilt; save(); renderAssets();
    })
    card.querySelectorAll('[data-csv]').forEach(btn=>btn.onclick=()=>{
      const a2=state.assets[ai]
      let csv='rung,cycle,plannedBuy,plannedSell,profitPerShare,plannedShares,buyDate,sellDate,actualBuy,actualSell,filledQty,realizedPL\n'
      a2.ladders.forEach(L=>L.rows.forEach(r=>{
        csv+=`${L.rung},${r.cycle},${r.plannedBuy},${r.plannedSell},${r.profitPerShare},${r.plannedShares},${r.buyDate},${r.sellDate},${r.actualBuy},${r.actualSell},${r.filledQty},${r.realizedPL}\n`
      }))
      const blob=new Blob([csv],{type:'text/csv'}); const ael=document.createElement('a'); ael.href=URL.createObjectURL(blob); ael.download=`${a2.ticker}_ladder.csv`; ael.click()
    })
    card.querySelectorAll('[data-del]').forEach(btn=>btn.onclick=()=>{
      if(confirm('Delete this ladder?')){ state.assets.splice(ai,1); save(); renderAssets() }
    })
  })
}

// simple chart using inline canvas (no CDN)
function renderChart(){
  const canvas=document.getElementById('plChart')
  const ctx=canvas.getContext('2d')
  ctx.clearRect(0,0,canvas.width,canvas.height)
  // Build buckets by date (sellDate) for realized PL
  const points=[]
  state.assets.forEach(a=>a.ladders.forEach(L=>L.rows.forEach(r=>{
    if(r.sellDate && r.realizedPL){
      points.push({d:r.sellDate, v:r.realizedPL})
    }
  })))
  // If no real data, add small demo sequence
  if(points.length===0){
    const today=new Date(); for(let i=0;i<4;i++){ const d=new Date(today.getFullYear(),0,2+i*14); points.push({d:d.toISOString().slice(0,10),v:(i%2?40:-15)}) }
  }
  points.sort((a,b)=>a.d<b.d?-1:1)
  // Draw simple bar chart
  const W=canvas.width=canvas.clientWidth; const H=canvas.height=300
  const pad=30; const n=points.length
  const max=Math.max(10, ...points.map(p=>p.v)); const min=Math.min(-10, ...points.map(p=>p.v))
  const yScale=(val)=>{const range=max-min; return H-pad - ((val-min)/range)*(H-2*pad)}
  const barW=(W-2*pad)/Math.max(1,n)
  ctx.strokeStyle='#ccc'; ctx.fillStyle='#eef'; ctx.lineWidth=1
  // axis
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke()
  // bars
  points.forEach((p,i)=>{
    const x=pad + i*barW + 4
    const y=yScale(p.v)
    const base=yScale(0)
    ctx.fillStyle= p.v>=0? '#99d' : '#f8a'
    ctx.fillRect(x, Math.min(y,base), barW-8, Math.abs(base-y))
  })
}

function hydrateInputsFromLast(){
  const a = state.assets[state.assets.length-1]
  if(!a) return
  document.getElementById('ticker').value = a.ticker
  document.getElementById('rungs').value  = a.rungs
  document.getElementById('startPrice').value = a.start
  document.getElementById('defShares').value = a.defShares
}

renderAssets(); hydrateInputsFromLast(); renderChart();
</script>
</body>
</html>
