<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App (Single File)</title>
<style>
  :root{
    --pad:12px;
    --radius:12px;
    --brand:#0aa36c;
  }
  html,body{margin:0;padding:0;background:#f6f7fb;color:#0e1116;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
  header{
    background:linear-gradient(90deg,#0aa36c,#2aa2e2);
    color:#fff;padding:16px 16px 10px; position:sticky; top:0; z-index:5;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
  }
  header h1{font-size:20px;margin:0;display:flex;gap:10px;align-items:center}
  .ready{background:#0fb176;color:#fff;padding:4px 10px;border-radius:999px;font-weight:600;font-size:12px}
  main{padding:12px;max-width:980px;margin:0 auto}
  .card{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(20,20,40,.06);padding:12px;margin-bottom:14px}
  .controls{display:grid;grid-template-columns:1fr 110px 120px 110px;gap:8px;align-items:end}
  label{font-size:12px;font-weight:600;color:#364;display:block;margin-bottom:6px}
  input,select,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #ced4da;background:#fff;width:100%}
  button.primary{background:var(--brand);color:#fff;border:none;font-weight:700}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{background:#eef5f1;border:1px solid #d9e7e0;color:#274;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
  .asset{border:1px solid #e7e9ef}
  .asset header{position:relative;background:transparent;color:inherit;box-shadow:none;padding:0;margin:0 0 8px}
  .assetTitle{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .btn{padding:8px 12px;border-radius:999px;border:1px solid #dde3ea;background:#fff;font-weight:700}
  .btn.danger{background:#ff5e5e;color:#fff;border-color:#ff5e5e}
  .btn.secondary{background:#eef5f1;border-color:#d9e7e0;color:#274}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:13px;text-align:left;color:#334;position:sticky;top:58px;background:#f6f7fb;padding:6px 8px;z-index:4}
  tbody tr{background:#fff;box-shadow:0 1px 4px rgba(20,20,40,.05)}
  td,th{padding:10px 8px}
  td input{width:100%;padding:10px 12px;border:1px solid #dbe1ea;border-radius:10px;font-variant-numeric:tabular-nums}
  td input[type="number"]{appearance:textfield}
  .gridActions{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .small{font-size:12px;color:#566}
  .hidden{display:none}
  .wide{min-width:120px}
  @media (max-width:560px){
    .controls{grid-template-columns:1fr 96px 96px 96px}
    td input{font-size:15px}
  }
</style>
</head>
<body>
<header>
  <h1>ðŸ“ˆ Ladder App <span class="ready" id="status">ready</span></h1>
</header>
<main>
  <section class="card">
    <div class="controls">
      <div>
        <label>Ticker / Name</label>
        <input id="ticker" placeholder="e.g., RIOT or MU">
      </div>
      <div>
        <label>Rungs</label>
        <select id="rungs">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div>
        <label>Start Price</label>
        <input id="start" type="number" step="0.01" inputmode="decimal" placeholder="current price">
      </div>
      <div>
        <label>Default Shares / row</label>
        <input id="shares" type="number" step="1" value="1">
      </div>
    </div>
    <div class="gridActions">
      <button id="addAsset" class="primary">+ Add / Replace Asset</button>
      <button id="saveJson" class="btn secondary">Save Backup (JSON)</button>
      <button id="loadJson" class="btn secondary">Restore Backup (JSON)</button>
      <button id="csv" class="btn secondary">Export CSV (Excel)</button>
      <button id="clearAll" class="btn danger">Clear All (this device)</button>
    </div>
    <div class="small">Baseline presets (locked): Sell <b>+2.5%</b>, <b>+4.5%</b>, <b>+7.0%</b>, <b>+10%</b> per rung (first 1â€“4 based on selection).
      Buyback <b>1%</b>, <b>2.5%</b>, <b>3.5%</b>, <b>5%</b> (rungs 1â€“4). 20 cycles. Row 1 Planned Buy equals <b>Start Price</b>.
      Each next row uses: <code>nextBuy = prevSell Ã— (1 âˆ’ buyback%)</code> and <code>sell = buy Ã— (1 + sell%)</code>. Edit any cell inline.
    </div>
  </section>

  <div id="assets"></div>
</main>

<script>
/* ---------- Math helpers ---------- */
const ROUND = (n, d=2)=> Number.parseFloat(n).toFixed(d);
const pct = p => (p/100);
const SELL_PRESETS = [2.5, 4.5, 7, 10];
const BUYBACK_PRESETS = [1, 2.5, 3.5, 5];
const ROWS = 20;

function buildRows(start, rungIdx, defShares){
  const sellPct = pct(SELL_PRESETS[rungIdx]);
  const buybackPct = pct(BUYBACK_PRESETS[rungIdx]);
  const out = [];
  // Row 1
  let buy = Number(start);
  let sell = buy * (1 + sellPct);
  for(let i=1;i<=ROWS;i++){
    if(i>1){
      buy  = sell * (1 - buybackPct);
      sell = buy * (1 + sellPct);
    }
    const profit = (sell - buy);
    out.push({
      idx:i,
      buy: +ROUND(buy,2),
      sell:+ROUND(sell,2),
      shares:defShares,
      planTotal:+ROUND(profit*defShares,2),
      buyDate:"",
      sellDate:"",
      actualBuy:"",
      actualSell:"",
      filledQty:"",
      realizedPL:"",
      deltaVsPlan:"",
      cumRealized:""
    });
  }
  return out;
}

function assetTemplate(asset, open=true){
  const {ticker, rungs, start, defShares, ladders} = asset;
  const chips = `
    <span class="pill">${ticker}</span>
    <span class="pill">${rungs} rung(s)</span>
    <span class="pill">start $${ROUND(start,2)}</span>
  `;
  return `
  <section class="card asset" data-ticker="${ticker}">
    <div class="assetTitle">
      <div class="bar">${chips}</div>
      <div class="bar">
        <button class="btn secondary toggle">Toggle</button>
        <button class="btn danger delete">Delete</button>
      </div>
    </div>
    <div class="small" style="margin:6px 0 10px">Sell +${SELL_PRESETS.slice(0,rungs).join('%, +')}% Â· Buyback ${BUYBACK_PRESETS.slice(0,rungs).join('%, ')}%</div>
    ${Array.from({length:rungs}).map((_,ri)=>`
      <div class="card" data-rung="${ri+1}">
        <div class="bar" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <div><b>${ticker} â€” Rung ${ri+1}</b> Â· Sell +${SELL_PRESETS[ri]}% Â· Buyback ${BUYBACK_PRESETS[ri]}%</div>
        </div>
        <div class="${open?'':'hidden'} rungBody">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Planned Buy</th>
                <th>Planned Sell</th>
                <th>Profit/Share</th>
                <th>Planned Shares</th>
                <th>Planned Total</th>
                <th>Buy Date</th>
                <th>Sell Date</th>
                <th>Actual Buy</th>
                <th>Actual Sell</th>
                <th>Filled Qty</th>
                <th>Realized P/L</th>
                <th>Î” vs Plan</th>
                <th>Cum Realized</th>
              </tr>
            </thead>
            <tbody>
              ${ladders[ri].map(row=>`
                <tr data-row="${row.idx}">
                  <td>${row.idx}</td>
                  <td><input class="buy wide" value="${row.buy}"></td>
                  <td><input class="sell wide" value="${row.sell}"></td>
                  <td>$${ROUND(row.sell-row.buy,2)}</td>
                  <td><input class="shares" type="number" value="${row.shares}"></td>
                  <td>$${ROUND((row.sell-row.buy)*row.shares,2)}</td>
                  <td><input class="buydate" type="date"></td>
                  <td><input class="selldate" type="date"></td>
                  <td><input class="actualBuy wide" type="number" step="0.01"></td>
                  <td><input class="actualSell wide" type="number" step="0.01"></td>
                  <td><input class="filledQty" type="number" step="1"></td>
                  <td><input class="realizedPL wide" type="number" step="0.01"></td>
                  <td><input class="dvp wide" type="number" step="0.01"></td>
                  <td><input class="cum wide" type="number" step="0.01"></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `).join('')}
  </section>`;
}

/* ---------- State & persistence ---------- */
const el = s => document.querySelector(s);
const assetsDiv = el('#assets');
const LS_KEY = 'ladder_single_v2';

let state = load() || { assets: [] };
render();

function load(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch(e){ return null; }
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  el('#status').textContent='saved';
  setTimeout(()=>el('#status').textContent='ready',800);
}

/* ---------- Build / add asset ---------- */
el('#addAsset').addEventListener('click', ()=>{
  const ticker = (el('#ticker').value||'ASSET').trim().toUpperCase();
  const rungs = Math.max(1, Math.min(4, parseInt(el('#rungs').value||'1',10)));
  const start = Number(el('#start').value||0);
  const defShares = Math.max(1, parseInt(el('#shares').value||'1',10));

  if(!start || start<=0){ alert('Enter a valid Start Price'); return; }

  const ladders = Array.from({length:rungs}, (_,ri)=> buildRows(start, ri, defShares));
  // Replace if exists
  state.assets = state.assets.filter(a => a.ticker!==ticker);
  state.assets.push({ticker, rungs, start, defShares, ladders});
  save();
  render();
});

/* ---------- Export CSV ---------- */
el('#csv').addEventListener('click', ()=>{
  const rows = [];
  rows.push(['Ticker','Rung','#','Planned Buy','Planned Sell','Profit/Share','Planned Shares','Planned Total','Buy Date','Sell Date','Actual Buy','Actual Sell','Filled Qty','Realized P/L','Delta vs Plan','Cum Realized']);
  for(const a of state.assets){
    for(let r=0;r<a.rungs;r++){
      for(const row of a.ladders[r]){
        rows.push([a.ticker, r+1, row.idx, row.buy, row.sell, ROUND(row.sell-row.buy,2), row.shares, ROUND((row.sell-row.buy)*row.shares,2), row.buyDate,row.sellDate,row.actualBuy,row.actualSell,row.filledQty,row.realizedPL,row.deltaVsPlan,row.cumRealized]);
      }
    }
  }
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ladder_export.csv'; a.click();
  URL.revokeObjectURL(url);
});

/* ---------- Save / Load JSON ---------- */
el('#saveJson').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='ladder_backup.json'; a.click();
  URL.revokeObjectURL(url);
});
el('#loadJson').addEventListener('click', async ()=>{
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='application/json';
  inp.onchange = async()=>{
    const text = await inp.files[0].text();
    state = JSON.parse(text);
    save(); render();
  };
  inp.click();
});
el('#clearAll').addEventListener('click', ()=>{
  if(confirm('Delete all ladders on this device?')){
    state = {assets:[]}; save(); render();
  }
});

/* ---------- Render & wire events ---------- */
function render(){
  if(!state.assets.length){
    assetsDiv.innerHTML = `<div class="small card">No assets yet. Add one above.</div>`;
    return;
  }
  assetsDiv.innerHTML = state.assets.map(a=> assetTemplate(a, true)).join('');
  // Wire buttons per asset
  document.querySelectorAll('.asset').forEach(section=>{
    const ticker = section.dataset.ticker;
    section.querySelector('.toggle').addEventListener('click', ()=>{
      section.querySelectorAll('.rungBody').forEach(div=>div.classList.toggle('hidden'));
    });
    section.querySelector('.delete').addEventListener('click', ()=>{
      if(confirm(`Delete ${ticker}?`)){
        state.assets = state.assets.filter(a=>a.ticker!==ticker);
        save(); render();
      }
    });

    // Persist edits
    section.querySelectorAll('tbody tr').forEach(tr=>{
      const rowIdx = parseInt(tr.dataset.row,10)-1;
      const rungIdx = parseInt(tr.closest('[data-rung]').dataset.rung,10)-1;
      const asset = state.assets.find(a=>a.ticker===ticker);
      const row = asset.ladders[rungIdx][rowIdx];
      tr.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const cls = inp.classList[0];
          let v = inp.value;
          if(['buy','sell','actualBuy','actualSell','realizedPL','dvp','cum'].includes(cls)) v = v===''? '' : Number(v);
          if(['shares','filledQty'].includes(cls)) v = v===''? '' : parseInt(v||'0',10);
          const map = {
            buy:'buy', sell:'sell', shares:'shares', buydate:'buyDate', selldate:'sellDate',
            actualBuy:'actualBuy', actualSell:'actualSell', filledQty:'filledQty',
            realizedPL:'realizedPL', dvp:'deltaVsPlan', cum:'cumRealized'
          };
          row[map[cls]] = v;
          save();
        });
      });
    });
  });
}

</script>
</body>
</html>
