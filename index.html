<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App (Single File)</title>
<style>
  :root{
    --bg:#f7f8fb;
    --card:#ffffff;
    --text:#1f2a37;
    --muted:#6b7280;
    --accent:#10b981;
    --danger:#ef4444;
    --border:#e5e7eb;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .bar{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,#059669,#22d3ee);color:#fff;padding:.75rem 1rem;display:flex;align-items:center;justify-content:space-between}
  .title{font-weight:800;letter-spacing:.3px}
  .status{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.35);padding:.25rem .6rem;border-radius:999px;font-size:.8rem}
  .wrap{max-width:920px;margin:12px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 3px rgba(16,24,40,.06);margin:12px 0}
  .card .head{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
  .badge{background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:.25rem .5rem;font-size:.8rem}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:.55rem .8rem;font-weight:600}
  .btn:active{transform:translateY(1px)}
  .btn.green{background:#059669;color:#fff;border-color:#059669}
  .btn.blue{background:#2563eb;color:#fff;border-color:#2563eb}
  .btn.red{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn.ghost{background:#fff}
  .grid{display:grid;grid-template-columns:1fr 120px 120px 120px 120px;gap:10px;padding:12px}
  .grid label{font-size:.85rem;color:var(--muted)}
  .grid input, .grid select{width:100%;padding:.6rem .7rem;border-radius:10px;border:1px solid var(--border);font-size:1rem}
  .asset{overflow:hidden}
  .asset.collapsed .body{display:none}
  .body{padding:10px}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:56px;background:var(--card);z-index:5}
  th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:middle}
  th{font-size:.86rem;color:var(--muted);font-weight:700}
  td input{width:100%;padding:.55rem .6rem;border:1px solid var(--border);border-radius:8px;font-variant-numeric:tabular-nums; font-size:0.98rem}
  td.num, th.num{text-align:right}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .hint{color:var(--muted);font-size:.84rem;padding:10px 14px;border-top:1px dashed var(--border)}
  .pill{background:#ecfeff;border:1px solid #a5f3fc;border-radius:999px;padding:.25rem .5rem}
  .footer{padding:14px;display:flex;gap:8px;flex-wrap:wrap}
  .sm{font-size:.85rem}
  .w100{min-width:100px}
  .w120{min-width:120px}
  .w140{min-width:140px}
  .w160{min-width:160px}
</style>
</head>
<body>
  <div class="bar">
    <div class="title">Ladder App</div>
    <div id="status" class="status">ready</div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="head"><strong>New / Replace Asset</strong></div>
      <div class="grid" style="grid-template-columns:1.3fr .7fr .7fr 1fr 160px;">
        <div><label>Ticker / Name</label><input id="inTicker" placeholder="e.g., RIOT or MU"></div>
        <div><label>Rungs</label>
          <select id="inRungs">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
          </select>
        </div>
        <div><label>Start Price</label><input id="inStart" inputmode="decimal" placeholder="current price"></div>
        <div><label>Default Shares / row</label><input id="inShares" inputmode="decimal" value="1"></div>
        <div style="display:flex;align-items:flex-end;"><button id="btnAdd" class="btn green w160">+ Add / Replace Asset</button></div>
      </div>
      <div class="hint sm">Presets (locked): Sell <span class="pill">+2.5%</span>, <span class="pill">+4.5%</span>, <span class="pill">+7.0%</span>, <span class="pill">+10%</span> (rungs 1–4). Buyback <span class="pill">1%</span>, <span class="pill">2.5%</span>, <span class="pill">3.5%</span>, <span class="pill">5%</span> (rungs 1–4). 20 cycles. Row 1 Planned Buy equals Start Price; each next row uses: <code>nextBuy = prevSell × (1 − buyback%)</code> and <code>sell = buy × (1 + sell%)</code>. Edit any cell inline.</div>
      <div class="footer">
        <button class="btn ghost" id="btnSaveJson">Save Backup (JSON)</button>
        <button class="btn ghost" id="btnRestoreJson">Restore Backup (JSON)</button>
        <button class="btn blue" id="btnExportCsv">Export CSV (Excel)</button>
        <button class="btn red" id="btnClear">Clear All (this device)</button>
      </div>
    </div>

    <div id="assets"></div>
  </div>

<script>
(() => {
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const stateKey = 'ladder_singlefile_state_v1';
  const sellPerc = [0.025, 0.045, 0.07, 0.10];
  const buybackPerc = [0.01, 0.025, 0.035, 0.05];
  const CYCLES = 20;

  const status = $('#status');
  const assetsEl = $('#assets');

  function fmt(n){ if(n===null||n===undefined||n==='') return ''; return Number(n).toFixed(2); }
  function money(n){ if(n===null||n===undefined||n==='') return ''; return '$'+Number(n).toFixed(2); }

  function save(){
    const data = [];
    $$('.asset').forEach(card=>{
      const meta = JSON.parse(card.dataset.meta);
      const rows = [];
      $$('tbody tr', card).forEach(tr=>{
        const cells = $$('input', tr).map(i=>i.value);
        rows.push({
          plannedBuy: cells[0],
          plannedSell: cells[1],
          profitShare: cells[2],
          plannedShares: cells[3],
          plannedTotal: cells[4],
          buyDate: cells[5],
          sellDate: cells[6],
          actualBuy: cells[7],
          actualSell: cells[8],
          filledQty: cells[9],
          realizedPL: cells[10],
          deltaVsPlan: cells[11],
          cumRealized: cells[12]
        });
      });
      data.push({meta, rows, collapsed: card.classList.contains('collapsed')});
    });
    localStorage.setItem(stateKey, JSON.stringify(data));
    status.textContent = 'saved';
    setTimeout(()=>status.textContent='ready',800);
  }

  function restore(){
    const raw = localStorage.getItem(stateKey);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      data.forEach(({meta, rows, collapsed})=>{
        const card = renderAsset(meta);
        if(collapsed) card.classList.add('collapsed');
        const tbody = $('tbody', card);
        tbody.innerHTML = '';
        rows.forEach((r,i)=>{
          const tr = makeRow(i+1);
          const inputs = $$('input', tr);
          inputs[0].value = r.plannedBuy || '';
          inputs[1].value = r.plannedSell || '';
          inputs[2].value = r.profitShare || '';
          inputs[3].value = r.plannedShares || '';
          inputs[4].value = r.plannedTotal || '';
          inputs[5].value = r.buyDate || '';
          inputs[6].value = r.sellDate || '';
          inputs[7].value = r.actualBuy || '';
          inputs[8].value = r.actualSell || '';
          inputs[9].value = r.filledQty || '';
          inputs[10].value = r.realizedPL || '';
          inputs[11].value = r.deltaVsPlan || '';
          inputs[12].value = r.cumRealized || '';
          tbody.appendChild(tr);
        });
        hookRecalc(card);
      });
    }catch(e){ console.error(e); }
  }

  function presetsFor(rungIndex){ // 0-based
    return { sell: sellPerc[rungIndex] || sellPerc[0], buyback: buybackPerc[rungIndex] || buybackPerc[0] };
  }

  function buildPlanRows(startPrice, rungIndex, defShares){
    const plan = [];
    let buy = Number(startPrice);
    const {sell: sPct, buyback: bPct} = presetsFor(rungIndex);
    for(let i=0;i<CYCLES;i++){
      const sell = buy * (1 + sPct);
      const profit = sell - buy;
      const shares = Number(defShares||1);
      const total = profit * shares;
      plan.push({buy:buy, sell:sell, profit:profit, shares:shares, total:total});
      const nextBuy = sell * (1 - bPct);
      buy = nextBuy;
    }
    return plan;
  }

  function makeRow(idx){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="num">${idx}</td>
      <td><input inputmode="decimal"></td>
      <td><input inputmode="decimal"></td>
      <td class="num"><input inputmode="decimal"></td>
      <td class="num"><input inputmode="decimal"></td>
      <td class="num"><input inputmode="decimal"></td>
      <td><input placeholder="MMM DD, YYYY"></td>
      <td><input placeholder="MMM DD, YYYY"></td>
      <td class="num"><input inputmode="decimal"></td>
      <td class="num"><input inputmode="decimal"></td>
      <td class="num"><input inputmode="decimal"></td>
      <td class="num"><input inputmode="decimal"></td>
      <td class="num"><input inputmode="decimal"></td>
      <td class="num"><input inputmode="decimal"></td>
    `;
    return tr;
  }

  function renderAsset(meta){
    const card = document.createElement('div');
    card.className = 'card asset';
    card.dataset.meta = JSON.stringify(meta);

    const hdr = document.createElement('div');
    hdr.className = 'head';
    hdr.innerHTML = `
      <div class="controls">
        <span class="badge">${meta.ticker}</span>
        <span class="badge">${meta.rungs} rung(s)</span>
        <span class="badge">start $${fmt(meta.startPrice)}</span>
        <span class="badge">Sell +${(presetsFor(meta.rungIndex).sell*100).toFixed(1)}%</span>
        <span class="badge">Buyback ${ (presetsFor(meta.rungIndex).buyback*100).toFixed(1)}%</span>
      </div>
      <div class="controls">
        <button class="btn ghost" data-act="toggle">Toggle</button>
        <button class="btn red" data-act="delete">Delete</button>
      </div>
    `;
    const body = document.createElement('div');
    body.className = 'body';
    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th class="num">#</th>
          <th>Planned Buy</th>
          <th>Planned Sell</th>
          <th class="num">Profit/Share</th>
          <th class="num">Planned Shares</th>
          <th class="num">Planned Total</th>
          <th>Buy Date</th>
          <th>Sell Date</th>
          <th class="num">Actual Buy</th>
          <th class="num">Actual Sell</th>
          <th class="num">Filled Qty</th>
          <th class="num">Realized P/L</th>
          <th class="num">Δ vs Plan</th>
          <th class="num">Cum Realized</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    body.appendChild(table);
    card.appendChild(hdr);
    card.appendChild(body);
    assetsEl.prepend(card); // newest on top

    // seed rows
    const plan = buildPlanRows(meta.startPrice, meta.rungIndex, meta.defaultShares);
    const tbody = $('tbody', card);
    for(let i=0;i<CYCLES;i++){
      const tr = makeRow(i+1);
      const inputs = $$('input', tr);
      // set planned values
      inputs[0].value = fmt(plan[i].buy);
      inputs[1].value = fmt(plan[i].sell);
      inputs[2].value = fmt(plan[i].profit);
      inputs[3].value = fmt(plan[i].shares);
      inputs[4].value = fmt(plan[i].total);
      // rest empty
      tbody.appendChild(tr);
    }

    hdr.addEventListener('click', (e)=>{
      const act = e.target.dataset.act;
      if(!act) return;
      if(act==='toggle'){ card.classList.toggle('collapsed'); save(); }
      if(act==='delete'){ card.remove(); save(); }
    });

    hookRecalc(card);
    return card;
  }

  function hookRecalc(card){
    card.addEventListener('input', (e)=>{
      if(e.target.tagName!=='INPUT') return;
      recalc(card);
      save();
    });
    recalc(card);
  }

  function recalc(card){
    let cum = 0;
    const rows = $$('tbody tr', card);
    rows.forEach(tr=>{
      const inp = $$('input', tr);
      const plannedTotal = Number(inp[4].value||0);
      const aBuy = Number(inp[7].value||0);
      const aSell = Number(inp[8].value||0);
      const qty = Number(inp[9].value||0);
      const realized = (aSell - aBuy) * qty;
      inp[10].value = fmt(realized);
      const delta = realized - plannedTotal;
      inp[11].value = fmt(delta);
      cum += realized;
      inp[12].value = fmt(cum);
    });
  }

  // UI hooks
  $('#btnAdd').addEventListener('click', ()=>{
    const ticker = $('#inTicker').value.trim();
    const rungs = Number($('#inRungs').value);
    const start = Number($('#inStart').value);
    const shares = Number($('#inShares').value||1);
    if(!ticker || !start){ alert('Enter Ticker and Start Price'); return; }
    // We create one asset per rung (1..rungs) so you can toggle each
    for(let r=1;r<=rungs;r++){
      const meta = { ticker, rungs:r, startPrice:start, defaultShares:shares, rungIndex:r-1 };
      renderAsset(meta);
    }
    save();
    // reset inputs
    $('#inTicker').value='';
    $('#inStart').value='';
  });

  $('#btnExportCsv').addEventListener('click', ()=>{
    const rows = [];
    $$('.asset').forEach(card=>{
      const meta = JSON.parse(card.dataset.meta);
      rows.push(['Asset', meta.ticker, `Rung ${meta.rungs}`, `Start ${fmt(meta.startPrice)}`].join(','));
      rows.push(['#','Planned Buy','Planned Sell','Profit/Share','Planned Shares','Planned Total','Buy Date','Sell Date','Actual Buy','Actual Sell','Filled Qty','Realized P/L','Delta vs Plan','Cum Realized'].join(','));
      $$('tbody tr', card).forEach((tr,i)=>{
        const v = $$('input', tr).map(x=>x.value);
        rows.push([i+1, ...v].join(','));
      });
      rows.push('');
    });
    const blob = new Blob([rows.join('\n')], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ladder_export.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $('#btnSaveJson').addEventListener('click', ()=>{
    const raw = localStorage.getItem(stateKey) || '[]';
    const blob = new Blob([raw], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ladder_backup.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $('#btnRestoreJson').addEventListener('click', ()=>{
    const inp = document.createElement('input');
    inp.type='file'; inp.accept='application/json';
    inp.onchange=()=>{
      const file = inp.files[0]; if(!file) return;
      const rd = new FileReader();
      rd.onload = ()=>{
        localStorage.setItem(stateKey, rd.result);
        assetsEl.innerHTML='';
        restore();
      };
      rd.readAsText(file);
    };
    inp.click();
  });

  $('#btnClear').addEventListener('click', ()=>{
    if(confirm('Clear everything saved on this device?')){
      localStorage.removeItem(stateKey);
      assetsEl.innerHTML='';
      status.textContent='cleared';
      setTimeout(()=>status.textContent='ready',1200);
    }
  });

  // initial
  restore();
})();
</script>
</body>
</html>
