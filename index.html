<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App</title>
<style>
  :root{--green:#0aa36c;--red:#c0392b;--bg:#f6f7fb;--card:#fff;--text:#1a1a1a}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#0fb37a,#0aa36c);color:#fff;padding:14px 16px;display:flex;gap:12px;align-items:center}
  header h1{font-size:20px;margin:0;flex:1}
  .pill{background:#0d8e60;padding:6px 10px;border-radius:999px;font-size:13px}
  .wrap{max-width:940px;margin:14px auto;padding:0 12px}
  .tabs{display:flex;gap:10px;margin-bottom:12px}
  .tab{flex:0 0 auto;padding:10px 14px;border-radius:10px;background:#e8f6f0;color:#0e6b4d;font-weight:600}
  .tab.active{background:#fff}
  .card{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:13px;color:#444}
  input,select,button,textarea{font:16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif}
  input,select{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #d7dce5;border-radius:10px;background:#fff}
  button.primary{background:var(--green);border:0;color:#fff;padding:12px 14px;border-radius:12px;font-weight:700}
  button.ghost{background:#eef3f7;border:0;color:#0b5e43;padding:12px 14px;border-radius:12px;font-weight:700}
  button.danger{background:var(--red);color:#fff;border:0;padding:10px 12px;border-radius:10px}
  .row-btns{display:flex;gap:10px;flex-wrap:wrap}
  details.asset{border-radius:12px;overflow:hidden;background:#fff}
  details summary{list-style:none;cursor:pointer;padding:14px 16px;font-weight:800;background:#fff;border-bottom:1px solid #f0f0f0;display:flex;gap:10px;align-items:center}
  details summary::-webkit-details-marker{display:none}
  .chip{background:#eef3f7;border:1px solid #e3eaf1;color:#2d5c50;padding:4px 8px;border-radius:999px;font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;text-align:left;padding:8px 10px;color:#5a5a5a}
  td{background:#fff;padding:6px 6px}
  td input{width:100%;padding:10px;border:1px solid #d7dce5;border-radius:10px}
  .right{ text-align:right}
  .foot{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
  .note{font-size:12px;color:#667}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#000;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:.92;display:none}
</style>
</head>
<body>
<header>
  <h1>ðŸ“ˆ Ladder App</h1>
  <span class="pill" id="status">ready</span>
</header>

<div class="wrap">
  <div class="tabs">
    <div class="tab active" id="tab-ladders">Ladders</div>
    <div class="tab" id="tab-charts">Charts</div>
  </div>

  <div id="page-ladders">
    <div class="card">
      <div class="grid">
        <div><label>Ticker / Name</label><input id="in-ticker" placeholder="e.g., RIOT or MU"></div>
        <div><label>Rungs</label>
          <select id="in-rungs">
            <option>2 rungs</option>
            <option selected>3 rungs</option>
            <option>4 rungs</option>
          </select>
        </div>
        <div><label>Start Price</label><input id="in-start" type="number" step="0.01" placeholder="current price"></div>
        <div><label>Default Shares / row</label><input id="in-shares" type="number" step="1" value="1"></div>
      </div>
      <p class="note" style="margin-top:8px">
        Presets (locked): Sell <b>+2.5%</b>, <b>+4.5%</b>, <b>+7%</b>, <b>+10%</b> (first 2â€“4 based on rungs).
        Buyback <b>1%</b>, <b>2.5%</b>, <b>3.5%</b>, <b>5%</b> (rungs 1â€“4). 20 cycles.
        Row 1 Planned Buy equals Start Price; each next row uses: <code>nextBuy = prevSell Ã— (1 âˆ’ buyback%)</code> and <code>sell = buy Ã— (1 + sell%)</code>.
      </p>
      <div class="row-btns">
        <button class="primary" id="btn-add">+ Add / Replace Asset</button>
        <button class="ghost" id="btn-save">Save Backup (JSON)</button>
        <button class="ghost" id="btn-restore">Restore Backup (JSON)</button>
        <button class="ghost" id="btn-export">Export CSV (Excel)</button>
        <button class="danger" id="btn-clear">Clear All (this device)</button>
      </div>
    </div>

    <div id="assets"></div>
  </div>

  <div id="page-charts" style="display:none">
    <div class="card">
      <b>Charts</b>
      <p class="note">Charts placeholder. (Weâ€™ll wire up once data model is fully settled.)</p>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const showToast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1600); };

  const S = {
    rungPresets(rungs){
      // Return arrays for this rung index (0..3)
      // Sell: [2.5, 4.5, 7, 10], Buyback: [1, 2.5, 3.5, 5]
      const sell=[2.5,4.5,7,10], buyb=[1,2.5,3.5,5];
      return {sell:sell[rungs], buyback:buyb[rungs]};
    },
    buildRows(start, sellPct, buybackPct, cycles, defShares){
      const rows=[];
      let buy = +start;
      for(let i=1;i<=cycles;i++){
        const sell = +(buy * (1 + sellPct/100)).toFixed(2);
        rows.push({
          i,
          buy:+(+buy).toFixed(2),
          sell:+sell.toFixed(2),
          profit:+(sell - buy).toFixed(2),
          shares:defShares,
          total:+((sell - buy) * defShares).toFixed(2),
          buyDate:"", sellDate:"",
          actualBuy:"", actualSell:"", qty:"", realized:0, cum:0
        });
        const nextBuy = +(sell * (1 - buybackPct/100)).toFixed(2);
        buy = nextBuy;
      }
      return rows;
    },
    renderAsset(a){
      const wrap = document.createElement('details');
      wrap.className = 'asset card';
      wrap.open = a.open ?? true;
      const header = document.createElement('summary');
      header.innerHTML = `<span style="font-weight:800">${a.ticker}</span>
        <span class="chip">${a.rungs} rung(s)</span>
        <span class="chip">start $${(+a.start).toFixed(2)}</span>`;
      wrap.appendChild(header);

      const inner = document.createElement('div');
      inner.style.padding="10px 12px 14px";
      inner.innerHTML = `<div class="row-btns" style="justify-content:flex-end;margin-bottom:8px">
        <button class="ghost btn-build">Build Ladder</button>
        <button class="danger btn-delete">Delete Ladder</button>
      </div>`;

      // Table
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>
        <th>#</th>
        <th>Planned Buy</th>
        <th>Planned Sell</th>
        <th>Profit/Share</th>
        <th>Planned Shares</th>
        <th>Planned Total</th>
        <th>Buy Date</th>
        <th>Sell Date</th>
        <th>Actual Buy</th>
        <th>Actual Sell</th>
        <th>Filled Qty</th>
        <th>Realized P/L</th>
        <th>Cum Realized</th>
      </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      a.rows.forEach((r,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="right">${r.i}</td>
          <td><input type="number" step="0.01" value="${r.buy}"></td>
          <td><input type="number" step="0.01" value="${r.sell}"></td>
          <td class="right">$${r.profit.toFixed(2)}</td>
          <td><input type="number" step="1" value="${r.shares}"></td>
          <td class="right">$${r.total.toFixed(2)}</td>
          <td><input type="date" value="${r.buyDate}"></td>
          <td><input type="date" value="${r.sellDate}"></td>
          <td><input type="number" step="0.01" value="${r.actualBuy}"></td>
          <td><input type="number" step="0.01" value="${r.actualSell}"></td>
          <td><input type="number" step="1" value="${r.qty}"></td>
          <td class="right">$${(+r.realized).toFixed(2)}</td>
          <td class="right">$${(+r.cum).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      inner.appendChild(table);
      wrap.appendChild(inner);

      // wiring
      inner.querySelector('.btn-delete').onclick = ()=>{
        state.assets = state.assets.filter(x=>x.id!==a.id);
        persist(); draw();
      };
      inner.querySelector('.btn-build').onclick = ()=>{
        rebuild(a.id); showToast('Ladder rebuilt');
      };

      // edits
      tbody.querySelectorAll('tr').forEach((tr,idx)=>{
        const cells = tr.querySelectorAll('td input');
        const [buyI,sellI,,sharesI,,,,actBuyI,actSellI,qtyI] = cells;
        const rec = a.rows[idx];

        const recalc = ()=>{
          rec.buy=+(+buyI.value||0).toFixed(2);
          rec.sell=+(+sellI.value||0).toFixed(2);
          rec.profit=+ (rec.sell - rec.buy).toFixed(2);
          rec.shares=+(+sharesI.value||0);
          rec.total=+ (rec.profit * rec.shares).toFixed(2);
          rec.realized= +(((+actSellI.value||0) - (+actBuyI.value||0)) * (+qtyI.value||0)).toFixed(2);
          // cum
          let cum=0; for(let i=0;i<=idx;i++){cum += (+a.rows[i].realized||0);} rec.cum=+cum.toFixed(2);
          persist();
          draw(); // re-render to update totals + cum chain
        };
        cells.forEach((inp,ci)=> inp.addEventListener('change', ()=>{
          const val = inp.type==='date' ? inp.value : (+inp.value||0);
          ['buyDate','sellDate'][ci-6] && (rec[['buyDate','sellDate'][ci-6]]=inp.value);
          recalc();
        }));
      });

      return wrap;
    }
  };

  const state = {
    assets: JSON.parse(localStorage.getItem('ladder_assets_v3')||'[]')
  };

  function persist(){ localStorage.setItem('ladder_assets_v3', JSON.stringify(state.assets)); }

  function rebuild(id){
    const a = state.assets.find(x=>x.id===id);
    if(!a) return;
    const presets = [2.5,4.5,7,10];
    const buyb=[1,2.5,3.5,5];
    const idx = Math.min(a.rungs-1,3);
    a.rows = S.buildRows(a.start, presets[idx], buyb[idx], 20, a.defShares);
    persist(); draw();
  }

  function draw(){
    // tabs
    $('#tab-ladders').classList.toggle('active', true);
    $('#tab-charts').classList.toggle('active', false);
    $('#page-ladders').style.display='block';
    $('#page-charts').style.display='none';

    const box = $("#assets");
    box.innerHTML='';
    state.assets.forEach(a=> box.appendChild(S.renderAsset(a)));
  }

  // add/replace
  $("#btn-add").onclick = ()=>{
    const ticker = ($("#in-ticker").value||"").trim();
    const start = +$("#in-start").value;
    const defShares = +( $("#in-shares").value || 1 );
    const rungs = +($("#in-rungs").value||"3 rungs").split(" ")[0];

    if(!ticker){ showToast("Enter a ticker"); return; }
    if(!(start>0)){ showToast("Enter a valid start price"); return; }

    const existing = state.assets.find(a=>a.ticker.toLowerCase()===ticker.toLowerCase());
    const id = existing ? existing.id : (crypto?.randomUUID?.() || String(Date.now()+Math.random()));
    const idx = Math.min(rungs-1,3);
    const presets = [2.5,4.5,7,10];
    const buyb=[1,2.5,3.5,5];
    const rows = S.buildRows(start, presets[idx], buyb[idx], 20, defShares);

    const model = { id, ticker, rungs, start:+(+start).toFixed(2), defShares, rows, open:true };
    if(existing){
      const i = state.assets.findIndex(a=>a.id===id);
      state.assets[i] = model;
    }else{
      state.assets.unshift(model);
    }
    persist(); draw(); showToast(existing?"Asset replaced":"Asset added");
  };

  // buttons
  $("#btn-clear").onclick = ()=>{ if(confirm("Delete all ladders on this device?")){ state.assets=[]; persist(); draw(); } };
  $("#btn-save").onclick = ()=>{
    const blob = new Blob([JSON.stringify(state.assets,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='ladder_backup.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),500);
  };
  $("#btn-restore").onclick = ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = ()=>{
      const f = inp.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = ()=>{ try{ state.assets = JSON.parse(fr.result); persist(); draw(); showToast("Backup restored"); }catch(e){ alert("Bad JSON"); } };
      fr.readAsText(f);
    }; inp.click();
  };
  $("#btn-export").onclick = ()=>{
    const rows = [];
    state.assets.forEach(a=>{
      a.rows.forEach(r=>{
        rows.push([a.ticker,a.rungs,a.start,r.i,r.buy,r.sell,r.profit,r.shares,r.total,r.buyDate,r.sellDate,r.actualBuy,r.actualSell,r.qty,r.realized,r.cum]);
      });
    });
    const header = ["Ticker","Rungs","Start","Cycle","# Planned Buy","# Planned Sell","Profit/Share","Planned Shares","Planned Total","Buy Date","Sell Date","Actual Buy","Actual Sell","Filled Qty","Realized P/L","Cum Realized"];
    const csv = [header].concat(rows).map(r=>r.map(v=>String(v).replace(/"/g,'""')).map(v=>`"${v}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='ladders.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
  };

  // tabs click
  $("#tab-ladders").onclick = ()=>{ $("#tab-ladders").classList.add('active'); $("#tab-charts").classList.remove('active'); $("#page-ladders").style.display='block'; $("#page-charts").style.display='none'; };
  $("#tab-charts").onclick = ()=>{ $("#tab-charts").classList.add('active'); $("#tab-ladders").classList.remove('active'); $("#page-charts").style.display='block'; $("#page-ladders").style.display='none'; };

  draw();
})();
</script>
</body>
</html>
