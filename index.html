<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App â€” v2.3</title>
<meta name="theme-color" content="#0a7">
<style>
:root{
  --bg:#f7f7f7;--panel:#fff;--ink:#111;--accent:#0a7;--muted:#666;--danger:#c33;--ok:#0a7;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif}
header{background:var(--accent);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:5}
.logo{font-weight:700;font-size:18px;display:flex;align-items:center;gap:8px}
.logo .emoji{font-size:22px}
.tabs{margin-left:auto;display:flex;gap:10px}
.tab{background:#fff1;border:1px solid #fff4;color:#fff;padding:8px 12px;border-radius:10px}
.tab.active{background:#fff;color:var(--accent);font-weight:600}
.wrap{max-width:1100px;margin:16px auto;padding:0 12px}
.card{background:var(--panel);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
h2{margin:0 0 12px 0}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end}
.row>.span2{grid-column:span 2}
.row>.span3{grid-column:span 3}
.row>.span4{grid-column:span 4}
input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:16px}
input[type="number"]{appearance:textfield}
button{cursor:pointer}
button.primary{background:var(--accent);color:#fff;border:0}
button.warn{background:var(--danger);color:#fff;border:0}
button.secondary{background:#eee;border:1px solid #ddd}
.badge{display:inline-block;background:#eee;border:1px solid #ddd;border-radius:999px;padding:4px 10px;margin-right:6px;color:#333;font-size:12px}
.help{background:#fffbdd;border:1px solid #ffe58f;border-radius:12px;padding:10px 12px;color:#7a5;}

.table{overflow:auto;border:1px solid #eee;border-radius:12px}
table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
th,td{padding:10px 8px;border-bottom:1px solid #f0f0f0;text-align:left;background:#fff}
th{position:sticky;top:56px;background:#fafafa;font-size:13px;color:#444;border-bottom:1px solid #e5e5e5;z-index:1}
td input{width:100%}
td .money{min-width:92px}
td .qty{min-width:70px}
td .date{min-width:125px}
tfoot td{background:#fcfcfc;font-weight:700}

.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi>div{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px}
.kpi b{font-size:18px}

.note{font-size:12px;color:#777}

@media (max-width:640px){
  .row{grid-template-columns:repeat(6,1fr)}
  table{min-width:1040px}
  th{top:100px}
}
</style>
</head>
<body>
<header>
  <div class="logo"><span class="emoji">ðŸªœ</span><span>Ladder App</span></div>
  <nav class="tabs">
    <button class="tab active" data-tab="ladders">Ladders</button>
    <button class="tab" data-tab="charts">Charts</button>
  </nav>
</header>

<div class="wrap">
  <div id="ladders" class="tabpage">
    <div class="card">
      <h2>Add / Replace Asset</h2>
      <div class="row">
        <div class="span3">
          <label>Ticker / Name</label>
          <input id="inTicker" placeholder="e.g., RIOT or BTC">
        </div>
        <div class="span2">
          <label>Rungs</label>
          <select id="inRungs">
            <option value="2">2 rungs</option>
            <option value="3" selected>3 rungs</option>
            <option value="4">4 rungs</option>
          </select>
        </div>
        <div class="span3">
          <label>Start Price</label>
          <input id="inStart" type="number" step="0.01" placeholder="current price">
        </div>
        <div class="span2">
          <label>Default Shares / row</label>
          <input id="inShares" type="number" step="1" value="1">
        </div>
        <div class="span2">
          <label>&nbsp;</label>
          <button class="primary" id="btnAdd">+ Add / Replace Asset</button>
        </div>
      </div>
      <p class="help" style="margin-top:12px">
        Presets (locked): <b>Sell +2.5%, +4.5%, +7%, +10%</b> (first 2â€“4 based on rungs).
        <b>Buyback 1%, 2.5%, 3.5%, 5%</b> (rungs 1â€“4). Row 1 Planned Buy equals Start Price.
        Each next row uses: <code>nextBuy = prevSell Ã— (1 âˆ’ buyback%)</code> and
        <code>sell = buy Ã— (1 + sell%)</code>. 20 cycles. Edit any cell inline.
      </p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnBackup" class="secondary">Save Backup (JSON)</button>
        <input id="restoreInput" type="file" accept="application/json" style="display:none">
        <button id="btnRestore" class="secondary">Restore Backup (JSON)</button>
        <button id="btnClear" class="warn">Clear All (this device)</button>
        <span class="badge" id="autosave">auto-save enabled</span>
      </div>
    </div>

    <div id="assets"></div>
  </div>

  <div id="charts" class="tabpage" style="display:none">
    <div class="card">
      <h2>Portfolio Totals</h2>
      <div class="kpi" id="kpi">
        <div><div class="note">Realized P/L (all)</div><b id="kTotal">$0.00</b></div>
        <div><div class="note"># of Assets</div><b id="kAssets">0</b></div>
        <div><div class="note">Open Rows</div><b id="kOpen">0</b></div>
        <div><div class="note">Closed Rows</div><b id="kClosed">0</b></div>
      </div>
    </div>
    <div class="card">
      <h3>Export</h3>
      <button id="btnExportCSV" class="secondary">Export CSV (Excel)</button>
    </div>
    <p class="note">Charts page summarizes realized P/L from the ladder tables below (based on Actual Buy/Sell/Qty and Sell Date). For now it provides totals and CSV export.</p>
  </div>
</div>

<script>
// ----- Config (locked presets) -----
const SELL_PCTS = [0.025, 0.045, 0.07, 0.10];     // rung 1..4
const BUYBACK_PCTS = [0.01, 0.025, 0.035, 0.05];  // rung 1..4
const CYCLES = 20;
const LS_KEY = "ladderApp_v23";

// ----- State -----
let state = loadState() || { assets: [] };

// ----- Helpers -----
const $ = sel => document.querySelector(sel);
function money(n){ if(n===null||isNaN(n)) return ""; return "$"+Number(n).toFixed(2); }
function f2(n){ if(n===null||isNaN(n)) return ""; return Number(n).toFixed(2); }
function toNum(v){ const n = parseFloat(v); return isNaN(n)?null:n; }

function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw? JSON.parse(raw): null;
  }catch(e){ return null; }
}

function buildLadderRows(start, sellPct, buybackPct, sharesDefault){
  const rows = [];
  let buy = start;
  for(let i=1;i<=CYCLES;i++){
    const sell = +(buy * (1+sellPct)).toFixed(2);
    rows.push({
      cycle:i,
      plannedBuy:+buy.toFixed(2),
      plannedSell:sell,
      profitPerShare:+(sell-buy).toFixed(2),
      plannedShares: sharesDefault || 1,
      buyDate:"",
      sellDate:"",
      actualBuy:null, actualSell:null, qty:null,
      realizedPL:null, deltaVsPlan:null, cumRealized:null
    });
    // next buy
    buy = sell * (1 - buybackPct);
  }
  return rows;
}

function ensureAsset(ticker, rungs, start, shares){
  ticker = (ticker||"").trim().toUpperCase();
  if(!ticker || !start) return;
  const idx = state.assets.findIndex(a=>a.ticker===ticker);
  const rungCount = Math.min(4, Math.max(2, parseInt(rungs||3)));
  const r = [];
  for(let i=0;i<rungCount;i++){
    r.push({
      sellPct: SELL_PCTS[i],
      buybackPct: BUYBACK_PCTS[i],
      rows: buildLadderRows(start, SELL_PCTS[i], BUYBACK_PCTS[i], shares)
    });
  }
  const asset = {ticker,start,sharesDefault:shares||1,rungs:rungCount,rungsData:r};
  if(idx>=0) state.assets[idx]=asset; else state.assets.push(asset);
  saveState();
  render();
}

function recomputePL(asset){
  asset.rungsData.forEach(rung=>{
    let cum=0;
    rung.rows.forEach(row=>{
      const plan = ( (row.plannedSell ?? 0) - (row.plannedBuy ?? 0) ) * (row.qty ?? row.plannedShares ?? 0);
      if(row.actualBuy!=null && row.actualSell!=null && row.qty!=null){
        row.realizedPL = +((row.actualSell - row.actualBuy) * row.qty).toFixed(2);
        row.deltaVsPlan = +(row.realizedPL - plan).toFixed(2);
        cum += row.realizedPL;
        row.cumRealized = +cum.toFixed(2);
      }else{
        row.realizedPL = null;
        row.deltaVsPlan = null;
        row.cumRealized = cum;
      }
    });
  });
}

function render(){
  const container = $("#assets");
  container.innerHTML = "";
  if(state.assets.length===0){
    const empty = document.createElement("div");
    empty.className="card";
    empty.innerHTML = "<i>Assets you add will appear here.</i>";
    container.appendChild(empty);
  }
  state.assets.forEach(asset=>{
    recomputePL(asset);
    const card = document.createElement("div");
    card.className="card";
    const hdrBadges = `<span class="badge">${asset.ticker}</span>
      <span class="badge">${asset.rungs} rung(s)</span>
      <span class="badge">start $${f2(asset.start)}</span>`;
    card.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
        ${hdrBadges}
        <button class="secondary" data-act="rebuild">Build Ladder</button>
        <button class="secondary" data-act="exportCSV">Export CSV</button>
        <button class="warn" data-act="delete">Delete Ladder</button>
      </div>
      <div class="note" style="margin:-6px 0 14px 0">Rungs use locked defaults: Sell +2.5%, +4.5%, +7%, +10% â€¢ Buyback 1%, 2.5%, 3.5%, 5% â€¢ 20 cycles. Edit any cell inline.</div>
      <div class="table" id="twrap"></div>
    `;
    // build table per rung
    const tw = card.querySelector("#twrap");
    asset.rungsData.forEach((rung,ri)=>{
      const tbl = document.createElement("table");
      const rungPct = Math.round(rung.sellPct*1000)/10;
      const bbPct   = Math.round(rung.buybackPct*1000)/10;
      tbl.innerHTML = `
        <thead>
          <tr><th colspan="13">${asset.ticker} â€” Rung ${ri+1} &nbsp; â€¢ &nbsp; Sell +${rungPct}% &nbsp; â€¢ &nbsp; Buyback ${bbPct}%</th></tr>
          <tr>
            <th>#</th>
            <th>Planned Buy</th>
            <th>Planned Sell</th>
            <th>Profit/Share</th>
            <th>Planned Shares</th>
            <th>Planned Total</th>
            <th>Buy Date</th>
            <th>Sell Date</th>
            <th>Actual Buy</th>
            <th>Actual Sell</th>
            <th>Filled Qty</th>
            <th>Realized P/L</th>
            <th>Î” vs Plan</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot><tr>
          <td colspan="11" style="text-align:right">Rung Total Realized:</td>
          <td class="rungTotal">$0.00</td>
          <td></td>
        </tr></tfoot>
      `;
      const tb = tbl.querySelector("tbody");
      let rungTotal = 0;
      rung.rows.forEach((row,i)=>{
        const tr = document.createElement("tr");
        const plannedTotal = +((row.profitPerShare||0) * (row.plannedShares||0)).toFixed(2);
        rungTotal += (row.realizedPL||0);
        tr.innerHTML = `
          <td>${row.cycle}</td>
          <td><input class="money" data-k="plannedBuy" type="number" step="0.01" value="${f2(row.plannedBuy)}"></td>
          <td><input class="money" data-k="plannedSell" type="number" step="0.01" value="${f2(row.plannedSell)}"></td>
          <td>${money(row.profitPerShare)}</td>
          <td><input class="qty" data-k="plannedShares" type="number" step="1" value="${row.plannedShares??1}"></td>
          <td>${money(plannedTotal)}</td>
          <td><input class="date" data-k="buyDate" type="date" value="${row.buyDate??""}"></td>
          <td><input class="date" data-k="sellDate" type="date" value="${row.sellDate??""}"></td>
          <td><input class="money" data-k="actualBuy" type="number" step="0.01" value="${f2(row.actualBuy)}"></td>
          <td><input class="money" data-k="actualSell" type="number" step="0.01" value="${f2(row.actualSell)}"></td>
          <td><input class="qty" data-k="qty" type="number" step="1" value="${row.qty??""}"></td>
          <td>${row.realizedPL!=null?money(row.realizedPL):""}</td>
          <td>${row.deltaVsPlan!=null?money(row.deltaVsPlan):""}</td>
        `;
        // attach listeners
        tr.querySelectorAll("input").forEach(inp=>{
          inp.addEventListener("change", e=>{
            const k = inp.dataset.k;
            let val = inp.value;
            if(["plannedBuy","plannedSell","actualBuy","actualSell"].includes(k)) val = toNum(val);
            if(["plannedShares","qty"].includes(k)) val = (val===""?null:parseInt(val));
            if(["buyDate","sellDate"].includes(k)) {/* keep string yyyy-mm-dd */}
            rung.rows[i][k] = val;
            // keep profit/share and planned total updated when planned numbers change
            row.profitPerShare = +((row.plannedSell - row.plannedBuy)).toFixed(2);
            saveState();
            render();
          }, {passive:true});
        });
        tb.appendChild(tr);
      });
      tbl.querySelector(".rungTotal").textContent = money(rungTotal);
      tw.appendChild(tbl);
    });
    // wire card buttons
    card.querySelector('[data-act="delete"]').onclick = ()=>{
      state.assets = state.assets.filter(a=>a.ticker!==asset.ticker); saveState(); render();
    };
    card.querySelector('[data-act="rebuild"]').onclick = ()=>{
      // rebuild using current start & shares
      ensureAsset(asset.ticker, asset.rungs, asset.start, asset.sharesDefault);
    };
    card.querySelector('[data-act="exportCSV"]').onclick = ()=>{
      exportCSVForAsset(asset);
    };
    container.appendChild(card);
  });
  // Update charts totals
  updateTotals();
}

function updateTotals(){
  let total = 0, assets = state.assets.length, open=0, closed=0;
  state.assets.forEach(a=>a.rungsData.forEach(r=>r.rows.forEach(row=>{
    if(row.realizedPL!=null){ total += row.realizedPL; closed++; } else { open++; }
  })) );
  $("#kTotal").textContent = money(total);
  $("#kAssets").textContent = assets;
  $("#kOpen").textContent = open;
  $("#kClosed").textContent = closed;
}

function exportCSVForAsset(asset){
  let csv = "Ticker,Rung,Cycle,Planned Buy,Planned Sell,Profit/Share,Planned Shares,Planned Total,Buy Date,Sell Date,Actual Buy,Actual Sell,Filled Qty,Realized P/L,Delta vs Plan\n";
  asset.rungsData.forEach((rung,ri)=>{
    rung.rows.forEach(row=>{
      const pTotal = ((row.profitPerShare||0)*(row.plannedShares||0)).toFixed(2);
      csv += [
        asset.ticker, ri+1, row.cycle,
        f2(row.plannedBuy), f2(row.plannedSell), f2(row.profitPerShare),
        row.plannedShares??"", pTotal,
        row.buyDate??"", row.sellDate??"",
        f2(row.actualBuy), f2(row.actualSell), row.qty??"",
        f2(row.realizedPL), f2(row.deltaVsPlan)
      ].join(",") + "\n";
    });
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = asset.ticker+"_ladder.csv";
  document.body.appendChild(a); a.click(); a.remove();
}

// ----- UI wiring -----
document.querySelectorAll(".tab").forEach(btn=>btn.onclick = ()=>{
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  document.querySelectorAll(".tabpage").forEach(p=>p.style.display="none");
  document.getElementById(btn.dataset.tab).style.display = "";
});

$("#btnAdd").onclick = ()=>{
  const t = $("#inTicker").value.trim();
  const r = $("#inRungs").value;
  const s = parseFloat($("#inStart").value);
  const sh = parseInt($("#inShares").value||"1",10);
  if(!t || isNaN(s)){ alert("Enter ticker and start price"); return; }
  ensureAsset(t,r,s,sh);
};

$("#btnBackup").onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ladder_backup.json";
  document.body.appendChild(a); a.click(); a.remove();
};

$("#btnRestore").onclick = ()=> $("#restoreInput").click();
$("#restoreInput").addEventListener("change", e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{ try{ state = JSON.parse(reader.result); saveState(); render(); }catch(err){ alert("Invalid file."); } };
  reader.readAsText(file);
});

$("#btnClear").onclick = ()=>{
  if(confirm("Clear all data on this device?")){ state = {assets:[]}; saveState(); render(); }
};

// initial render
render();
</script>
</body>
</html>
