
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ladder App</title>
  <meta name="theme-color" content="#0a7"/>
  <style>
    :root{--bg:#f7f7f7;--panel:#fff;--fg:#111;--muted:#666;--acc:#0a7;--red:#c33;--bd:#ddd}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0a7;color:#fff;position:sticky;top:0;z-index:3}
    header .actions button{margin-left:8px;background:#fff;color:#0a7;border:none;border-radius:8px;padding:8px 10px;font-weight:600}
    h1{font-size:18px;margin:0}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:14px;margin:10px 0}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input,select,button,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid var(--bd);background:#fff}
    button.primary{background:var(--acc);color:#fff;border:none}
    button.red{background:var(--red);color:#fff;border:none}
    .pill{display:inline-block;background:#eef;border:1px solid var(--bd);padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:#555;text-align:left;padding:6px 8px}
    tbody td{background:#fff;border:1px solid var(--bd);padding:6px 8px}
    tbody td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    tbody td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
    .tabs{display:flex;gap:8px;margin:8px 0 12px}
    .tabs button{background:#e8f6f0;color:#0a7;border:none;padding:10px 14px;border-radius:999px;font-weight:700}
    .tabs button[aria-selected="true"]{background:#0a7;color:#fff}
    .muted{color:#777;font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.row{grid-template-columns:repeat(6,1fr)} .grid2{grid-template-columns:1fr}}
    .right{float:right}
  </style>
</head>
<body>
<header>
  <h1>ðŸ“ˆ Ladder App</h1>
  <div class="actions">
    <button id="tabLadders" class="tabBtn" aria-selected="true">Ladders</button>
    <button id="tabCharts" class="tabBtn">Charts</button>
  </div>
</header>
<div class="wrap">
  <section id="laddersView">
    <div class="card">
      <div class="row">
        <div class="col" style="grid-column: span 3;">
          <label>Ticker / Name</label>
          <input id="ticker" placeholder="e.g., RIOT or BTC" />
        </div>
        <div class="col" style="grid-column: span 3;">
          <label>Start Price</label>
          <input id="startPrice" inputmode="decimal" placeholder="current price"/>
        </div>
        <div class="col" style="grid-column: span 3;">
          <label>Rungs</label>
          <select id="rungs">
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
          </select>
        </div>
        <div class="col" style="grid-column: span 3;">
          <label>Default Shares per row</label>
          <input id="defShares" inputmode="decimal" value="1"/>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col" style="grid-column: span 4;">
          <button id="addAsset" class="primary">+ Add / Replace Asset</button>
        </div>
        <div class="col" style="grid-column: span 4;">
          <button id="exportJSON">Export JSON</button>
        </div>
        <div class="col" style="grid-column: span 4;">
          <button id="importJSON">Import JSON</button>
        </div>
      </div>
      <p class="muted">Locked presets: Sell +2.5%, +4.5%, +7%, +10% &middot; Buyback 1%, 2.5%, 3.5%, 5% (applied by rung). 20 cycles. You can edit any cell after build.</p>
    </div>
    <div id="assets"></div>
  </section>

  <section id="chartsView" style="display:none">
    <div class="card">
      <h3>Portfolio Total: <span id="portfolioTotal">$0.00</span></h3>
      <div class="grid2">
        <div>
          <label>From</label>
          <input id="rangeFrom" type="date"/>
        </div>
        <div>
          <label>To</label>
          <input id="rangeTo" type="date"/>
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="primary" id="updateChart">Update Chart</button>
      </div>
    </div>
    <div class="card">
      <canvas id="plChart" height="220"></canvas>
      <p class="muted">Chart sums <b>Realized P/L</b> from rows that have Sell Date + Actuals. Use the Ladders tab to fill your trades.</p>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const STORE_KEY = "ladderDataV4";
  const $ = sel => document.querySelector(sel);
  const fmt = n => (isFinite(n)? "$"+n.toFixed(2):"$0.00");
  const toNum = v => { let n = parseFloat(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n)?0:n; };
  const round = n => Math.round(n*100)/100;

  const SELL_PCTS = [0.025,0.045,0.07,0.10];   // rung1..rung4
  const BUYBK_PCTS = [0.01,0.025,0.035,0.05];

  function loadState(){
    try{ return JSON.parse(localStorage.getItem(STORE_KEY)||"{\"assets\":[]}"); }
    catch(e){ return {assets:[]}; }
  }
  function saveState(s){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }catch(e){/* storage disabled */}
  }

  let state = loadState();
  render();

  // --- UI actions
  $("#addAsset").onclick = () => {
    const t = $("#ticker").value.trim() || "ASSET";
    const start = toNum($("#startPrice").value);
    const rungCount = parseInt($("#rungs").value,10);
    const defShares = Math.max(0, toNum($("#defShares").value)||1);

    if(!start){ alert("Enter a valid Start Price"); return; }

    // Build rows for each rung using corrected math:
    // sell1 = start*(1+s); buy1 = sell1*(1-b);
    // then sell(n) = sell(n-1)*(1+s); buy(n) = sell(n)*(1-b)
    const rungs = [];
    for(let r=0;r<rungCount;r++){
      const sPct = SELL_PCTS[r];
      const bPct = BUYBK_PCTS[r];
      let sell = round(start*(1+sPct));
      const rows = [];
      for(let i=1;i<=20;i++){
        const buy  = round(sell*(1-bPct));
        const profitPer = round(sell-buy);
        rows.push({
          cycle:i, plannedBuy:buy, plannedSell:sell, profitPer:profitPer, plannedShares:defShares,
          plannedTotal: round(profitPer*defShares),
          buyDate:"", sellDate:"", actualBuy:"", actualSell:"", filledQty:"",
          realizedPL:"", deltaVsPlan:"", cumRealized:""
        });
        // advance to next cycle sell
        sell = round(sell*(1+sPct));
      }
      rungs.push({ sellPct:sPct, buybackPct:bPct, rows });
    }

    // Replace if ticker exists, otherwise add
    const ix = state.assets.findIndex(a => a.ticker.toUpperCase()===t.toUpperCase());
    const asset = { ticker:t.toUpperCase(), startPrice:start, rungs:rungs };
    if(ix>=0) state.assets[ix] = asset; else state.assets.push(asset);

    saveState(state);
    render();
    alert("Built ladder for "+asset.ticker+" ("+rungCount+" rungs).");
  };

  $("#exportJSON").onclick = () => {
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "ladder_backup.json"; a.click();
    URL.revokeObjectURL(url);
  };
  $("#importJSON").onclick = async () => {
    const inp = document.createElement("input");
    inp.type="file"; inp.accept=".json,application/json";
    inp.onchange = async () => {
      const file = inp.files[0]; if(!file) return;
      const text = await file.text();
      try{ state = JSON.parse(text); saveState(state); render(); alert("Import complete"); }
      catch(e){ alert("Invalid JSON"); }
    };
    inp.click();
  };

  // Tab switching
  $("#tabLadders").onclick = () => { $("#laddersView").style.display=""; $("#chartsView").style.display="none"; $("#tabLadders").setAttribute("aria-selected","true"); $("#tabCharts").removeAttribute("aria-selected"); };
  $("#tabCharts").onclick = () => { $("#laddersView").style.display="none"; $("#chartsView").style.display=""; $("#tabCharts").setAttribute("aria-selected","true"); $("#tabLadders").removeAttribute("aria-selected"); updatePortfolioTotals(); drawChart(); };

  function render(){
    const wrap = $("#assets");
    wrap.innerHTML = "";
    if(state.assets.length===0){
      const empty = document.createElement("div");
      empty.className = "card"; empty.innerHTML = "<b>No assets yet.</b> Add one above.";
      wrap.appendChild(empty); return;
    }
    state.assets.forEach((asset, aidx) => {
      const card = document.createElement("div");
      card.className = "card";
      const badges = asset.rungs.map((r,i)=>{
        const s=Math.round(r.sellPct*1000)/10, b=Math.round(r.buybackPct*1000)/10;
        return `<span class="pill">Rung ${i+1}: Sell +${s}% Â· Buyback ${b}%</span>`;
      }).join(" ");
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
          <div><b>${asset.ticker}</b> Â· start ${fmt(asset.startPrice)} &nbsp; ${badges}</div>
          <div>
            <button class="primary" data-act="rebuild">Build Ladder</button>
            <button data-act="csv">Export CSV</button>
            <button class="red" data-act="delete">Delete Ladder</button>
          </div>
        </div>
        <p class="muted">Locked defaults. 20 cycles. Edit any cell inline â€” totals recalc & auto-save.</p>
      `;
      // Build tables for each rung
      asset.rungs.forEach((rung, ridx)=>{
        const tbl = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr><th colspan="14" style="padding:4px 0"> <b>${asset.ticker} â€” Rung ${ridx+1}</b> &middot; Sell +${Math.round(rung.sellPct*1000)/10}% Â· Buyback ${Math.round(rung.buybackPct*1000)/10}%</th></tr>
          <tr>
            <th>#</th><th>Planned Buy</th><th>Planned Sell</th><th>Profit/Share</th><th>Planned Shares</th><th>Planned Total</th>
            <th>Buy Date</th><th>Sell Date</th><th>Actual Buy</th><th>Actual Sell</th><th>Filled Qty</th>
            <th>Realized P/L</th><th>Î” vs Plan</th><th>Cum Realized</th>
          </tr>`;
        tbl.appendChild(thead);
        const tbody = document.createElement("tbody");
        rung.rows.forEach((row, idx)=>{
          const tr = document.createElement("tr");
          function tdInput(val, cls, type="text", step="any"){
            return `<input type="${type}" step="${step}" class="${cls}" value="${(val!==undefined&&val!=="")?val:""}" style="width:100%">`;
          }
          tr.innerHTML = `
            <td>${row.cycle}</td>
            <td>${tdInput(row.plannedBuy,"pb","number")}</td>
            <td>${tdInput(row.plannedSell,"ps","number")}</td>
            <td class="profitPer">${fmt(row.profitPer)}</td>
            <td>${tdInput(row.plannedShares,"qty","number")}</td>
            <td class="plannedTot">${fmt(row.plannedTotal)}</td>
            <td>${tdInput(row.buyDate,"bd","date")}</td>
            <td>${tdInput(row.sellDate,"sd","date")}</td>
            <td>${tdInput(row.actualBuy,"ab","number")}</td>
            <td>${tdInput(row.actualSell,"as","number")}</td>
            <td>${tdInput(row.filledQty,"fq","number")}</td>
            <td class="realized">${row.realizedPL?fmt(toNum(row.realizedPL)):fmt(0)}</td>
            <td class="delta">${row.deltaVsPlan?fmt(toNum(row.deltaVsPlan)):fmt(0)}</td>
            <td class="cum">${row.cumRealized?fmt(toNum(row.cumRealized)):fmt(0)}</td>
          `;
          // wire inputs
          tr.querySelector(".pb").oninput = (e)=>{
            row.plannedBuy = toNum(e.target.value); row.profitPer = round(row.plannedSell - row.plannedBuy);
            tr.querySelector(".profitPer").textContent = fmt(row.profitPer);
            row.plannedTotal = round(row.profitPer * (row.plannedShares||0)); tr.querySelector(".plannedTot").textContent = fmt(row.plannedTotal);
            saveState(state);
          };
          tr.querySelector(".ps").oninput = (e)=>{
            row.plannedSell = toNum(e.target.value); row.profitPer = round(row.plannedSell - row.plannedBuy);
            tr.querySelector(".profitPer").textContent = fmt(row.profitPer);
            row.plannedTotal = round(row.profitPer * (row.plannedShares||0)); tr.querySelector(".plannedTot").textContent = fmt(row.plannedTotal);
            saveState(state);
          };
          tr.querySelector(".qty").oninput = (e)=>{
            row.plannedShares = toNum(e.target.value)||0; row.plannedTotal = round((row.profitPer||0) * row.plannedShares);
            tr.querySelector(".plannedTot").textContent = fmt(row.plannedTotal); saveState(state);
          };
          tr.querySelector(".bd").oninput = (e)=>{ row.buyDate = e.target.value; saveState(state); };
          tr.querySelector(".sd").oninput = (e)=>{ row.sellDate = e.target.value; saveState(state); };
          tr.querySelector(".ab").oninput = (e)=>{ row.actualBuy = toNum(e.target.value); recalcRealized(asset,rung,tbody); };
          tr.querySelector(".as").oninput = (e)=>{ row.actualSell = toNum(e.target.value); recalcRealized(asset,rung,tbody); };
          tr.querySelector(".fq").oninput = (e)=>{ row.filledQty = toNum(e.target.value); recalcRealized(asset,rung,tbody); };
          tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        card.appendChild(tbl);

        // CSV export per asset
        card.querySelector('[data-act="csv"]').onclick = ()=>{
          const rows = [["Ticker","Rung","#","Planned Buy","Planned Sell","Profit/Share","Planned Shares","Planned Total","Buy Date","Sell Date","Actual Buy","Actual Sell","Filled Qty","Realized P/L","Delta vs Plan","Cum Realized"]];
          asset.rungs.forEach((r,i)=>r.rows.forEach(row=>{
            rows.push([asset.ticker,i+1,row.cycle,row.plannedBuy,row.plannedSell,row.profitPer,row.plannedShares,row.plannedTotal,row.buyDate,row.sellDate,row.actualBuy,row.actualSell,row.filledQty,row.realizedPL,row.deltaVsPlan,row.cumRealized]);
          }));
          const csv = rows.map(r=>r.join(",")).join("\n");
          const blob = new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
          const a=document.createElement("a"); a.href=url; a.download=`${asset.ticker}_ladder.csv`; a.click(); URL.revokeObjectURL(url);
        };

        // Rebuild ladder (keeps same start price & def shares for convenience)
        card.querySelector('[data-act="rebuild"]').onclick = ()=>{
          $("#ticker").value = asset.ticker;
          $("#startPrice").value = asset.startPrice;
          $("#rungs").value = asset.rungs.length;
          $("#defShares").value = (asset.rungs[0]?.rows?.[0]?.plannedShares)||1;
          alert("Loaded fields from "+asset.ticker+". Change anything up top and press + Add / Replace Asset to rebuild.");
          window.scrollTo({top:0,behavior:"smooth"});
        };

      });
      // delete
      card.querySelector('[data-act="delete"]').onclick = ()=>{
        if(confirm("Delete "+asset.ticker+"?")){
          state.assets.splice(aidx,1); saveState(state); render();
        }
      };
      wrap.appendChild(card);
    });
  }

  function recalcRealized(asset,rung,tbody){
    // recompute realized/delta/cum for a rung
    let cum = 0;
    rung.rows.forEach((row, idx)=>{
      const realized = round((toNum(row.actualSell)-toNum(row.actualBuy))*toNum(row.filledQty||0));
      row.realizedPL = realized;
      row.deltaVsPlan = round(realized - toNum(row.plannedTotal));
      cum = round(cum + realized);
      row.cumRealized = cum;
      // reflect in DOM
      const tr = tbody.children[idx];
      if(tr){
        tr.querySelector(".realized").textContent = fmt(realized);
        tr.querySelector(".delta").textContent = fmt(row.deltaVsPlan);
        tr.querySelector(".cum").textContent = fmt(cum);
      }
    });
    saveState(state);
  }

  // --- Charts
  let chart;
  function gatherRealizedByDate(from=null,to=null){
    const map = new Map(); // key = sellDate (YYYY-MM-DD), val = realized sum
    state.assets.forEach(a=>a.rungs.forEach(r=>r.rows.forEach(row=>{
      if(!row.sellDate) return;
      if(from && row.sellDate<from) return;
      if(to && row.sellDate>to) return;
      const val = toNum(row.realizedPL);
      if(!val) return;
      map.set(row.sellDate, (map.get(row.sellDate)||0)+val);
    })));
    const labels = Array.from(map.keys()).sort();
    const data = labels.map(d=>map.get(d));
    return {labels,data};
  }
  function updatePortfolioTotals(){
    let total = 0;
    state.assets.forEach(a=>a.rungs.forEach(r=>r.rows.forEach(row=> total += toNum(row.realizedPL))));
    $("#portfolioTotal").textContent = fmt(total);
  }
  function drawChart(){
    const from = $("#rangeFrom").value || null;
    const to   = $("#rangeTo").value || null;
    const {labels,data} = gatherRealizedByDate(from,to);
    const ctx = $("#plChart");
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type:"bar",
      data:{labels, datasets:[{label:"Realized P/L", data}]},
      options:{responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}}}
    });
  }

  // expose a tiny helper so you can hard-refresh cache with ?bust=#
  (function cacheBust(){
    const url = new URL(location.href);
    if(url.searchParams.has("bust")){
      sessionStorage.setItem("cacheBustSeen", url.searchParams.get("bust"));
    }
  })();
</script>
</body>
</html>
