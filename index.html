<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ladder App</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='10' ry='10' fill='%2307a37e'/%3E%3Cg stroke='%23fff' stroke-width='4' stroke-linecap='round'%3E%3Cline x1='22' y1='10' x2='22' y2='54'/%3E%3Cline x1='42' y1='10' x2='42' y2='54'/%3E%3Cline x1='22' y1='16' x2='42' y2='16'/%3E%3Cline x1='22' y1='26' x2='42' y2='26'/%3E%3Cline x1='22' y1='36' x2='42' y2='36'/%3E%3Cline x1='22' y1='46' x2='42' y2='46'/%3E%3C/g%3E%3C/svg%3E">
<style>
:root{--brand:#07a37e;--text:#111;--muted:#666;--bg:#f6f7f8;--card:#fff;--accent:#0a7;--danger:#d33}
*{box-sizing:border-box}
body{margin:0;font:16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; color:var(--text); background:var(--bg)}
header{position:sticky;top:0;background:var(--brand);color:#fff;padding:12px 16px;z-index:10}
header .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
h1{font-size:20px;margin:0;display:flex;align-items:center;gap:8px}
nav{margin-left:auto;display:flex;gap:8px}
nav button{padding:8px 14px;border:0;border-radius:8px;background:#fff;color:var(--brand);font-weight:600}
nav button.active{background:#004d3f;color:#fff}
main{padding:16px;display:grid;gap:16px;max-width:1100px;margin:0 auto}
.card{background:var(--card);border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.05);padding:16px}
small.muted{color:var(--muted)}
label{display:block;font-weight:600;margin:8px 0 6px}
input,select,button,.btn{font-size:16px}
input,select{width:100%;padding:10px;border:1px solid #d7d7d7;border-radius:10px;background:#fff}
.controls{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media(min-width:700px){.controls{grid-template-columns:repeat(4,1fr)}}
button,.btn{cursor:pointer;border:0;border-radius:10px;padding:12px 14px;font-weight:700}
.btn-primary{background:var(--accent);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-secondary{background:#eee}
.asset{margin-top:8px}
.asset h3{margin:6px 0 12px}
.badge{display:inline-block;background:#eef7f5;color:#056; border:1px solid #cde; padding:4px 10px;border-radius:999px;margin-left:6px;font-size:12px}
.tablewrap{overflow:auto;border:1px solid #e5e5e5;border-radius:12px}
table{border-collapse:separate;border-spacing:0;width:100%}
th,td{padding:10px 8px;border-bottom:1px solid #eee;background:#fff}
th{position:sticky;top:0;background:#f8faf9;z-index:1}
td input{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;background:#fff;font-variant-numeric:tabular-nums}
td input[type="date"]{min-width:140px}
td.num,th.num{text-align:right}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px}
.kpi{background:#f0faf6;border:1px solid #cfe; padding:10px;border-radius:10px;text-align:center}
footer{padding:18px 0 40px;color:#888;text-align:center}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>ðŸªœ Ladder App</h1>
    <div id="saveFlag" class="badge">ready</div>
    <nav>
      <button id="tabLadders" class="active">Ladders</button>
      <button id="tabCharts">Charts</button>
    </nav>
  </div>
</header>

<main>
  <section id="pageLadders" class="card">
    <h2 style="margin:0 0 10px">Add / Replace Asset</h2>
    <div class="controls">
      <div><label>Ticker / Name</label><input id="ticker" placeholder="e.g., RIOT or COIN"></div>
      <div><label>Rungs</label>
        <select id="rungs">
          <option value="2">2 rungs</option>
          <option value="3" selected>3 rungs</option>
          <option value="4">4 rungs</option>
        </select>
      </div>
      <div><label>Start Price</label><input id="startPrice" type="number" step="0.01" placeholder="current price"></div>
      <div><label>Default Shares / row</label><input id="defaultShares" type="number" step="1" value="1"></div>
    </div>
    <div class="card" style="background:#fff7e8;border:1px solid #ffd8a8;margin-top:12px">
      <b>Presets (locked):</b> Sell +2.5%, +4.5%, +7%, +10% (first 2â€“4 based on selection). 
      Buyback 1%, 2.5%, 3.5%, 5% (rungs 1â€“4). 20 cycles.
      Row 1 Planned Buy equals Start Price; each next row uses: 
      <code>nextBuy = prevSell Ã— (1 âˆ’ buyback%)</code> and <code>sell = buy Ã— (1 + sell%)</code>.
    </div>
    <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
      <button id="addAssetBtn" class="btn-primary">+ Add / Replace Asset</button>
      <button id="saveJson" class="btn-secondary">Save Backup (JSON)</button>
      <button id="loadJson" class="btn-secondary">Restore Backup (JSON)</button>
      <button id="clearAll" class="btn-danger">Clear All (this device)</button>
    </div>
  </section>

  <section id="assets"></section>

  <section id="pageCharts" class="card" style="display:none">
    <h2 style="margin-top:0">Totals & Chart</h2>
    <div class="kpis">
      <div class="kpi"><div style="font-size:13px;color:#456">Portfolio Total (realized)</div><div id="pfTotal" style="font-weight:800;font-size:20px">$0.00</div></div>
      <div class="kpi"><div style="font-size:13px;color:#456"># of Assets</div><div id="pfAssets" style="font-weight:800;font-size:20px">0</div></div>
    </div>
    <div class="card" style="border:1px solid #e5e5e5">
      <canvas id="barChart" height="120"></canvas>
    </div>
  </section>
</main>

<footer>v2.3.2 â€¢ data auto-saves on this device</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const STORAGE_KEY = "ladderApp_v232";
const SELL_PRESETS = [0.025, 0.045, 0.07, 0.10];
const BUYBACKS = [0.01, 0.025, 0.035, 0.05];
const CYCLES = 20;

const $ = sel => document.querySelector(sel);
const fmt = n => isFinite(n) ? (n>=100 ? n.toFixed(2) : n.toFixed(2)) : "";
const currency = n => isFinite(n) ? "$" + fmt(n) : "";
const saveFlag = $("#saveFlag");

let state = loadState();

// Tabs
$("#tabLadders").onclick = () => { $("#tabLadders").classList.add("active"); $("#tabCharts").classList.remove("active"); $("#pageLadders").style.display=""; $("#assets").style.display=""; $("#pageCharts").style.display="none"; };
$("#tabCharts").onclick = () => { $("#tabCharts").classList.add("active"); $("#tabLadders").classList.remove("active"); $("#pageLadders").style.display="none"; $("#assets").style.display="none"; $("#pageCharts").style.display=""; drawChart(); };

// Form buttons
$("#addAssetBtn").onclick = () => {
  const t = $("#ticker").value.trim();
  const r = parseInt($("#rungs").value,10);
  const sp = parseFloat($("#startPrice").value);
  const defQty = parseInt($("#defaultShares").value||"1",10);

  if(!t || !isFinite(sp)) { alert("Enter ticker and a valid start price."); return; }

  const asset = buildAsset(t.toUpperCase(), sp, r, defQty);
  const idx = state.assets.findIndex(a => a.ticker === asset.ticker);
  if (idx >= 0) state.assets[idx] = asset; else state.assets.push(asset);
  persist();
  renderAssets();
  // jump to asset just added
  setTimeout(()=>{
    const card = document.getElementById("asset-"+asset.ticker);
    if(card) card.scrollIntoView({behavior:"smooth",block:"start"});
  },0);
};

$("#saveJson").onclick = () => {
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ladder_backup.json";
  a.click();
};

$("#loadJson").onclick = async () => {
  const inp = document.createElement("input");
  inp.type = "file"; inp.accept = ".json,application/json";
  inp.onchange = async () => {
    const f = inp.files[0]; if(!f) return;
    const text = await f.text();
    try { const obj = JSON.parse(text); if(obj && obj.assets) { state = obj; persist(); renderAssets(); alert("Backup restored."); } }
    catch(e){ alert("Invalid JSON."); }
  };
  inp.click();
};

$("#clearAll").onclick = () => {
  if(confirm("Clear all ladders saved on this device?")) {
    state = { assets: [] };
    persist();
    renderAssets();
  }
};

function loadState(){
  try { const raw = localStorage.getItem(STORAGE_KEY); if(raw) return JSON.parse(raw); } catch(e){}
  return { assets: [] };
}
function persist(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  const now = new Date();
  saveFlag.textContent = "saved â€¢ " + now.toLocaleTimeString();
}
function buildAsset(ticker, startPrice, rungs, defQty){
  const rungPerc = SELL_PRESETS.slice(0, rungs);
  const buybacks = BUYBACKS.slice(0, rungs);
  const ladders = [];
  for(let r=0;r<rungs;r++){
    const sellPct = rungPerc[r];
    const buyback = buybacks[r];
    const rows = [];
    // --- FIX: include row 1 with start price ---
    let buy = startPrice;                 // row 1 buy = start price
    let sell = buy * (1 + sellPct);       // row 1 sell
    for(let i=1;i<=CYCLES;i++){
      rows.push({
        i, buy:+buy.toFixed(2), sell:+sell.toFixed(2),
        profitPerShare:+(sell - buy).toFixed(2),
        plannedQty: defQty, plannedTotal: +((sell - buy)*defQty).toFixed(2),
        buyDate:"", sellDate:"", actualBuy:"", actualSell:"", qty:"",
        realized:0, delta:0, cum:0
      });
      // next row inputs
      buy = sell * (1 - buyback);
      sell = buy * (1 + sellPct);
    }
    ladders.push({ rung:r+1, sellPct, buyback, rows });
  }
  return { ticker, startPrice, rungs, defQty, ladders };
}

function renderAssets(){
  const host = $("#assets");
  host.innerHTML = "";
  state.assets.forEach(asset => host.appendChild(renderAsset(asset)));
  drawChart();
}

function renderAsset(asset){
  const card = document.createElement("section");
  card.className = "card asset";
  card.id = "asset-"+asset.ticker;

  const head = document.createElement("div");
  head.style.display="flex"; head.style.gap="10px"; head.style.flexWrap="wrap"; head.style.justifyContent="space-between"; head.style.alignItems="center";
  head.innerHTML = `<h3 style="margin:0">${asset.ticker} <span class="badge">${asset.rungs} rung(s)</span> <span class="badge">start ${currency(asset.startPrice)}</span></h3>`;
  const btns = document.createElement("div");
  btns.style.display="flex"; btns.style.gap="8px"; btns.innerHTML = `
    <button class="btn-primary" title="Rebuild using locked %">Build Ladder</button>
    <button class="btn-secondary" title="Download CSV for Excel">Export CSV</button>
    <button class="btn-danger" title="Remove this ladder">Delete Ladder</button>
  `;
  head.appendChild(btns);
  card.appendChild(head);

  // footnote
  const fn = document.createElement("div");
  fn.className="small muted";
  fn.style.margin="6px 0 10px";
  fn.textContent = "Rungs use locked defaults: Sell +2.5%, +4.5%, +7%, +10% â€¢ Buyback 1%, 2.5%, 3.5%, 5% â€¢ 20 cycles. Edit any cell inline.";
  card.appendChild(fn);

  asset.ladders.forEach(lad=>{
    const subtitle = document.createElement("div");
    subtitle.style.margin="8px 4px";
    subtitle.innerHTML = `<b>${asset.ticker} â€” Rung ${lad.rung}</b>  â€¢  Sell +${(lad.sellPct*100).toFixed(1)}%  â€¢  Buyback ${(lad.buyback*100).toFixed(1)}%`;
    card.appendChild(subtitle);

    const wrap = document.createElement("div");
    wrap.className = "tablewrap";
    const tbl = document.createElement("table");
    tbl.innerHTML = `
      <thead><tr>
        <th style="width:44px">#</th>
        <th class="num">Planned Buy</th>
        <th class="num">Planned Sell</th>
        <th class="num">Profit/Share</th>
        <th class="num">Planned Shares</th>
        <th class="num">Planned Total</th>
        <th>Buy Date</th>
        <th>Sell Date</th>
        <th class="num">Actual Buy</th>
        <th class="num">Actual Sell</th>
        <th class="num">Filled Qty</th>
        <th class="num">Realized P/L</th>
        <th class="num">Î” vs Plan</th>
        <th class="num">Cum Realized</th>
      </tr></thead>
      <tbody></tbody>`;
    const tb = tbl.querySelector("tbody");

    // compute cum
    let cum=0;
    lad.rows.forEach((row,idx)=>{
      const tr = document.createElement("tr");
      const realized = row.qty && row.actualBuy && row.actualSell ? (row.actualSell - row.actualBuy) * row.qty : 0;
      const delta = realized - row.plannedTotal;
      cum += realized;
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="num"><input inputmode="decimal" value="${fmt(row.buy)}"></td>
        <td class="num"><input inputmode="decimal" value="${fmt(row.sell)}"></td>
        <td class="num">${currency(row.profitPerShare)}</td>
        <td class="num"><input inputmode="numeric" value="${row.plannedQty}"></td>
        <td class="num">${currency(row.plannedTotal)}</td>
        <td><input type="date" value="${row.buyDate||""}"></td>
        <td><input type="date" value="${row.sellDate||""}"></td>
        <td class="num"><input inputmode="decimal" value="${row.actualBuy||""}"></td>
        <td class="num"><input inputmode="decimal" value="${row.actualSell||""}"></td>
        <td class="num"><input inputmode="numeric" value="${row.qty||""}"></td>
        <td class="num">${currency(realized)}</td>
        <td class="num">${currency(delta)}</td>
        <td class="num">${currency(cum)}</td>
      `;
      // change handlers -> update state and resave
      const inputs = tr.querySelectorAll("input");
      inputs.forEach((inp,ci)=>{
        inp.onchange = () => {
          // map by column
          const map = ["buy","sell",null,"plannedQty",null,"buyDate","sellDate","actualBuy","actualSell","qty"];
          // columns 0..9 correspond to inputs we rendered
          const colMap = {0:"buy",1:"sell",2:"plannedQty",3:"buyDate",4:"sellDate",5:"actualBuy",6:"actualSell",7:"qty"};
          // but we actually appended as: buy,sell,plannedQty,buyDate,sellDate,actualBuy,actualSell,qty
          const arr = ["buy","sell","plannedQty","buyDate","sellDate","actualBuy","actualSell","qty"];
          const key = arr[ci];
          lad.rows[idx][key] = inp.type==="date" ? inp.value : (inp.value===""? "" : +(+inp.value).toFixed(2));
          persist();
          // re-render this asset to update calculated columns
          const newIdx = state.assets.findIndex(a=>a.ticker===asset.ticker);
          const fresh = state.assets[newIdx];
          const section = document.getElementById("asset-"+asset.ticker);
          section.replaceWith(renderAsset(fresh));
        };
      });
      tb.appendChild(tr);
    });
    wrap.appendChild(tbl);
    card.appendChild(wrap);
  });

  // Buttons
  btns.children[0].onclick = ()=>{
    const i = state.assets.findIndex(a=>a.ticker===asset.ticker);
    state.assets[i] = buildAsset(asset.ticker, asset.startPrice, asset.rungs, asset.defQty);
    persist(); renderAssets();
  };
  btns.children[1].onclick = ()=>{
    // CSV
    const lines = [];
    lines.push(["Ticker","Rung","#","Planned Buy","Planned Sell","Profit/Share","Planned Shares","Planned Total","Buy Date","Sell Date","Actual Buy","Actual Sell","Filled Qty","Realized","Delta","Cum"].join(","));
    asset.ladders.forEach(l=>{
      let cum=0;
      l.rows.forEach((r,idx)=>{
        const realized = (r.qty && r.actualBuy && r.actualSell) ? (r.actualSell - r.actualBuy)*r.qty : 0;
        cum += realized;
        lines.push([asset.ticker,l.rung,idx+1,fmt(r.buy),fmt(r.sell),fmt(r.profitPerShare),r.plannedQty,fmt(r.plannedTotal),r.buyDate||"",r.sellDate||"",r.actualBuy||"",r.actualSell||"",r.qty||"",fmt(realized),fmt(realized - r.plannedTotal),fmt(cum)].join(","));
      });
    });
    const blob = new Blob([lines.join("\n")],{type:"text/csv"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = asset.ticker+"_ladder.csv"; a.click();
  };
  btns.children[2].onclick = ()=>{
    if(confirm("Delete this ladder?")){ state.assets = state.assets.filter(a=>a.ticker!==asset.ticker); persist(); renderAssets(); }
  };

  return card;
}

function drawChart(){
  // aggregate realized by sell date across assets
  const map = new Map();
  let assetsCount = state.assets.length;
  state.assets.forEach(a=>a.ladders.forEach(l=>l.rows.forEach(r=>{
    if(r.sellDate && r.qty && r.actualBuy && r.actualSell){
      const realized = (r.actualSell - r.actualBuy) * r.qty;
      const k = r.sellDate;
      map.set(k, (map.get(k)||0) + realized);
    }
  })));

  const labels = Array.from(map.keys()).sort();
  const values = labels.map(k=>map.get(k));

  $("#pfAssets").textContent = assetsCount;
  $("#pfTotal").textContent = currency(values.reduce((a,b)=>a+b,0));

  const ctx = document.getElementById("barChart");
  if(window.__chart){ window.__chart.destroy(); }
  window.__chart = new Chart(ctx, {
    type:'bar',
    data:{labels, datasets:[{label:'Realized P/L', data:values}]},
    options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}
  });
}

// initial render
renderAssets();
</script>
</body>
</html>
