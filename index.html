<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App</title>
<meta name="theme-color" content="#0a7">
<link rel="icon" href="assets/ladder.svg">
<style>
:root{
  --brand:#0a7;--fg:#111;--bg:#f7f7f7;--panel:#fff;--muted:#667;--danger:#c33;--ok:#179e57;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.35 -apple-system,system-ui,Segoe UI,Roboto,Arial;}
header{position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
header img{width:28px;height:28px}
header h1{font-size:20px;margin:0;flex:1}
.tabs{display:flex;gap:10px}
.tabs button{border:0;background:#fff;color:#000;padding:8px 14px;border-radius:12px;font-weight:600}
.tabs button[aria-pressed="true"]{background:#d6f5e8}
main{padding:14px}
.card{background:var(--panel);border-radius:12px;padding:14px;margin:12px 0;border:1px solid #e6e6e6}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.controls{display:flex;flex-wrap:wrap;gap:10px}
button,.btn{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
button.primary{background:var(--brand);color:#fff}
button.gray{background:#efefef}
button.danger{background:var(--danger);color:#fff}
.badge{background:#eef;color:#246;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px}
small.muted{color:var(--muted)}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:8px}
th{font-size:13px;color:#333;text-align:left}
td{background:#fff;border:1px solid #eee}
td:first-child{border-radius:10px 0 0 10px}
td:last-child{border-radius:0 10px 10px 0}
input[type="text"],input[type="number"],input[type="date"],select{
  width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:16px;
}
/* amounts readable on phone */
.amount input{width:130px}
.qty input{width:90px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.summary{display:flex;gap:14px;flex-wrap:wrap}
summary-card{display:inline-block}
.kpi{background:#fff;border:1px solid #eee;border-radius:10px;padding:10px 12px;min-width:120px}
.kpi .val{font-weight:800;font-size:18px}
hr.sep{border:0;border-top:1px dashed #ddd;margin:10px 0}
.notice{background:#fffaf0;border:1px dashed #f2c27d;padding:10px 12px;border-radius:10px;color:#5a4b2e}
.footer{padding:30px 0 60px}
</style>
</head>
<body>
<header>
  <img src="assets/ladder.svg" alt="Ladder">
  <h1>Ladder App</h1>
  <div class="tabs">
    <button id="tabLadders" aria-pressed="true">Ladders</button>
    <button id="tabCharts" aria-pressed="false">Charts</button>
  </div>
</header>
<main>
  <section id="viewLadders">
    <div class="card">
      <h2>Add / Replace Asset</h2>
      <div class="row">
        <div>
          <label>Ticker / Name</label>
          <input id="inTicker" placeholder="e.g., RIOT or COIN">
        </div>
        <div>
          <label>Rungs</label>
          <select id="inRungs">
            <option value="2">2 rungs</option>
            <option value="3" selected>3 rungs</option>
            <option value="4">4 rungs</option>
          </select>
        </div>
        <div>
          <label>Start Price</label>
          <input id="inStartPrice" type="number" inputmode="decimal" step="0.01" placeholder="current price">
        </div>
        <div>
          <label>Default Shares per row</label>
          <input id="inDefShares" type="number" inputmode="decimal" step="1" value="1">
        </div>
      </div>
      <div class="notice" style="margin-top:10px">
        <b>Presets (locked)</b>: Sell +2.5%, +4.5%, +7%, +10% (first 2–4 based on selection). 
        Buyback 1%, 2.5%, 3.5%, 5% (rungs 1–4). 20 cycles.
        <b>Row&nbsp;1 Planned Buy equals Start Price</b>; then each next row uses: 
        <code>nextBuy = prevSell × (1 − buyback%)</code> and <code>sell = buy × (1 + sell%)</code>.
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="btnAddReplace" class="primary">+ Add / Replace Asset</button>
        <button id="btnSaveJSON" class="gray">Save Backup (JSON)</button>
        <button id="btnLoadJSON" class="gray">Restore Backup (JSON)</button>
        <button id="btnExportAll" class="gray">Export CSV (Excel)</button>
        <button id="btnClearAll" class="danger">Clear All (this device)</button>
      </div>
    </div>

    <div class="card">
      <div class="summary">
        <div class="kpi"><div>Realized P/L (closed)</div><div class="val" id="kpiRealized">$0.00</div></div>
        <div class="kpi"><div># of Assets</div><div class="val" id="kpiAssets">0</div></div>
        <div class="kpi"><div>Open Rows</div><div class="val" id="kpiOpen">0</div></div>
        <div class="kpi"><div>Closed Rows</div><div class="val" id="kpiClosed">0</div></div>
      </div>
    </div>

    <div id="assetsWrap"></div>
    <div class="footer"></div>
  </section>

  <section id="viewCharts" style="display:none">
    <div class="card">
      <h2>Totals & Charts</h2>
      <p class="notice">Chart is based on rows that have a <b>Sell Date</b> entered. Each row's realized P/L is 
      <code>(plannedSell − plannedBuy) × qty</code> on that date.</p>
      <div class="row">
        <div>
          <label>From</label>
          <input type="date" id="fromDate">
        </div>
        <div>
          <label>To</label>
          <input type="date" id="toDate">
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="btnUpdateChart" class="primary">Update Chart</button>
      </div>
      <h3 id="totalsLine" style="margin-top:12px">Total: $0.00</h3>
      <canvas id="plChart" height="200"></canvas>
    </div>
  </section>
</main>

<!-- Template for each asset block -->
<template id="assetTemplate">
  <div class="card asset">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <h3 style="margin:0"><span data-ticker>—</span></h3>
      <span class="badge" data-rungs></span>
      <span class="badge" data-start></span>
      <span class="badge" data-realized="$0.00"></span>
    </div>
    <div class="actions" style="margin-top:8px">
      <button class="primary" data-act="build">Build Ladder</button>
      <button class="gray" data-act="csv">Export CSV</button>
      <button class="danger" data-act="delete">Delete Ladder</button>
    </div>
    <div class="notice" style="margin-top:10px">Rungs use locked defaults: Sell +2.5%, +4.5%, +7%, +10% • Buyback 1%, 2.5%, 3.5%, 5% • 20 cycles. Edit any cell inline.</div>

    <!-- 4 rung tables; show as needed -->
    <div data-rung style="display:none;margin-top:12px">
      <h4 style="margin:4px 0">Rung 1 <span class="badge">Sell +2.5% • Buyback 1%</span></h4>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th style="width:40px">#</th>
            <th class="amount">Planned Buy</th>
            <th class="amount">Planned Sell</th>
            <th>Profit/Share</th>
            <th class="qty">Planned Shares</th>
            <th>Planned Total</th>
            <th>Buy Date</th>
            <th>Sell Date</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div data-rung style="display:none;margin-top:12px">
      <h4 style="margin:4px 0">Rung 2 <span class="badge">Sell +4.5% • Buyback 2.5%</span></h4>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th style="width:40px">#</th>
            <th class="amount">Planned Buy</th>
            <th class="amount">Planned Sell</th>
            <th>Profit/Share</th>
            <th class="qty">Planned Shares</th>
            <th>Planned Total</th>
            <th>Buy Date</th>
            <th>Sell Date</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div data-rung style="display:none;margin-top:12px">
      <h4 style="margin:4px 0">Rung 3 <span class="badge">Sell +7% • Buyback 3.5%</span></h4>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th style="width:40px">#</th>
            <th class="amount">Planned Buy</th>
            <th class="amount">Planned Sell</th>
            <th>Profit/Share</th>
            <th class="qty">Planned Shares</th>
            <th>Planned Total</th>
            <th>Buy Date</th>
            <th>Sell Date</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div data-rung style="display:none;margin-top:12px">
      <h4 style="margin:4px 0">Rung 4 <span class="badge">Sell +10% • Buyback 5%</span></h4>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th style="width:40px">#</th>
            <th class="amount">Planned Buy</th>
            <th class="amount">Planned Sell</th>
            <th>Profit/Share</th>
            <th class="qty">Planned Shares</th>
            <th>Planned Total</th>
            <th>Buy Date</th>
            <th>Sell Date</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// === LOGIC START ===

// presets
const SELL_PRESETS   = [0.025, 0.045, 0.07, 0.10];
const BUYBACK_PRESETS= [0.01,  0.025, 0.035, 0.05];
const CYCLES = 20;
const LS_ASSETS_KEY = 'ladder_assets_v3';
const round2=n=>Math.round(n*100)/100;
const fmt=n => isNaN(n)?'':round2(n).toFixed(2);

// storage helpers
function loadAssets(){try{return JSON.parse(localStorage.getItem(LS_ASSETS_KEY))||[]}catch{return []}}
function saveAssets(list){localStorage.setItem(LS_ASSETS_KEY, JSON.stringify(list))}

// build rows for a rung
function buildRows(startPrice, sellPct, buybackPct, cycles=CYCLES){
  const rows=[]; let buy=+startPrice;
  for(let i=1;i<=cycles;i++){
    const sell=round2(buy*(1+sellPct));
    const profit=round2(sell-buy);
    rows.push({cycle:i, plannedBuy:buy, plannedSell:sell, profitPerShare:profit});
    buy=round2(sell*(1-buybackPct));
  }
  return rows;
}

// upsert asset
function upsertAsset({ticker,startPrice,rungs,defShares}){
  const list=loadAssets();
  const i=list.findIndex(a=>a.ticker.toLowerCase()==ticker.toLowerCase());
  const rec={ticker,startPrice:+startPrice,rungs:+rungs,defShares:+defShares,edits:list[i]?.edits||{}};
  if(i>=0) list[i]=rec; else list.push(rec);
  saveAssets(list);
  return rec;
}

// render rung rows into a table (tbody)
function renderRows(tbody, rows, editsForRung, defShares, assetKey, rungIdx){
  tbody.innerHTML='';
  for(let r=0;r<rows.length;r++){
    const row=rows[r];
    const ed=(editsForRung && editsForRung[r+1])||{}; // keyed by 1-based index
    const qty=ed.qty ?? defShares;
    const buyDate=ed.buyDate || '';
    const sellDate=ed.sellDate || '';
    const plannedTotal=round2(row.profitPerShare*(+qty||0));

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="width:40px;text-align:center">${row.cycle}</td>
      <td class="amount"><input data-asset="${assetKey}" data-rung="${rungIdx}" data-row="${row.cycle}" data-field="buy" type="number" step="0.01" value="${fmt(row.plannedBuy)}"></td>
      <td class="amount"><input data-asset="${assetKey}" data-rung="${rungIdx}" data-row="${row.cycle}" data-field="sell" type="number" step="0.01" value="${fmt(row.plannedSell)}"></td>
      <td>$${fmt(row.profitPerShare)}</td>
      <td class="qty"><input data-asset="${assetKey}" data-rung="${rungIdx}" data-row="${row.cycle}" data-field="qty" type="number" step="1" value="${qty}"></td>
      <td>$${fmt(plannedTotal)}</td>
      <td><input data-asset="${assetKey}" data-rung="${rungIdx}" data-row="${row.cycle}" data-field="buyDate" type="date" value="${buyDate}"></td>
      <td><input data-asset="${assetKey}" data-rung="${rungIdx}" data-row="${row.cycle}" data-field="sellDate" type="date" value="${sellDate}"></td>
    `;
    tbody.appendChild(tr);
  }
}

// compute aggregate KPIs + per-asset realized total
function computeKPIs(){
  const list=loadAssets();
  let open=0, closed=0, realized=0;
  list.forEach(a=>{
    for(let r=0;r<a.rungs;r++){
      const rows=buildRows(a.startPrice, SELL_PRESETS[r], BUYBACK_PRESETS[r], CYCLES);
      const edits=a.edits?.[r] || {}; // we store by 0-based rung
      rows.forEach(row=>{
        const e=edits[row.cycle]||{};
        const qty=+(e.qty ?? a.defShares);
        const isClosed = !!e.sellDate;
        if(isClosed){closed++; realized += (row.plannedSell-row.plannedBuy) * (qty||0);}
        else open++;
      });
    }
  });
  document.getElementById('kpiAssets').textContent = String(list.length);
  document.getElementById('kpiOpen').textContent   = String(open);
  document.getElementById('kpiClosed').textContent = String(closed);
  document.getElementById('kpiRealized').textContent = '$'+fmt(realized);
}

// rebuild all assets UI
function rebuildAll(){
  const wrap=document.getElementById('assetsWrap');
  wrap.innerHTML='';
  const list=loadAssets();
  list.forEach((asset, aidx)=>{
    const {ticker,startPrice,rungs,defShares}=asset;
    const frag=document.getElementById('assetTemplate').content.cloneNode(true);
    const card=frag.querySelector('.asset');
    frag.querySelector('[data-ticker]').textContent=ticker;
    frag.querySelector('[data-start]').textContent='$'+fmt(startPrice);
    frag.querySelector('[data-rungs]').textContent=`${rungs} rung(s)`;
    const rungDivs=frag.querySelectorAll('[data-rung]');

    // actions
    frag.querySelector('[data-act="delete"]').addEventListener('click', ()=>{
      const list=loadAssets().filter(a=>a.ticker!==ticker);
      saveAssets(list); rebuildAll();
    });
    frag.querySelector('[data-act="csv"]').addEventListener('click', ()=>exportCSV([asset]));
    frag.querySelector('[data-act="build"]').addEventListener('click', ()=>{
      // just recompute & rerender
      rebuildAll();
    });

    for(let r=0;r<rungs && r<4;r++){
      const d=rungDivs[r]; d.style.display='';
      const rows=buildRows(startPrice, SELL_PRESETS[r], BUYBACK_PRESETS[r], CYCLES);
      const tbody=d.querySelector('tbody');
      renderRows(tbody, rows, asset.edits?.[r], defShares, ticker, r);
    }

    wrap.appendChild(frag);
  });

  computeKPIs();
}

// save inline edits (qty/dates); keep planned buy/sell read-only calc but if user edits, we persist too
document.addEventListener('input', (ev)=>{
  const el=ev.target;
  if(!el.dataset || !el.dataset.asset) return;
  const assetKey=el.dataset.asset;
  const rung=+el.dataset.rung;
  const row=+el.dataset.row;
  const field=el.dataset.field;
  const val=el.value;

  const list=loadAssets();
  const a = list.find(x => x.ticker===assetKey);
  if(!a) return;
  a.edits = a.edits || {};
  a.edits[rung] = a.edits[rung] || {};
  a.edits[rung][row] = a.edits[rung][row] || {};
  a.edits[rung][row][field] = val;
  saveAssets(list);
  computeKPIs();
});

// export CSV for all or subset
function exportCSV(subset){
  const list = subset || loadAssets();
  const rows=[['Ticker','Rung','Row','#','Planned Buy','Planned Sell','Profit/Share','Qty','Planned Total','Buy Date','Sell Date']];
  list.forEach(a=>{
    for(let r=0;r<a.rungs;r++){
      const calc = buildRows(a.startPrice, SELL_PRESETS[r], BUYBACK_PRESETS[r], CYCLES);
      const edits=a.edits?.[r]||{};
      calc.forEach(rec=>{
        const e=edits[rec.cycle]||{};
        const qty=+(e.qty ?? a.defShares);
        const total=round2(rec.profitPerShare*(qty||0));
        rows.push([a.ticker, r+1, rec.cycle, rec.cycle, fmt(rec.plannedBuy), fmt(rec.plannedSell), fmt(rec.profitPerShare), qty, fmt(total), e.buyDate||'', e.sellDate||'']);
      });
    }
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='ladder_export.csv';
  a.click();
}

// backup/restore
document.getElementById('btnSaveJSON').addEventListener('click', ()=>{
  const data = JSON.stringify(loadAssets());
  const a=document.createElement('a');
  a.href='data:application/json,'+encodeURIComponent(data);
  a.download='ladder_backup.json';
  a.click();
});
document.getElementById('btnLoadJSON').addEventListener('click', async ()=>{
  const inp=document.createElement('input');
  inp.type='file'; inp.accept='.json,application/json';
  inp.onchange=()=>{
    const f=inp.files[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=()=>{ try{ saveAssets(JSON.parse(rd.result)); rebuildAll(); }catch(e){ alert('Invalid JSON'); } };
    rd.readAsText(f);
  };
  inp.click();
});
document.getElementById('btnExportAll').addEventListener('click', ()=>exportCSV());
document.getElementById('btnClearAll').addEventListener('click', ()=>{
  if(confirm('Clear all data on this device?')){ localStorage.removeItem(LS_ASSETS_KEY); rebuildAll(); }
});

// tabs
const tabL = document.getElementById('tabLadders');
const tabC = document.getElementById('tabCharts');
tabL.addEventListener('click', ()=>{ tabL.setAttribute('aria-pressed','true'); tabC.setAttribute('aria-pressed','false'); document.getElementById('viewLadders').style.display=''; document.getElementById('viewCharts').style.display='none'; });
tabC.addEventListener('click', ()=>{ tabC.setAttribute('aria-pressed','true'); tabL.setAttribute('aria-pressed','false'); document.getElementById('viewCharts').style.display=''; document.getElementById('viewLadders').style.display='none'; buildChart(); });

// Add/Replace Asset
function wireForm(){
  const btn=document.getElementById('btnAddReplace');
  if(!btn || btn.dataset.wired) return;
  btn.dataset.wired='1';
  btn.addEventListener('click',(e)=>{
    e.preventDefault();
    const t=(document.getElementById('inTicker').value||'').trim();
    const sp=parseFloat(document.getElementById('inStartPrice').value);
    const rg=parseInt(document.getElementById('inRungs').value,10);
    const ds=parseFloat(document.getElementById('inDefShares').value)||1;
    if(!t || isNaN(sp)){ alert('Enter a ticker and a valid start price.'); return; }
    upsertAsset({ticker:t,startPrice:sp,rungs:Math.min(Math.max(rg,2),4),defShares:ds});
    rebuildAll();
  });
}
wireForm();

// KPIs + initial render
rebuildAll();

// Chart building
let chart;
function buildChart(){
  const list=loadAssets();
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  const start = from ? new Date(from) : null;
  const end   = to ? new Date(to)   : null;

  // accumulate by YYYY-MM
  const buckets = {};
  list.forEach(a=>{
    for(let r=0;r<a.rungs;r++){
      const calc = buildRows(a.startPrice, SELL_PRESETS[r], BUYBACK_PRESETS[r], CYCLES);
      const edits=a.edits?.[r]||{};
      calc.forEach(rec=>{
        const e=edits[rec.cycle]||{};
        if(!e.sellDate) return;
        const d=new Date(e.sellDate);
        if(start && d<start) return;
        if(end && d>end) return;
        const k=d.toISOString().slice(0,7);
        const qty=+(e.qty ?? a.defShares);
        const pl=(rec.plannedSell-rec.plannedBuy)*(qty||0);
        buckets[k]=(buckets[k]||0)+pl;
      });
    }
  });
  const labels=Object.keys(buckets).sort();
  const data=labels.map(k=>Math.round(buckets[k]*100)/100);
  document.getElementById('totalsLine').textContent='Total: $'+fmt(data.reduce((a,b)=>a+b,0));

  const ctx=document.getElementById('plChart').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Realized P/L',data}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
}
document.getElementById('btnUpdateChart').addEventListener('click',buildChart);

// === LOGIC END ===
</script>
</body>
</html>
