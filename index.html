<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App</title>
<meta name="theme-color" content="#0a7">
<link rel="icon" href="assets/ladder.svg">
<style>
:root{--brand:#0a7;--fg:#111;--bg:#f7f7f7;--panel:#fff;--muted:#667;--danger:#c33}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.35 -apple-system,system-ui,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
header img{width:28px;height:28px} header h1{font-size:20px;margin:0;flex:1}
.tabs{display:flex;gap:10px} .tabs button{border:0;background:#fff;color:#000;padding:8px 14px;border-radius:12px;font-weight:600}
.tabs button[aria-pressed="true"]{background:#d6f5e8}
main{padding:14px}
.card{background:var(--panel);border-radius:12px;padding:14px;margin:12px 0;border:1px solid #e6e6e6}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input[type="text"],input[type="number"],input[type="date"],select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:16px}
button{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
button.primary{background:var(--brand);color:#fff} button.gray{background:#efefef} button.danger{background:var(--danger);color:#fff}
.badge{background:#eef;color:#246;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px}
.notice{background:#fffaf0;border:1px dashed #f2c27d;padding:10px 12px;border-radius:10px;color:#5a4b2e}
/* table */
table{width:100%;border-collapse:separate;border-spacing:0 8px} th,td{padding:8px}
th{font-size:13px;color:#333;text-align:left} td{background:#fff;border:1px solid #eee}
td:first-child{border-radius:10px 0 0 10px} td:last-child{border-radius:0 10px 10px 0}
.amount input{width:130px} .qty input{width:90px}
/* accordion */
.assetHead{display:flex;align-items:center;gap:10px;cursor:pointer}
.assetHead .title{display:flex;align-items:center;gap:8px;flex:1;font-weight:700}
.chev{transition:transform .2s ease} .collapsed .chev{transform:rotate(-90deg)}
.assetBody{display:none;margin-top:10px}
.asset.open .assetBody{display:block}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpiBox{display:flex;gap:14px;flex-wrap:wrap}
.kpi{background:#fff;border:1px solid #eee;border-radius:10px;padding:10px 12px;min-width:120px}
.kpi .val{font-weight:800;font-size:18px}
hr.sep{border:0;border-top:1px dashed #ddd;margin:10px 0}
</style>
</head>
<body>
<header>
  <img src="assets/ladder.svg" alt="Ladder"><h1>Ladder App</h1>
  <div class="tabs">
    <button id="tabLadders" aria-pressed="true">Ladders</button>
    <button id="tabCharts" aria-pressed="false">Charts</button>
  </div>
</header>
<main>
  <section id="viewLadders">
    <div class="card">
      <h2>Add / Replace Asset</h2>
      <div class="row">
        <div><label>Ticker / Name</label><input id="inTicker" placeholder="e.g., RIOT or COIN"></div>
        <div><label>Rungs</label><select id="inRungs"><option value="2">2 rungs</option><option value="3" selected>3 rungs</option><option value="4">4 rungs</option></select></div>
        <div><label>Start Price</label><input id="inStartPrice" type="number" inputmode="decimal" step="0.01" placeholder="current price"></div>
        <div><label>Default Shares per row</label><input id="inDefShares" type="number" inputmode="decimal" step="1" value="1"></div>
      </div>
      <div class="notice" style="margin-top:10px">
        <b>Presets (locked)</b>: Sell +2.5%, +4.5%, +7%, +10% (first 2–4). Buyback 1%, 2.5%, 3.5%, 5% (rungs 1–4). 20 cycles.
        <b>Row 1 Planned Buy = Start Price</b>. Next rows: <code>sell = buy × (1 + sell%)</code> then <code>nextBuy = sell × (1 − buyback%)</code>.
      </div>
      <div class="actions">
        <button id="btnAddReplace" class="primary">+ Add / Replace Asset</button>
        <button id="btnSaveJSON" class="gray">Save Backup (JSON)</button>
        <button id="btnLoadJSON" class="gray">Restore Backup (JSON)</button>
        <button id="btnExportAll" class="gray">Export CSV (Excel)</button>
        <button id="btnClearAll" class="danger">Clear All (this device)</button>
      </div>
    </div>

    <div class="card">
      <div class="kpiBox">
        <div class="kpi"><div>Realized P/L (closed)</div><div class="val" id="kpiRealized">$0.00</div></div>
        <div class="kpi"><div># of Assets</div><div class="val" id="kpiAssets">0</div></div>
        <div class="kpi"><div>Open Rows</div><div class="val" id="kpiOpen">0</div></div>
        <div class="kpi"><div>Closed Rows</div><div class="val" id="kpiClosed">0</div></div>
      </div>
    </div>

    <div id="assetsWrap"></div>
  </section>

  <section id="viewCharts" style="display:none">
    <div class="card">
      <h2>Totals & Charts</h2>
      <p class="notice">Chart uses rows that have a <b>Sell Date</b> entered.</p>
      <div class="row">
        <div><label>From</label><input type="date" id="fromDate"></div>
        <div><label>To</label><input type="date" id="toDate"></div>
      </div>
      <div class="actions"><button id="btnUpdateChart" class="primary">Update Chart</button></div>
      <h3 id="totalsLine" style="margin-top:12px">Total: $0.00</h3>
      <canvas id="plChart" height="200"></canvas>
    </div>
  </section>
</main>

<template id="assetTemplate">
  <div class="card asset collapsed">
    <div class="assetHead" data-role="toggle">
      <div class="chev">▶</div>
      <div class="title"><span data-ticker>—</span><span class="badge" data-rungs></span><span class="badge" data-start></span></div>
      <div class="badge" data-realized>$0.00 realized</div>
    </div>
    <div class="assetBody">
      <div class="actions">
        <button class="primary" data-act="build">Build Ladder</button>
        <button class="gray" data-act="csv">Export CSV</button>
        <button class="danger" data-act="delete">Delete Ladder</button>
      </div>
      <div class="notice" style="margin-top:10px">Defaults: Sell +2.5%, +4.5%, +7%, +10% • Buyback 1%, 2.5%, 3.5%, 5% • 20 cycles.</div>
      <div data-rung style="display:none;margin-top:12px">
        <h4>Rung 1 <span class="badge">Sell +2.5% • Buyback 1%</span></h4>
        <table>
          <thead><tr><th>#</th><th class="amount">Planned Buy</th><th class="amount">Planned Sell</th><th>Profit/Share</th><th class="qty">Planned Shares</th><th>Planned Total</th><th>Buy Date</th><th>Sell Date</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div data-rung style="display:none;margin-top:12px">
        <h4>Rung 2 <span class="badge">Sell +4.5% • Buyback 2.5%</span></h4>
        <table>
          <thead><tr><th>#</th><th class="amount">Planned Buy</th><th class="amount">Planned Sell</th><th>Profit/Share</th><th class="qty">Planned Shares</th><th>Planned Total</th><th>Buy Date</th><th>Sell Date</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div data-rung style="display:none;margin-top:12px">
        <h4>Rung 3 <span class="badge">Sell +7% • Buyback 3.5%</span></h4>
        <table>
          <thead><tr><th>#</th><th class="amount">Planned Buy</th><th class="amount">Planned Sell</th><th>Profit/Share</th><th class="qty">Planned Shares</th><th>Planned Total</th><th>Buy Date</th><th>Sell Date</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div data-rung style="display:none;margin-top:12px">
        <h4>Rung 4 <span class="badge">Sell +10% • Buyback 5%</span></h4>
        <table>
          <thead><tr><th>#</th><th class="amount">Planned Buy</th><th class="amount">Planned Sell</th><th>Profit/Share</th><th class="qty">Planned Shares</th><th>Planned Total</th><th>Buy Date</th><th>Sell Date</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* === Logic === */
const SELL = [0.025,0.045,0.07,0.10], BUYBK=[0.01,0.025,0.035,0.05], CYCLES=20, KEY='ladder_assets_v3_1';
const $=s=>document.querySelector(s), round2=n=>Math.round(n*100)/100, fmt=n=>isNaN(n)?'':round2(n).toFixed(2);
function load(){try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]}} function save(list){localStorage.setItem(KEY,JSON.stringify(list))}
function calcRows(start,sell,buybk){const rows=[];let buy=+start;for(let i=1;i<=CYCLES;i++){const sellP=round2(buy*(1+sell)),pps=round2(sellP-buy);rows.push({i,buy:buy,sell:sellP,pps});buy=round2(sellP*(1-buybk))}return rows}
function upsert({ticker,startPrice,rungs,defShares}){const list=load();const i=list.findIndex(a=>a.ticker.toLowerCase()==ticker.toLowerCase());const rec={ticker,startPrice:+startPrice,rungs:+rungs,defShares:+defShares,edits:list[i]?.edits||{}};if(i>=0)list[i]=rec;else list.push(rec);save(list);return rec}

function render(){
  const wrap=$("#assetsWrap"); wrap.innerHTML=''; const list=load();
  list.forEach((a,ai)=>{
    const frag=$("#assetTemplate").content.cloneNode(true);
    const card=frag.querySelector('.asset'); card.id='asset-'+a.ticker;
    frag.querySelector('[data-ticker]').textContent=a.ticker;
    frag.querySelector('[data-start]').textContent='$'+fmt(a.startPrice);
    frag.querySelector('[data-rungs]').textContent=`${a.rungs} rung(s)`;

    // accordion toggle
    const head=frag.querySelector('[data-role="toggle"]');
    head.addEventListener('click',()=>{
      document.querySelectorAll('.asset').forEach(el=>{el.classList.remove('open'); el.classList.add('collapsed');});
      card.classList.toggle('open');
      card.classList.toggle('collapsed');
    });

    // build rung tables
    const rungDivs=frag.querySelectorAll('[data-rung]');
    for(let r=0;r<a.rungs && r<4;r++){
      const d=rungDivs[r]; d.style.display='';
      const rows=calcRows(a.startPrice, SELL[r], BUYBK[r]);
      const tb=d.querySelector('tbody'); tb.innerHTML='';
      for(const row of rows){
        const tr=document.createElement('tr');
        const qty=(a.edits?.[r]?.[row.i]?.qty ?? a.defShares);
        const buyDate=a.edits?.[r]?.[row.i]?.buyDate || '';
        const sellDate=a.edits?.[r]?.[row.i]?.sellDate || '';
        const total=round2(row.pps*(+qty||0));
        tr.innerHTML=`
          <td>${row.i}</td>
          <td class="amount"><input data-a="${a.ticker}" data-r="${r}" data-i="${row.i}" data-k="buy" type="number" step="0.01" value="${fmt(row.buy)}"></td>
          <td class="amount"><input data-a="${a.ticker}" data-r="${r}" data-i="${row.i}" data-k="sell" type="number" step="0.01" value="${fmt(row.sell)}"></td>
          <td>$${fmt(row.pps)}</td>
          <td class="qty"><input data-a="${a.ticker}" data-r="${r}" data-i="${row.i}" data-k="qty" type="number" step="1" value="${qty}"></td>
          <td>$${fmt(total)}</td>
          <td><input data-a="${a.ticker}" data-r="${r}" data-i="${row.i}" data-k="buyDate" type="date" value="${buyDate}"></td>
          <td><input data-a="${a.ticker}" data-r="${r}" data-i="${row.i}" data-k="sellDate" type="date" value="${sellDate}"></td>`;
        tb.appendChild(tr);
      }
    }

    // actions
    frag.querySelector('[data-act="delete"]').addEventListener('click',()=>{
      if(!confirm('Delete this ladder?'))return; const list=load().filter(x=>x.ticker!==a.ticker); save(list); render();
    });
    frag.querySelector('[data-act="csv"]').addEventListener('click',()=>{
      exportCSV([a]);
    });
    frag.querySelector('[data-act="build"]').addEventListener('click',()=>{
      render();
    });

    wrap.appendChild(frag);
  });

  // KPIs
  let realized=0, open=0, closed=0;
  load().forEach(a=>{
    for(let r=0;r<a.rungs;r++){
      const rows=calcRows(a.startPrice,SELL[r],BUYBK[r]);
      rows.forEach(row=>{
        const ed=a.edits?.[r]?.[row.i]||{};
        const qty=+(ed.qty ?? a.defShares);
        if(ed.sellDate){ closed++; realized += (row.sell-row.buy)*(qty||0); } else { open++; }
      });
    }
  });
  $("#kpiAssets").textContent=String(load().length);
  $("#kpiOpen").textContent=String(open);
  $("#kpiClosed").textContent=String(closed);
  $("#kpiRealized").textContent='$'+fmt(realized);
}

document.addEventListener('input', (e)=>{
  const t=e.target; const a=t.dataset.a; if(!a) return;
  const list=load(); const asset=list.find(x=>x.ticker===a); if(!asset) return;
  const r=+t.dataset.r, i=+t.dataset.i, k=t.dataset.k, v=t.type==='date'?t.value:+t.value;
  asset.edits=asset.edits||{}; asset.edits[r]=asset.edits[r]||{}; asset.edits[r][i]=asset.edits[r][i]||{}; asset.edits[r][i][k]=v;
  save(list);
  // update totals on the fly
  let realized=0, open=0, closed=0;
  list.forEach(a=>{for(let rr=0;rr<a.rungs;rr++){const rows=calcRows(a.startPrice,SELL[rr],BUYBK[rr]);rows.forEach(row=>{const ed=a.edits?.[rr]?.[row.i]||{};const qty=+(ed.qty ?? a.defShares); if(ed.sellDate){closed++; realized+=(row.sell-row.buy)*(qty||0);} else open++;});}});
  $("#kpiOpen").textContent=String(open); $("#kpiClosed").textContent=String(closed); $("#kpiRealized").textContent='$'+fmt(realized);
});

// Add/Replace
document.getElementById('btnAddReplace').addEventListener('click',()=>{
  const t=($('#inTicker').value||'').trim(); const r=parseInt($('#inRungs').value,10); const sp=parseFloat($('#inStartPrice').value); const ds=parseFloat($('#inDefShares').value)||1;
  if(!t||!isFinite(sp)){alert('Enter ticker and a valid start price.');return;}
  upsert({ticker:t,startPrice:sp,rungs:Math.min(Math.max(r,2),4),defShares:ds});
  render();
});

// Export / Backup / Restore / Clear
function exportCSV(subset){
  const list=subset || load(); const rows=[['Ticker','Rung','#','Planned Buy','Planned Sell','Profit/Share','Qty','Planned Total','Buy Date','Sell Date']];
  list.forEach(a=>{for(let r=0;r<a.rungs;r++){const calc=calcRows(a.startPrice,SELL[r],BUYBK[r]);const edits=a.edits?.[r]||{};calc.forEach(rec=>{const e=edits[rec.i]||{};const qty=+(e.qty ?? a.defShares);const total=round2(rec.pps*(qty||0));rows.push([a.ticker,r+1,rec.i,fmt(rec.buy),fmt(rec.sell),fmt(rec.pps),qty,fmt(total),e.buyDate||'',e.sellDate||''])})}});
  const csv=rows.map(r=>r.join(',')).join('\n'); const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='ladder_export.csv'; a.click();
}
document.getElementById('btnExportAll').addEventListener('click',()=>exportCSV());
document.getElementById('btnSaveJSON').addEventListener('click',()=>{const a=document.createElement('a');a.href='data:application/json,'+encodeURIComponent(JSON.stringify(load()));a.download='ladder_backup.json';a.click();});
document.getElementById('btnLoadJSON').addEventListener('click',()=>{const i=document.createElement('input');i.type='file';i.accept='.json,application/json';i.onchange=()=>{const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{save(JSON.parse(r.result));render();}catch(e){alert('Invalid JSON');}};r.readAsText(f)};i.click();});
document.getElementById('btnClearAll').addEventListener('click',()=>{if(confirm('Clear all data on this device?')){localStorage.removeItem(KEY);render();}});

// Tabs
const tabL=$("#tabLadders"), tabC=$("#tabCharts");
tabL.addEventListener('click',()=>{tabL.setAttribute('aria-pressed','true');tabC.setAttribute('aria-pressed','false');$("#viewLadders").style.display='';$("#viewCharts").style.display='none';});
tabC.addEventListener('click',()=>{tabC.setAttribute('aria-pressed','true');tabL.setAttribute('aria-pressed','false');$("#viewLadders").style.display='none';$("#viewCharts").style.display='';});

// Initial render
render();
</script>
</body>
</html>
