<!doctype html><meta charset='utf-8'><title>fallback</title><p>Base app missing.</p>
<!-- ===== Ladder+Totals addon ===== -->
<div id="addon_totals_panel" style="position:relative;z-index:1;margin:12px">
  <div style="background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:12px">
    <h2 style="margin:6px 0 10px;font-size:18px">Portfolio Totals & Chart</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center">
      <div><b>Overall Realized:</b> <span id="addon_overall">$0.00</span></div>
      <div>From <input type="date" id="addon_from"> to <input type="date" id="addon_to">
        <button id="addon_update">Update Chart</button></div>
      <div>Year <input type="number" id="addon_year" value="2025">
        <button id="addon_year_btn">Year Total</button>
        <span id="addon_year_total"></span></div>
    </div>
    <div style="margin-top:10px"><canvas id="addon_chart" height="140"></canvas></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  function $$(sel,root){ return Array.from((root||document).querySelectorAll(sel)); }
  function asNum(s){ if(!s) return 0; return parseFloat(String(s).replace(/[^0-9.\-]/g,''))||0; }
  function money(n){ return (isFinite(n)?n:0).toFixed(2); }

  // Try to read realized rows from any ladder tables in the page:
  function gatherEntries(){
    const out=[];
    $$('table').forEach(t=>{
      const rows=$$('tbody tr',t);
      rows.forEach(tr=>{
        const tds=tr.children;
        if(tds.length<14) return;
        const sellDateInput = tds[7]?.querySelector('input[type="date"]');
        const aBuy = asNum(tds[8]?.textContent);
        const aSell= asNum(tds[9]?.textContent);
        const qty  = parseInt((tds[10]?.textContent||'').replace(/[^0-9\-]/g,''))||0;
        const date = sellDateInput? sellDateInput.value : '';
        if(date && (aBuy||aSell) && qty){
          out.push({date,aBuy,aSell,qty, pl:(aSell-aBuy)*qty});
        }
      });
    });
    return out;
  }

  function overall(){ return gatherEntries().reduce((s,e)=>s+e.pl,0); }
  function renderTotals(){ document.getElementById('addon_overall').textContent = '$'+money(overall()); }

  // chart
  let chart;
  function updateChart(){
    const from = document.getElementById('addon_from').value;
    const to   = document.getElementById('addon_to').value;
    const data = gatherEntries().filter(e=>(!from||e.date>=from)&&(!to||e.date<=to)).sort((a,b)=>a.date<b.date?-1:1);
    const labels = data.map(e=>e.date);
    const values = data.map(e=>e.pl);
    const ctx = document.getElementById('addon_chart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{label:'Realized P/L', data:values}] }, options:{ scales:{ y:{ beginAtZero:true } } } });
  }

  function yearTotal(){
    const y = String(document.getElementById('addon_year').value||'');
    const total = gatherEntries().filter(e=>e.date.startsWith(y)).reduce((s,e)=>s+e.pl,0);
    document.getElementById('addon_year_total').textContent = 'Total: $'+money(total);
  }

  document.getElementById('addon_update').addEventListener('click', updateChart);
  document.getElementById('addon_year_btn').addEventListener('click', yearTotal);

  // initial
  setTimeout(function(){ renderTotals(); updateChart(); }, 300);
})();
</script>
<!-- ===== /addon ===== -->
