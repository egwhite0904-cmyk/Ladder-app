<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App â€” Fixed Save + Correct Rungs</title>
<style>
:root{--green:#0a7;--bg:#f7f7f7;--panel:#fff;--fg:#111;--muted:#777;--accent:#0a7}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
header{background:var(--green);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0}
header h1{font-size:18px;margin:0 8px 0 0}
header .tabs{margin-left:auto;display:flex;gap:8px}
.tabs button{background:#fff;color:#064;padding:8px 12px;border:0;border-radius:10px}
main{display:grid;grid-template-columns: minmax(260px, 420px) 1fr;gap:16px;padding:16px}
@media (max-width:900px){main{grid-template-columns: 1fr}}
.card{background:var(--panel);border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.card h2{margin:0;padding:12px 14px;border-bottom:1px solid #eee;font-size:15px}
.card .body{padding:12px 14px}
.row{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-bottom:10px}
.row label{font-size:12px;color:#444}
input,select,button{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font:inherit}
button.primary{background:var(--accent);color:#fff;border:0}
.badge{background:#eef;border:1px solid #dde;border-radius:999px;padding:2px 8px;font-size:12px}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #eee;padding:8px 6px;text-align:left;white-space:nowrap}
thead th{position:sticky;top:0;background:#fafafa;z-index:1}
.small{font-size:12px;color:#666}
.flex{display:flex;gap:8px;flex-wrap:wrap}
.notice{background:#fff7d6;border:1px solid #ffe9a4;padding:10px;border-radius:10px;color:#6b4e00}
hr.sep{border:0;border-top:1px dashed #e5e5e5;margin:12px 0}
footer{padding:12px;color:#888;text-align:center}
</style>
</head>
<body>
<header>
  <h1>ðŸ“ˆ Ladder App</h1>
  <div class="tabs">
    <button id="tabLadders" class="primary">Ladders</button>
    <button id="tabCharts">Charts</button>
  </div>
</header>
<main>
  <section class="card" id="inputsPanel">
    <h2>Add / Edit Asset</h2>
    <div class="body">
      <div class="row">
        <div>
          <label>Ticker / Name</label>
          <input id="ticker" placeholder="e.g., RIOT or CVS">
        </div>
        <div>
          <label>Rungs</label>
          <select id="rungCount">
            <option>2 Rungs</option>
            <option selected>3 Rungs</option>
            <option>4 Rungs</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Start Price</label>
          <input id="startPrice" type="number" step="0.01" placeholder="current price">
        </div>
        <div>
          <label>Default Shares per row</label>
          <input id="defaultShares" type="number" step="1" min="0" value="1">
        </div>
      </div>
      <div class="notice small">
        Rung sell % (locked): <b>2.5%</b>, <b>4.5%</b>, <b>7%</b>, <b>10%</b> (if 4th).<br>
        Rung buyback % (locked, relative to sell): <b>1%</b>, <b>2.5%</b>, <b>3.5%</b>, <b>6%</b> (if 4th).<br>
        Calculation for each rung row: <code>sell = start Ã— (1 + sell%)</code>, <code>buy = sell Ã— (1 âˆ’ buyback%)</code>. 20 cycles. You can edit any cell later.
      </div>
      <div class="flex">
        <button id="addAsset" class="primary">+ Add / Replace Asset</button>
        <button id="saveAll">Save</button>
        <button id="clearAll">Clear All (from this device)</button>
        <span class="small" id="saveStatus"></span>
      </div>
    </div>
  </section>

  <section class="card" id="laddersPanel">
    <h2>Your Ladders</h2>
    <div class="body" id="laddersContainer"></div>
  </section>

  <section class="card" id="chartsPanel" style="display:none;">
    <h2>Totals & Charts</h2>
    <div class="body">
      <div class="row">
        <div>
          <label>Year</label>
          <input id="yearInput" type="number" value="2025">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="yearTotal">Year Total</button>
        </div>
      </div>
      <div id="portfolioTotal" class="badge">Portfolio Total: $0.00</div>
      <canvas id="bar" width="600" height="280" style="max-width:100%;margin-top:10px;border:1px solid #eee;border-radius:8px;background:#fff"></canvas>
      <div class="small notice" style="margin-top:10px">
        Chart sums realized P/L using rows where <b>Sell Date</b> + <b>Actual Buy/Sell</b> + <b>Filled Qty</b> are entered.
      </div>
    </div>
  </section>
</main>
<footer>Data auto-saves to this device (localStorage). Avoid Private Browsing.</footer>

<script>
// ---- Locked defaults ----
const SELL_PCTS = [2.5, 4.5, 7.0, 10.0];
const BUYBACK_PCTS = [1.0, 2.5, 3.5, 6.0];
const CYCLES = 20;

// ---- App state ----
let app = {
  assets: []  // [{ticker,startPrice,rungs,defaultShares, rows: { [rungIndex]: Array(rows objects) } }]
};

// ---- Helpers ----
const $ = sel => document.querySelector(sel);
function fmt(n){ return '$'+Number(n).toFixed(2); }
function nowStr(){ const d=new Date(); return d.toLocaleTimeString(); }
function saveState(){
  localStorage.setItem('ladder_app_state_v2', JSON.stringify(app));
  $('#saveStatus').textContent = 'Saved '+nowStr();
}
function loadState(){
  const raw = localStorage.getItem('ladder_app_state_v2');
  if(!raw) return;
  try{ app = JSON.parse(raw) || app; }catch(e){}
}
function inPrivateSafari(){
  try{ localStorage.setItem('__t','1'); localStorage.removeItem('__t'); return false; } catch(e){ return true; }
}

// Price calcs (correct order)
function calcPrices(start, sellPct, buybackPct){
  const sell = +(start * (1 + sellPct/100)).toFixed(2);
  const buy  = +(sell  * (1 - buybackPct/100)).toFixed(2);
  return {sell, buy, profit:+(sell-buy).toFixed(2)};
}

function buildAssetCard(asset){
  const container = document.createElement('div');
  container.className = 'card';
  const hdr = document.createElement('h2');
  hdr.innerHTML = `${asset.ticker} <span class="badge">${asset.rungs} rung(s) â€¢ start ${fmt(asset.startPrice)}</span>`;
  container.appendChild(hdr);

  const body = document.createElement('div'); body.className='body'; container.appendChild(body);
  const hint = document.createElement('div'); hint.className='small';
  hint.textContent = 'Rungs use locked defaults. 20 cycles. Edit any cell inline.';
  body.appendChild(hint);

  for(let r=0;r<asset.rungs;r++){
    const sellPct = SELL_PCTS[r], buyPct = BUYBACK_PCTS[r];
    const {sell,buy,profit} = calcPrices(asset.startPrice, sellPct, buyPct);

    const title = document.createElement('div'); title.className='small';
    title.innerHTML = `<b>${asset.ticker} â€” Rung ${r+1}</b> â€¢ Sell +${sellPct}% â€¢ Buyback ${buyPct}%`;
    body.appendChild(title);

    const wrap = document.createElement('div'); wrap.className='table-wrap'; body.appendChild(wrap);
    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th>#</th>
          <th>Planned Buy</th>
          <th>Planned Sell</th>
          <th>Profit/Share</th>
          <th>Planned Shares</th>
          <th>Planned Total</th>
          <th>Sell Date</th>
          <th>Actual Buy</th>
          <th>Actual Sell</th>
          <th>Filled Qty</th>
          <th>Realized P/L</th>
          <th>Î” vs Plan</th>
          <th>Cum Realized</th>
        </tr>
      </thead>
      <tbody></tbody>`;
    wrap.appendChild(table);
    const tbody = table.querySelector('tbody');

    // Build rows
    let cum = 0;
    const savedRows = (asset.rows && asset.rows[r]) ? asset.rows[r] : [];
    for(let i=1;i<=CYCLES;i++){
      const tr=document.createElement('tr');
      const saved = savedRows[i-1] || {};
      const plannedShares = (saved.plannedShares!=null)? saved.plannedShares : (asset.defaultShares||1);
      const plannedTotal = plannedShares * (sell - buy);
      const realized = Number(saved.realized)||0;
      cum += realized;

      tr.innerHTML = `
        <td>${i}</td>
        <td class="planned-buy">${buy.toFixed(2)}</td>
        <td class="planned-sell">${sell.toFixed(2)}</td>
        <td class="profit-share">${fmt(profit)}</td>
        <td class="planned-shares"><input type="number" step="1" min="0" value="${plannedShares}"></td>
        <td class="planned-total">${fmt(plannedTotal)}</td>
        <td class="sell-date"><input type="date" value="${saved.sellDate||''}"></td>
        <td class="actual-buy"><input type="number" step="0.01" value="${saved.actualBuy||''}"></td>
        <td class="actual-sell"><input type="number" step="0.01" value="${saved.actualSell||''}"></td>
        <td class="filled"><input type="number" step="1" min="0" value="${saved.filled||''}"></td>
        <td class="realized">${fmt(realized)}</td>
        <td class="delta">${(saved.delta!=null? saved.delta : 'â€“')}</td>
        <td class="cum">${fmt(cum)}</td>
      `;
      // Tag inputs for save
      tr.querySelectorAll('input').forEach(inp=>{
        inp.dataset.ticker = asset.ticker;
        inp.dataset.rung = r;
        inp.dataset.row = i-1;
      });
      tbody.appendChild(tr);
    }

    // Row listeners to recompute realized/delta/cum and save
    tbody.addEventListener('input', e=>{
      const tr = e.target.closest('tr');
      const ab = parseFloat(tr.querySelector('.actual-buy input').value);
      const as = parseFloat(tr.querySelector('.actual-sell input').value);
      const filled = parseFloat(tr.querySelector('.filled input').value);
      const pBuy = parseFloat(tr.querySelector('.planned-buy').textContent);
      const pSell = parseFloat(tr.querySelector('.planned-sell').textContent);
      const plannedShares = parseFloat(tr.querySelector('.planned-shares input').value||0);
      tr.querySelector('.planned-total').textContent = fmt((pSell-pBuy)*plannedShares);
      let realized = 0, delta = 'â€“';
      if(!isNaN(ab)&&!isNaN(as)&&!isNaN(filled)){
        realized = (as - ab) * filled;
        delta = ( (as - ab) - (pSell - pBuy) ).toFixed(2);
      }
      tr.querySelector('.realized').textContent = fmt(realized);
      tr.querySelector('.delta').textContent = (delta==='â€“')? 'â€“' : ( (delta>=0?'+':'') + delta );
      // recompute cumulative
      let cum2=0;
      tr.parentElement.querySelectorAll('tr').forEach(row=>{
        const val = Number(row.querySelector('.realized').textContent.replace('$',''))||0;
        cum2 += val;
        row.querySelector('.cum').textContent = fmt(cum2);
      });
      persistTableInputs();
    });
  }

  // Controls for asset card
  const controls = document.createElement('div'); controls.className='flex'; controls.style.marginTop='10px';
  const buildBtn = document.createElement('button'); buildBtn.textContent='Build Ladder'; buildBtn.className='primary';
  const exportBtn = document.createElement('button'); exportBtn.textContent='Export CSV';
  const delBtn = document.createElement('button'); delBtn.textContent='Delete Ladder'; delBtn.style.background='#c33'; delBtn.style.color='#fff'; delBtn.style.border='0';
  controls.append(buildBtn, exportBtn, delBtn);
  body.appendChild(controls);

  // Handlers
  buildBtn.addEventListener('click', ()=>{
    // rebuild this asset
    // First, persist current rows then rebuild with same config
    persistTableInputs();
    render(); // re-render all
  });
  exportBtn.addEventListener('click', ()=> exportAssetCSV(asset.ticker));
  delBtn.addEventListener('click', ()=>{
    app.assets = app.assets.filter(a=>a.ticker!==asset.ticker);
    saveState(); render();
  });

  return container;
}

function exportAssetCSV(ticker){
  const a = app.assets.find(x=>x.ticker===ticker);
  if(!a) return;
  let lines = ['Cycle,Planned Buy,Planned Sell,Profit/Share,Planned Shares,Planned Total,Sell Date,Actual Buy,Actual Sell,Filled Qty,Realized,Delta,Cum'];
  // We need displayed values; quickest is to recreate with calc and then overlay saved rows.
  for(let r=0;r<a.rungs;r++){
    const {sell,buy,profit}=calcPrices(a.startPrice, SELL_PCTS[r], BUYBACK_PCTS[r]);
    let cum=0;
    lines.push(`Rung ${r+1}`);
    const savedRows = (a.rows && a.rows[r])? a.rows[r] : [];
    for(let i=1;i<=CYCLES;i++){
      const s = savedRows[i-1]||{};
      const plannedShares = (s.plannedShares!=null)? s.plannedShares : (a.defaultShares||1);
      const plannedTotal = (sell-buy)*plannedShares;
      const realized = Number(s.realized)||0; cum+=realized;
      const delta = (s.delta!=null)? s.delta : '';
      lines.push([i,buy.toFixed(2),sell.toFixed(2),profit.toFixed(2),plannedShares.toFixed(0),plannedTotal.toFixed(2),s.sellDate||'',s.actualBuy||'',s.actualSell||'',s.filled||'',realized.toFixed(2),delta,cum.toFixed(2)].join(','));
    }
  }
  const blob = new Blob([lines.join('\n')],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href=url; link.download=`${ticker}_ladder.csv`; link.click();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}

function persistTableInputs(){
  // Walk all tables + inputs, write back into app.assets[].rows
  const ladders = $('#laddersContainer');
  app.assets.forEach((asset, ai)=>{
    asset.rows = asset.rows || {};
  });
  ladders.querySelectorAll('.card').forEach(card=>{
    const header = card.querySelector('h2'); if(!header) return;
    const ticker = header.textContent.split(' ')[0];
    const asset = app.assets.find(a=>a.ticker===ticker); if(!asset) return;
    const tables = card.querySelectorAll('table tbody');
    asset.rows = {};
    tables.forEach((tbody, rIndex)=>{
      asset.rows[rIndex] = [];
      tbody.querySelectorAll('tr').forEach((tr, i)=>{
        const row = {
          plannedShares: Number(tr.querySelector('.planned-shares input').value||0),
          sellDate: tr.querySelector('.sell-date input').value||'',
          actualBuy: tr.querySelector('.actual-buy input').value||'',
          actualSell: tr.querySelector('.actual-sell input').value||'',
          filled: tr.querySelector('.filled input').value||'',
          realized: Number(tr.querySelector('.realized').textContent.replace('$',''))||0,
          delta: (tr.querySelector('.delta').textContent||'').replace('+','')
        };
        asset.rows[rIndex].push(row);
      });
    });
  });
  saveState();
}

function render(){
  $('#laddersContainer').innerHTML='';
  app.assets.forEach(asset=>{
    $('#laddersContainer').appendChild(buildAssetCard(asset));
  });
}

// ---- UI wiring ----
$('#addAsset').addEventListener('click', ()=>{
  const t = $('#ticker').value.trim().toUpperCase();
  const start = parseFloat($('#startPrice').value);
  if(!t || isNaN(start)){ alert('Enter ticker and start price'); return; }
  const rungCount = parseInt($('#rungCount').value);
  const ds = parseInt($('#defaultShares').value || '1');
  // add/replace
  const existing = app.assets.find(a=>a.ticker===t);
  const payload = {ticker:t, startPrice:start, rungs:rungCount, defaultShares:ds, rows:{}};
  if(existing){
    const idx = app.assets.findIndex(a=>a.ticker===t);
    app.assets[idx] = payload;
  } else {
    app.assets.push(payload);
  }
  saveState(); render();
});

$('#saveAll').addEventListener('click', ()=>{ persistTableInputs(); });
$('#clearAll').addEventListener('click', ()=>{
  if(confirm('Clear all ladders from this device?')){
    localStorage.removeItem('ladder_app_state_v2');
    app = {assets:[]};
    render(); $('#saveStatus').textContent = 'Cleared';
  }
});

// Tabs
$('#tabLadders').addEventListener('click', ()=>{
  $('#inputsPanel').style.display='';
  $('#laddersPanel').style.display='';
  $('#chartsPanel').style.display='none';
});
$('#tabCharts').addEventListener('click', ()=>{
  persistTableInputs();
  $('#inputsPanel').style.display='none';
  $('#laddersPanel').style.display='none';
  $('#chartsPanel').style.display='';
  drawChart();
});

// Chart (vanilla canvas)
function drawChart(){
  const year = parseInt($('#yearInput').value);
  const months = Array(12).fill(0);
  let total = 0;
  app.assets.forEach(a=>{
    if(!a.rows) return;
    Object.values(a.rows).forEach(rungRows=>{
      rungRows.forEach(row=>{
        if(row.sellDate && row.realized){
          const d = new Date(row.sellDate+'T00:00:00');
          if(d.getFullYear()===year){
            months[d.getMonth()] += row.realized;
            total += row.realized;
          }
        }
      });
    });
  });
  $('#portfolioTotal').textContent = 'Portfolio Total: '+fmt(total);
  // simple bar chart
  const c = document.getElementById('bar');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const w = c.width, h=c.height;
  const pad=30;
  const maxVal = Math.max(10, ...months.map(v=>Math.abs(v)));
  const yScale = (h-2*pad)/(maxVal*1.2);
  const barW = (w-2*pad)/12 - 6;
  ctx.strokeStyle='#ddd';
  ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  months.forEach((v,i)=>{
    const x = pad + i*((w-2*pad)/12) + 3;
    const bh = v*yScale;
    ctx.fillStyle = '#7db7ff';
    const y = (v>=0)? (h-pad - bh) : (h-pad);
    ctx.fillRect(x, y, barW, Math.abs(bh));
    ctx.fillStyle='#666'; ctx.font='12px sans-serif';
    ctx.fillText(String(i+1), x+barW/2-3, h-pad+14);
  });
}

// Init
document.addEventListener('DOMContentLoaded', ()=>{
  if(inPrivateSafari()){
    alert('Heads up: Private Browsing can prevent saving. Use a normal tab for persistent storage.');
  }
  loadState();
  render();
  window.addEventListener('beforeunload', persistTableInputs);
});
</script>
</body>
</html>
