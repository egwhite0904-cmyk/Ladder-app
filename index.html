<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ladder App</title>
<style>
  :root{
    --bg:#f6f9fc;--card:#fff;--ink:#15202b;--muted:#5b7083;
    --brand:#14a77b;--brand2:#0b8a64;--danger:#e05656;--line:#e6ecf0;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  header{background:linear-gradient(90deg,#16c3a8,#2f80ed);color:#fff;padding:14px 16px;font-weight:700;font-size:22px;position:sticky;top:0;z-index:5}
  .wrap{max-width:980px;margin:16px auto;padding:0 12px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:14px;margin-bottom:14px;border:1px solid var(--line)}
  .row{display:grid;gap:10px}
  .row.cols-4{grid-template-columns:1.5fr 1fr 1fr 1fr}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select,button{height:40px;border-radius:10px;border:1px solid var(--line);padding:0 10px;font-size:16px;background:#fff}
  button{background:var(--brand);border:0;color:#fff;font-weight:600;padding:0 14px}
  button.secondary{background:#eaf7f3;color:#0b8a64;border:1px solid #bfe7d5}
  button.danger{background:var(--danger)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#334; font-size:13px;margin-right:6px}
  .asset{border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .asset-head{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#fbfdff;border-bottom:1px solid var(--line);padding:10px 12px;flex-wrap:wrap}
  .asset-title{font-weight:700}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{font-size:14px;text-align:left;color:#4a5568;padding:0 10px}
  tbody td{background:#fff;border:1px solid var(--line);padding:8px 10px}
  tbody tr td:first-child{border-radius:12px 0 0 12px}
  tbody tr td:last-child{border-radius:0 12px 12px 0}
  .num{width:130px;text-align:right}
  .qty{width:90px;text-align:right}
  .date{width:150px}
  .readonly{background:#f9fbff}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .small{font-size:13px}
  tfoot td{font-weight:700}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<header>Ladder App</header>
<div class="wrap">

  <div class="card">
    <div class="row cols-4">
      <div><label>Ticker / Name</label><input id="inTicker" placeholder="e.g., RIOT or COIN"></div>
      <div><label>Rungs</label><select id="inRungs">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
      </select></div>
      <div><label>Start Price</label><input id="inPrice" type="number" step="0.01" placeholder="current price"></div>
      <div><label>Default Shares / row</label><input id="inShares" type="number" step="1" min="1" value="1"></div>
    </div>
    <div class="controls" style="margin-top:10px;">
      <button id="btnAdd">+ Add / Replace Asset</button>
      <button class="secondary" id="btnSave">Save Backup (JSON)</button>
      <button class="secondary" id="btnRestore">Restore Backup (JSON)</button>
      <button class="secondary" id="btnCsv">Export CSV (Excel)</button>
      <button class="danger" id="btnClear">Clear All (this device)</button>
      <span class="badge small muted" id="status">ready</span>
    </div>
    <div class="small muted" style="margin-top:10px">
      Presets (locked): Sell +2.5%, +4.5%, +7.0%, +10.0 (first 2–4 based on rungs). 
      Buyback 1%, 2.5%, 3.5%, 5% (rungs 1–4). 20 cycles. Row 1 Planned Buy equals <b>Start Price</b>;
      each next row uses: <code>nextBuy = prevSell × (1 – buyback%)</code> and <code>sell = buy × (1 + sell%)</code>. Edit any cell inline.
    </div>
  </div>

  <div id="assets"></div>

</div>

<script>
(() => {
  const SELL_PCTS = [0.025,0.045,0.07,0.10];          // first N based on # rungs
  const BUYBACK_PCTS = [0.01,0.025,0.035,0.05];       // per rung index
  const CYCLES = 20;

  const els = {
    ticker: document.getElementById('inTicker'),
    rungs: document.getElementById('inRungs'),
    price: document.getElementById('inPrice'),
    shares: document.getElementById('inShares'),
    add: document.getElementById('btnAdd'),
    save: document.getElementById('btnSave'),
    restore: document.getElementById('btnRestore'),
    csv: document.getElementById('btnCsv'),
    clear: document.getElementById('btnClear'),
    assets: document.getElementById('assets'),
    status: document.getElementById('status'),
  };

  const state = {
    assets: loadLS('ladder_assets', []),
  };

  function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  function loadLS(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback } catch(e){ return fallback }}

  function fmt(n){ return Number(n).toFixed(2); }
  function money(n){ return '$'+fmt(n); }

  function buildRows(startPrice, rungIndex, sharesDefault){
    const sellPct = SELL_PCTS[Math.min(rungIndex, SELL_PCTS.length-1)];
    const buyback = BUYBACK_PCTS[Math.min(rungIndex, BUYBACK_PCTS.length-1)];
    const rows = [];
    let buy = Number(startPrice);
    for(let i=1;i<=CYCLES;i++){
      const sell = buy * (1 + sellPct);
      const profit = sell - buy;
      rows.push({
        i,
        buy: Number(fmt(buy)),
        sell: Number(fmt(sell)),
        profit: Number(fmt(profit)),
        shares: Number(sharesDefault||1),
        buyDate: '',
        sellDate: '',
      });
      // next buy derived from previous sell
      buy = sell * (1 - buyback);
    }
    return rows;
  }

  function addOrReplaceAsset(){
    const name = (els.ticker.value||'').trim();
    const rungs = Number(els.rungs.value||1);
    const price = Number(els.price.value||0);
    const shares = Number(els.shares.value||1);
    if(!name || !price){ alert('Enter Ticker/Name and Start Price.'); return; }

    // build N rung tables
    const rungTables = [];
    for(let r=0;r<rungs;r++){
      rungTables.push({
        rung: r+1,
        sellPct: SELL_PCTS[Math.min(r, SELL_PCTS.length-1)],
        buybackPct: BUYBACK_PCTS[Math.min(r, BUYBACK_PCTS.length-1)],
        start: price,
        rows: buildRows(price, r, shares)
      });
    }

    const idxExisting = state.assets.findIndex(a => a.name.toLowerCase()===name.toLowerCase());
    const asset = { name, rungs, start: price, defaultShares: shares, tables: rungTables, open:true, created: Date.now() };
    if(idxExisting>=0) state.assets[idxExisting] = asset; else state.assets.unshift(asset);
    saveLS('ladder_assets', state.assets);
    render();
  }

  function exportCsv(){
    let lines = [];
    state.assets.forEach(A => {
      A.tables.forEach(T => {
        lines.push([A.name, `Rung ${T.rung}`, 'Row','# Planned Buy','Planned Sell','Profit/Share','Shares','Planned Total','Buy Date','Sell Date','Running Total'].join(','));
        let running = 0;
        T.rows.forEach(row => {
          const plannedTotal = row.profit * row.shares;
          running += plannedTotal;
          lines.push([A.name, `Rung ${T.rung}`, row.i, fmt(row.buy), fmt(row.sell), fmt(row.profit), row.shares, fmt(plannedTotal), row.buyDate, row.sellDate, fmt(running)].join(','));
        })
        lines.push('');
      });
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ladder_export.csv';
    a.click();
  }

  function saveBackup(){
    const blob = new Blob([JSON.stringify(state.assets,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ladder_backup.json';
    a.click();
  }

  function restoreBackup(){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = () => {
      const f = inp.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(Array.isArray(data)){ state.assets = data; saveLS('ladder_assets', state.assets); render(); }
        }catch(e){ alert('Invalid backup JSON.'); }
      };
      reader.readAsText(f);
    };
    inp.click();
  }

  function clearAll(){
    if(confirm('Delete all assets from this device?')){
      state.assets = []; saveLS('ladder_assets', state.assets); render();
    }
  }

  function render(){
    els.assets.innerHTML = '';
    state.assets.forEach((A, ai) => {
      const card = document.createElement('div'); card.className='asset card';

      const head = document.createElement('div'); head.className='asset-head';
      head.innerHTML = `
        <div class="asset-title">${A.name}</div>
        <div class="badges">
          <span class="badge">${A.rungs} rung(s)</span>
          <span class="badge">start ${money(A.start)}</span>
        </div>
        <div class="controls">
          <button class="secondary" data-action="toggle">Toggle</button>
          <button class="danger" data-action="delete">Delete</button>
        </div>
      `;
      card.appendChild(head);

      const body = document.createElement('div'); body.style.display = A.open?'block':'none'; body.style.padding='10px 12px 16px';

      A.tables.forEach((T, ti) => {
        const sec = document.createElement('div'); sec.className='card'; sec.style.margin='10px 0';
        sec.innerHTML = `<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
          <div class="badge">Rung ${T.rung}</div>
          <div class="badge">Sell +${(T.sellPct*100).toFixed(1)}%</div>
          <div class="badge">Buyback ${(T.buybackPct*100).toFixed(1)}%</div>
        </div>`;

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
          <th>#</th>
          <th>Planned Buy</th>
          <th>Planned Sell</th>
          <th>Profit/Share</th>
          <th>Planned Shares</th>
          <th>Planned Total</th>
          <th>Buy Date</th>
          <th>Sell Date</th>
          <th>Running Total</th>
        </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        let running = 0;
        T.rows.forEach((row, ri) => {
          const tr = document.createElement('tr');
          const plannedTotal = row.profit * row.shares;
          running += plannedTotal;
          tr.innerHTML = `
            <td class="readonly">${row.i}</td>
            <td><input class="num" type="number" step="0.01" value="${fmt(row.buy)}" data-k="buy"></td>
            <td><input class="num" type="number" step="0.01" value="${fmt(row.sell)}" data-k="sell"></td>
            <td class="readonly">${money(row.profit)}</td>
            <td><input class="qty" type="number" step="1" min="0" value="${row.shares}" data-k="shares"></td>
            <td class="readonly">${money(plannedTotal)}</td>
            <td><input class="date" type="date" value="${row.buyDate||''}" data-k="buyDate"></td>
            <td><input class="date" type="date" value="${row.sellDate||''}" data-k="sellDate"></td>
            <td class="readonly">${money(running)}</td>
          `;
          tr.querySelectorAll('input').forEach(inp => {
            inp.addEventListener('input', () => {
              const k = inp.dataset.k;
              let v = inp.type==='number' ? Number(inp.value) : inp.value;
              row[k] = v;
              if(k==='buy' || k==='sell'){ row.profit = Number(fmt(row.sell - row.buy)); }
              saveLS('ladder_assets', state.assets);
              render(); // simple re-render to refresh totals & running total
            });
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        // footer totals
        const tfoot = document.createElement('tfoot');
        const rungPlanned = T.rows.reduce((s,r)=> s + (r.profit*r.shares), 0);
        tfoot.innerHTML = `<tr>
          <td colspan="5">Rung ${T.rung} Planned Total</td>
          <td>${money(rungPlanned)}</td>
          <td colspan="3"></td>
        </tr>`;
        table.appendChild(tfoot);

        sec.appendChild(table);
        body.appendChild(sec);
      });

      card.appendChild(body);
      card.addEventListener('click', (e)=>{
        const act = e.target?.dataset?.action;
        if(act==='toggle'){ A.open = !A.open; saveLS('ladder_assets', state.assets); render(); }
        if(act==='delete'){
          if(confirm('Delete this asset?')){ state.assets.splice(ai,1); saveLS('ladder_assets', state.assets); render(); }
        }
      });
      els.assets.appendChild(card);
    });
  }

  els.add.addEventListener('click', addOrReplaceAsset);
  els.csv.addEventListener('click', exportCsv);
  els.save.addEventListener('click', saveBackup);
  els.restore.addEventListener('click', restoreBackup);
  els.clear.addEventListener('click', clearAll);

  render();
})();
</script>
</body>
</html>
