
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App â€” v2.4 (2/3/4 rungs, totals + charts)</title>
<style>
:root{
  --bg:#f7f7f7; --panel:#ffffff; --fg:#222; --muted:#666; --accent:#0a7ac2;
  --ok:#1a7f37; --warn:#c47a00; --bad:#b3261e; --line:#e6e6e6;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif}
.header{display:flex;gap:12px;align-items:center;padding:12px 14px;background:var(--panel);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
.logo{font-weight:700;font-size:18px}
.tabs{margin-left:auto;display:flex;gap:8px}
button,select,input{font:inherit}
.btn{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
.btn.secondary{background:#444}
.btn.ghost{background:#eee;color:#111}
.btn.warn{background:var(--bad)}
.container{max-width:980px;margin:18px auto;padding:0 12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;margin:12px 0;padding:12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.grid .span12{grid-column:1/-1}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
input[type="text"],input[type="number"],input[type="date"],select{width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;background:#fff}
small.help{color:var(--muted)}
h2{margin:10px 0 6px;font-size:18px}
h3{margin:14px 0 6px;font-size:16px}
.section-title{display:flex;align-items:center;gap:8px;justify-content:space-between}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi{background:#fafafa;border:1px solid var(--line);border-radius:10px;padding:10px}
.kpi b{display:block;font-size:18px}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
.table th{background:#fafafa;position:sticky;top:56px;z-index:2}
.table input{width:100%;padding:6px;border:1px solid var(--line);border-radius:6px}
.badge{background:#eee;border-radius:999px;padding:4px 8px;font-size:12px}
.row-actions{display:flex;gap:8px;flex-wrap:wrap}
hr.sep{border:0;border-top:1px dashed var(--line);margin:12px 0}
footer{padding:30px;color:var(--muted);text-align:center}
/* chart */
#chartWrap{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
canvas{max-width:100%}
@media (max-width:720px){
  .kpis{grid-template-columns:repeat(2,1fr)}
  .grid{grid-template-columns:repeat(6,1fr)}
}
</style>
</head>
<body>
  <div class="header">
    <div class="logo">ðŸ“ˆ Ladder App</div>
    <div class="tabs">
      <button id="tabLadders" class="btn">Ladders</button>
      <button id="tabCharts" class="btn ghost">Charts</button>
    </div>
  </div>
  <div class="container">
    <!-- LADDERS PAGE -->
    <section id="pageLadders">
      <div class="card">
        <div class="kpis">
          <div class="kpi"><label>Realized P/L (All)</label><b id="kpiPL">$0.00</b></div>
          <div class="kpi"><label># of Assets</label><b id="kpiAssets">0</b></div>
          <div class="kpi"><label>Open Rows</label><b id="kpiOpen">0</b></div>
          <div class="kpi"><label>Closed Rows</label><b id="kpiClosed">0</b></div>
        </div>
      </div>

      <div class="card">
        <h2>Add / Edit Asset</h2>
        <div class="grid">
          <div class="span12" style="display:grid;grid-template-columns:repeat(12,1fr);gap:10px">
            <div style="grid-column:span 4">
              <label>Ticker / Name</label>
              <input id="inpTicker" type="text" placeholder="e.g., RIOT or CVS">
            </div>
            <div style="grid-column:span 3">
              <label>Rungs</label>
              <select id="inpRungs">
                <option value="2">2 Rungs</option>
                <option value="3" selected>3 Rungs</option>
                <option value="4">4 Rungs</option>
              </select>
            </div>
            <div style="grid-column:span 3">
              <label>Default Shares per row</label>
              <input id="inpDefaultShares" type="number" min="0" step="1" value="1">
            </div>
            <div style="grid-column:span 2">
              <label>&nbsp;</label>
              <button class="btn" id="btnAddAsset">+ Add Asset</button>
            </div>
          </div>
          <div style="grid-column:span 4">
            <label>Start Price</label>
            <input id="inpStart" type="number" step="0.01" placeholder="current price">
          </div>
          <div style="grid-column:span 8">
            <label>Preset notes</label>
            <div class="badge" title="Sell: +2.5%, +4.5%, +7%, (+9% if 4 rungs). Buyback: 1%, 2.5%, 3.5%, (5% if 4 rungs). 20 cycles.">Locked %: Sell +2.5/4.5/7(/9) â€¢ Buyback 1/2.5/3.5(/5) â€¢ 20 cycles</div>
          </div>
        </div>
        <hr class="sep">
        <div class="row-actions">
          <button class="btn" id="btnSaveAll">Save</button>
          <button class="btn ghost" id="btnClearAll">Clear All (this device)</button>
          <button class="btn secondary" id="btnExport">Export JSON</button>
          <input id="fileImport" type="file" accept="application/json" style="display:none">
          <button class="btn secondary" id="btnImport">Import JSON</button>
        </div>
        <small class="help">Tip: you can edit any value in the table after creation (dates, actual prices, qty, etc.). Data auto-saves to this device.</small>
      </div>

      <div id="assets"></div>
    </section>

    <!-- CHARTS PAGE -->
    <section id="pageCharts" style="display:none">
      <div class="card">
        <h2>Totals & Charts</h2>
        <div class="grid">
          <div style="grid-column:span 3">
            <label>From</label><input id="fromDate" type="date">
          </div>
          <div style="grid-column:span 3">
            <label>To</label><input id="toDate" type="date">
          </div>
          <div style="grid-column:span 3">
            <label>Year</label><input id="yearInput" type="number" step="1" placeholder="2025">
          </div>
          <div style="grid-column:span 3">
            <label>&nbsp;</label><button id="btnUpdateChart" class="btn">Update</button>
          </div>
        </div>
      </div>
      <div class="card" id="chartWrap">
        <h3 class="section-title"><span>Realized P/L by Date</span><span id="chartTotal" class="badge">$0.00</span></h3>
        <canvas id="chart" height="120"></canvas>
        <small class="help">Chart shows realized P/L summed by Sell Date for rows with Actual Buy/Sell and Qty. Use date filters above or enter a Year and press Update.</small>
      </div>
    </section>

    <footer>v2.4 â€¢ Saves to localStorage â€¢ Percent presets locked per rung count</footer>
  </div>

<script>
/*** utilities ***/
const $ = sel => document.querySelector(sel);
const el = (tag, attrs={}, children=[]) => {
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') n.className=v; else if(k==='html') n.innerHTML=v; else n.setAttribute(k,v);
  });
  children.forEach(c=> n.appendChild(c));
  return n;
};
const fmt = n => '$' + (Number(n)||0).toFixed(2);
const toNum = v => { const n = parseFloat(v); return isNaN(n)?0:n; };

/*** storage ***/
const KEY='ladder_app_v24_data';
let state = JSON.parse(localStorage.getItem(KEY) || '{"assets":[]}');
const save = () => localStorage.setItem(KEY, JSON.stringify(state));

/*** rung presets ***/
const SELL_PRESETS = {2:[2.5,4.5], 3:[2.5,4.5,7], 4:[2.5,4.5,7,9]};
const BUY_PRESETS  = {2:[1,2.5],   3:[1,2.5,3.5], 4:[1,2.5,3.5,5]};
const CYCLES = 20;

/*** build ladder rows ***/
function buildRows(start, rungs, defShares){
  const sells = SELL_PRESETS[rungs];
  const buys = BUY_PRESETS[rungs];
  return sells.map((sellPct, i)=>{
    const buybackPct = buys[i];
    const plannedSell = start * (1 + sellPct/100);
    const plannedBuy  = plannedSell * (1 - buybackPct/100);
    const profitPerShare = plannedSell - plannedBuy;
    const rows = [];
    for(let c=1;c<=CYCLES;c++){
      rows.push({
        cycle:c,
        plannedBuy: +plannedBuy.toFixed(2),
        plannedSell:+plannedSell.toFixed(2),
        profitShare:+profitPerShare.toFixed(2),
        plannedShares: (c===1?defShares:1),
        plannedTotal: 0,
        buyDate:"",
        sellDate:"",
        actualBuy:"",
        actualSell:"",
        qty:"",
        realized:0,
        deltaVsPlan:0,
        cumRealized:0
      });
    }
    return rows;
  });
}

/*** render asset ***/
function render(){
  const wrap = $('#assets');
  wrap.innerHTML='';
  // KPIs
  let realizedAll=0, closed=0, open=0;
  state.assets.forEach(a=>{
    a.rungs.forEach(r=>{
      r.forEach(row=>{
        if(row.qty && row.actualSell && row.actualBuy){
          const rpl = (toNum(row.actualSell)-toNum(row.actualBuy))*toNum(row.qty);
          realizedAll += rpl;
          closed += 1;
        }else{
          open += 1;
        }
      });
    });
  });
  $('#kpiPL').textContent = fmt(realizedAll);
  $('#kpiAssets').textContent = state.assets.length;
  $('#kpiOpen').textContent = open;
  $('#kpiClosed').textContent = closed;

  state.assets.forEach((a,idx)=>{
    const card = el('div',{class:'card'});
    const head = el('div',{class:'section-title span12'},[
      el('div',{html:`<h3>${a.ticker} â€” <span class="badge">${a.rungs.length} rung(s)</span> Â· <span class="badge">start $${a.start.toFixed(2)}</span></h3>`})
    ]);
    const actions = el('div',{class:'row-actions'},[
      el('button',{class:'btn',html:'Build Ladder',onclick:()=>{
        a.rungs = buildRows(a.start, a.rungs.length, a.defaultShares);
        save(); render();
      }}),
      el('button',{class:'btn secondary',html:'Export CSV',onclick:()=>exportCSV(a)}),
      el('button',{class:'btn warn',html:'Delete Ladder',onclick:()=>{ if(confirm('Delete this asset?')){ state.assets.splice(idx,1); save(); render(); } }})
    ]);
    card.append(head, actions, el('div',{html:`<p class="help">Rungs use locked defaults: Sell +2.5%, +4.5%, +7%${a.rungs.length===4?', +9%':''} Â· Buyback 1%, 2.5%, 3.5%${a.rungs.length===4?', 5%':''} Â· ${CYCLES} cycles. Edit any cell inline.</p>`}));

    a.rungs.forEach((rows,ri)=>{
      card.append(el('h3',{html:`${a.ticker} â€” Rung ${ri+1} <span class="badge">Sell +${SELL_PRESETS[a.rungs.length][ri]}% â€¢ Buyback ${BUY_PRESETS[a.rungs.length][ri]}%</span>`}));
      const table = el('table',{class:'table'});
      table.append(el('thead',{},[el('tr',{},[
        el('th',{html:'#'}),
        el('th',{html:'Planned Buy'}),
        el('th',{html:'Planned Sell'}),
        el('th',{html:'Profit/Share'}),
        el('th',{html:'Planned Shares'}),
        el('th',{html:'Planned Total'}),
        el('th',{html:'Buy Date'}),
        el('th',{html:'Sell Date'}),
        el('th',{html:'Actual Buy'}),
        el('th',{html:'Actual Sell'}),
        el('th',{html:'Filled Qty'}),
        el('th',{html:'Realized P/L'}),
        el('th',{html:'Î” vs Plan'}),
        el('th',{html:'Cum Realized'})
      ])]));
      const tb = el('tbody');
      let cum=0;
      rows.forEach((r,ci)=>{
        // compute planned total and realized
        r.plannedTotal = +(r.plannedShares * r.profitShare).toFixed(2);
        let realized = 0;
        if(r.qty && r.actualSell && r.actualBuy){
          realized = (toNum(r.actualSell)-toNum(r.actualBuy))*toNum(r.qty);
        }
        r.realized = +realized.toFixed(2);
        r.deltaVsPlan = +(r.realized - r.plannedTotal).toFixed(2);
        cum += r.realized;
        r.cumRealized = +cum.toFixed(2);

        const tr = el('tr');
        const cells = [
          el('td',{html:String(ci+1)}),
          tdInput(r,'plannedBuy','number',0.01),
          tdInput(r,'plannedSell','number',0.01),
          el('td',{html:fmt(r.profitShare)}),
          tdInput(r,'plannedShares','number',1,0),
          el('td',{html:fmt(r.plannedTotal)}),
          tdInput(r,'buyDate','date'),
          tdInput(r,'sellDate','date'),
          tdInput(r,'actualBuy','number',0.01),
          tdInput(r,'actualSell','number',0.01),
          tdInput(r,'qty','number',1,0),
          el('td',{html:fmt(r.realized)}),
          el('td',{html:fmt(r.deltaVsPlan)}),
          el('td',{html:fmt(r.cumRealized)})
        ];
        cells.forEach(c=>tr.append(c));
        tb.append(tr);
      });
      table.append(tb);
      card.append(table, el('hr',{class:'sep'}));
    });

    wrap.append(card);
  });
}

function tdInput(obj,key,type,step=undefined,min=undefined){
  const td = el('td');
  const input = el('input',{type:type});
  if(type==='date'){
    input.value = obj[key]||'';
  }else{
    if(obj[key]!=='' && obj[key]!==undefined) input.value = obj[key];
    if(step!==undefined) input.step = step;
    if(min!==undefined) input.min = min;
  }
  input.addEventListener('change',()=>{
    obj[key] = (type==='date') ? input.value : toNum(input.value);
    save(); render();
  });
  td.append(input); return td;
}

/*** export CSV for one asset ***/
function exportCSV(asset){
  const rows=[
    ['Ticker',asset.ticker],
    ['Start',asset.start],
    [],
  ];
  asset.rungs.forEach((r,ri)=>{
    rows.push([`${asset.ticker} â€” Rung ${ri+1}`]);
    rows.push(['#','Planned Buy','Planned Sell','Profit/Share','Planned Shares','Planned Total','Buy Date','Sell Date','Actual Buy','Actual Sell','Filled Qty','Realized P/L','Delta vs Plan','Cum Realized']);
    r.forEach((row,i)=>{
      rows.push([i+1,row.plannedBuy,row.plannedSell,row.profitShare,row.plannedShares,row.plannedTotal,row.buyDate,row.sellDate,row.actualBuy,row.actualSell,row.qty,row.realized,row.deltaVsPlan,row.cumRealized]);
    });
    rows.push([]);
  });
  const csv = rows.map(a=>a.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=`${asset.ticker}_ladder.csv`; a.click();
  URL.revokeObjectURL(url);
}

/*** add asset ***/
$('#btnAddAsset').addEventListener('click',()=>{
  const t = $('#inpTicker').value.trim().toUpperCase();
  const rungs = parseInt($('#inpRungs').value,10);
  const start = toNum($('#inpStart').value);
  const defShares = Math.max(0, parseInt($('#inpDefaultShares').value||'1',10));
  if(!t || !start){ alert('Enter ticker and start price.'); return; }
  const idx = state.assets.findIndex(a=>a.ticker===t);
  const r = buildRows(start, rungs, defShares);
  const asset = {ticker:t,start:start,defaultShares:defShares,rungs:r};
  if(idx>=0) state.assets[idx]=asset; else state.assets.push(asset);
  save(); render();
});

$('#btnSaveAll').addEventListener('click',()=>{ save(); alert('Saved to this device.'); });
$('#btnClearAll').addEventListener('click',()=>{ if(confirm('Clear all ladders from this device?')){ state={assets:[]}; save(); render(); }});
$('#btnExport').addEventListener('click',()=>{
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='ladder_app_backup.json'; a.click();
  URL.revokeObjectURL(url);
});
$('#btnImport').addEventListener('click',()=>$('#fileImport').click());
$('#fileImport').addEventListener('change',e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = () => { try{ state = JSON.parse(reader.result); save(); render(); }catch(err){ alert('Bad JSON'); } };
  reader.readAsText(file);
});

/*** tabs ***/
$('#tabLadders').addEventListener('click',()=>{ $('#pageLadders').style.display='block'; $('#pageCharts').style.display='none'; $('#tabLadders').classList.remove('ghost'); $('#tabCharts').classList.add('ghost'); });
$('#tabCharts').addEventListener('click',()=>{ $('#pageLadders').style.display='none'; $('#pageCharts').style.display='block'; $('#tabCharts').classList.remove('ghost'); $('#tabLadders').classList.add('ghost'); drawChart(); });

/*** charts ***/
let chartRef=null;
function drawChart(){
  const ctx = $('#chart').getContext('2d');
  // collect realized by sellDate
  const map = new Map();
  state.assets.forEach(a=> a.rungs.forEach(r=> r.forEach(row=>{
    if(row.sellDate && row.qty && row.actualBuy && row.actualSell){
      const d = row.sellDate;
      const v = (toNum(row.actualSell)-toNum(row.actualBuy))*toNum(row.qty);
      map.set(d, (map.get(d)||0)+v);
    }
  })));
  // filter by date/yr
  const y = $('#yearInput').value.trim();
  const from = $('#fromDate').value; const to = $('#toDate').value;
  let entries=[...map.entries()];
  if(y) entries = entries.filter(([d,v])=> d.startsWith(String(y)));
  if(from) entries = entries.filter(([d,v])=> d>=from);
  if(to) entries = entries.filter(([d,v])=> d<=to);
  entries.sort();
  const labels = entries.map(([d])=>d);
  const data = entries.map(([_,v])=>+v.toFixed(2));
  const total = data.reduce((a,b)=>a+b,0);
  $('#chartTotal').textContent = fmt(total);
  // simple chart without external libs
  if(chartRef){ chartRef.destroy && chartRef.destroy(); chartRef=null; }
  chartRef = simpleBarChart(ctx, labels, data);
}
$('#btnUpdateChart').addEventListener('click',drawChart);

/*** tiny canvas bar chart (no deps) ***/
function simpleBarChart(ctx, labels, data){
  const W = ctx.canvas.width = ctx.canvas.clientWidth;
  const H = ctx.canvas.height = 200;
  const max = Math.max(10, ...data.map(Math.abs));
  const pad = 30; const bw = (W - pad*2) / (data.length||1) * 0.7;
  const x0 = pad + ((W - pad*2) / (data.length||1) - bw)/2;
  // draw
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#666'; ctx.font = '12px -apple-system,Arial';
  // axis
  ctx.beginPath(); ctx.moveTo(pad, H-24); ctx.lineTo(W-pad, H-24); ctx.strokeStyle='#ccc'; ctx.stroke();
  data.forEach((v,i)=>{
    const h = (H-60) * (Math.abs(v)/max);
    const x = x0 + i*((W - pad*2)/(data.length||1));
    const y = (v>=0)? (H-24 - h) : (H-24);
    ctx.fillStyle = '#8ab4f8';
    ctx.fillRect(x, y, bw, h);
    // label
    ctx.save();
    ctx.translate(x, H-8); ctx.rotate(-Math.PI/6);
    ctx.fillStyle='#444'; ctx.fillText(labels[i]||'', 0,0);
    ctx.restore();
  });
  // API
  return { destroy(){ /* noop */ } };
}

/*** init ***/
function initFromURL(){
  const url = new URL(window.location);
  const p = url.searchParams.get('p'); // set start price quickly
  if(p){ $('#inpStart').value = p; }
}
initFromURL();
render();
</script>
</body>
</html>
