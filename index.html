<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App</title>
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --accent1:#1aa6ff;
    --accent2:#11c7a6;
    --danger:#e34545;
    --muted:#6b7280;
    --text:#0f172a;
    --table-border:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
  header{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff; padding:14px 16px; font-weight:800; font-size:28px;
    letter-spacing:.5px;
  }
  .wrap{max-width:980px; margin:16px auto; padding:0 14px;}
  .card{background:var(--card); border-radius:14px; box-shadow:0 4px 14px rgba(15,23,42,.06); padding:16px; margin-bottom:16px;}

  /* Inputs & pills */
  input[type="text"], input[type="number"]{
    width:100%; padding:10px 12px; border:1px solid var(--table-border); border-radius:10px; font-size:16px;
    background:#fff; color:var(--text);
  }
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0 }
  input[type="number"]{ -moz-appearance: textfield; }
  .row{display:grid; gap:10px; grid-template-columns: 1.4fr .8fr .8fr .8fr auto;}
  .row label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
  .btn{border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer}
  .btn.green{background:#20b768; color:#fff}
  .btn.gray{background:#eef2f7; color:#111827}
  .btn.red{background:var(--danger); color:#fff}
  .chips{display:flex; flex-wrap:wrap; gap:8px; margin:-4px 0 10px}
  .chip{background:#eef2f7; color:#111827; border-radius:999px; padding:8px 12px; font-weight:600; font-size:14px;}

  /* Table */
  .table-wrap{overflow-x:auto;}
  table{width:100%; border-collapse:collapse; table-layout:fixed; font-feature-settings:"tnum";}
  colgroup col:nth-child(1){width:8%}
  colgroup col:nth-child(2){width:20%}
  colgroup col:nth-child(3){width:20%}
  colgroup col:nth-child(4){width:18%}
  colgroup col:nth-child(5){width:16%}
  colgroup col:nth-child(6){width:18%}
  thead th{
    position:sticky; top:0; background:#fff; z-index:2;
    border-bottom:2px solid var(--table-border); padding:10px; text-align:left; font-size:14px; white-space:nowrap;
  }
  tbody td{border-bottom:1px solid var(--table-border); padding:10px; vertical-align:middle; font-size:16px}
  tbody td input{width:100%; text-align:center; font-weight:700; font-variant-numeric:tabular-nums;}

  .right{text-align:right}
  .center{text-align:center}

  .asset-head{
    display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:6px;
  }
  .asset-title{font-size:28px; font-weight:800}
  .pillbar{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .spacer{flex:1}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .footer{margin-top:4px; font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<header> Ladder App </header>
<div class="wrap">

  <div class="card">
    <div class="row">
      <div>
        <label>Ticker / Name</label>
        <input id="ticker" placeholder="e.g., RIOT or MU" />
      </div>
      <div>
        <label>Rungs</label>
        <input id="rungs" type="number" min="1" max="4" value="3" />
      </div>
      <div>
        <label>Start Price</label>
        <input id="start" inputmode="decimal" type="number" step="0.01" placeholder="current price"/>
      </div>
      <div>
        <label>Default Shares / row</label>
        <input id="shares" type="number" step="1" value="1"/>
      </div>
      <div style="align-self:end">
        <button class="btn green" id="addBtn">+ Add / Replace Asset</button>
      </div>
    </div>

    <div class="chips" style="margin-top:12px">
      <span class="chip">Baseline presets (locked):</span>
      <span class="chip">Sell +2.5%, +4.5%, +7.0%, +10% (rungs 1–4)</span>
      <span class="chip">Buyback 1%, 2.5%, 3.5%, 5% (rungs 1–4)</span>
      <span class="chip">20 cycles</span>
      <span class="chip">Row 1 buy = start</span>
      <span class="chip">nextBuy = prevSell × (1 – buyback%)</span>
      <span class="chip">sell = buy × (1 + sell%)</span>
    </div>

    <div class="row" style="grid-template-columns: repeat(4, minmax(0,1fr)); margin-top:10px">
      <button class="btn gray" id="saveBtn">Save Backup (JSON)</button>
      <button class="btn gray" id="restoreBtn">Restore Backup (JSON)</button>
      <button class="btn gray" id="csvBtn">Export CSV (Excel)</button>
      <button class="btn red" id="clearBtn">Clear All (this device)</button>
    </div>
    <input id="restoreFile" type="file" accept="application/json" style="display:none"/>
  </div>

  <div id="assets"></div>

  <div class="footer center muted small">auto‑save enabled • single‑file build</div>
</div>

<script>
const DEFAULTS = {
  sellSteps: [0.025, 0.045, 0.07, 0.10],
  buybacks: [0.01, 0.025, 0.035, 0.05],
  cycles: 20
};

let state = load() || { assets: [] };

function $(id){ return document.getElementById(id); }

function fmtMoney(n){ 
  if (isNaN(n)) return '';
  return '$' + n.toFixed(2);
}
function fmtNum(n){ return isNaN(n) ? '' : n.toFixed(2); }

function rungIndexFromCount(count){
  let c = Math.max(1, Math.min(4, Number(count||1)));
  return c - 1;
}

function computeRows(startPrice, rungs, defShares){
  const rIdx = rungIndexFromCount(rungs);
  const sellPct = DEFAULTS.sellSteps[rIdx];
  const buyback = DEFAULTS.buybacks[rIdx];
  let rows = [];
  let buy = Number(startPrice||0);
  for(let i=0;i<DEFAULTS.cycles;i++){
    const sell = buy * (1 + sellPct);
    const profit = sell - buy;
    rows.push({
      buy: Number(buy.toFixed(2)),
      sell: Number(sell.toFixed(2)),
      shares: Number(defShares||1),
    });
    buy = sell * (1 - buyback);
  }
  return rows;
}

function calcProfit(buy, sell){ return Number((sell - buy).toFixed(2)); }
function calcTotal(shares, profit){ return Number((shares * profit).toFixed(2)); }

function save(){ localStorage.setItem('ladder.singlefile.v1', JSON.stringify(state)); }
function load(){
  try{ return JSON.parse(localStorage.getItem('ladder.singlefile.v1')); }catch(e){ return null; }
}

function upsertAsset(name, rungs, startPrice, defShares){
  if(!name) return alert('Please enter a ticker / name');
  if(!startPrice) return alert('Please enter a start price');
  const rows = computeRows(startPrice, rungs, defShares);
  const existing = state.assets.find(a => a.name.toLowerCase() === name.toLowerCase());
  const a = {
    id: existing ? existing.id : (Date.now()+Math.random()).toString(36),
    name, rungs:Number(rungs||1), startPrice:Number(startPrice), defShares:Number(defShares||1),
    expanded:true, rows
  };
  if(existing){
    const idx = state.assets.findIndex(x=>x.id===existing.id);
    state.assets[idx] = a;
  }else{
    state.assets.unshift(a);
  }
  save(); render();
}

function deleteAsset(id){
  state.assets = state.assets.filter(a=>a.id!==id);
  save(); render();
}

function toggleAsset(id){
  const a = state.assets.find(x=>x.id===id); if(!a) return;
  a.expanded = !a.expanded; save(); render();
}

function onCellEdit(aid, idx, field, value){
  const a = state.assets.find(x=>x.id===aid); if(!a) return;
  const row = a.rows[idx];
  if(field==='buy' || field==='sell'){
    row[field] = Number(value||0);
  }else if(field==='shares'){
    row[field] = Number(value||0);
  }
  save(); // no need to re-render entire asset – but easiest:
  render();
}

function makeAssetCard(a){
  const sellPct = DEFAULTS.sellSteps[rungIndexFromCount(a.rungs)]*100;
  const buyback = DEFAULTS.buybacks[rungIndexFromCount(a.rungs)]*100;

  let html = `
  <div class="card">
    <div class="asset-head">
      <div class="pillbar">
        <span class="chip">${a.name}</span>
        <span class="chip">${a.rungs} rung(s)</span>
        <span class="chip">start ${fmtMoney(Number(a.startPrice))}</span>
        <span class="chip">Sell +${sellPct.toFixed(1)}%</span>
        <span class="chip">Buyback ${buyback.toFixed(1)}%</span>
      </div>
      <div class="pillbar">
        <button class="btn gray" onclick="toggleAsset('${a.id}')">Toggle</button>
        <button class="btn red" onclick="deleteAsset('${a.id}')">Delete</button>
      </div>
    </div>`;

  if(a.expanded){
    html += `
    <div class="table-wrap">
      <table>
        <colgroup>
          <col><col><col><col><col><col>
        </colgroup>
        <thead>
          <tr>
            <th class="center">#</th>
            <th class="center">Planned Buy</th>
            <th class="center">Planned Sell</th>
            <th class="right">Profit/Share</th>
            <th class="center">Planned Shares</th>
            <th class="right">Planned Total</th>
          </tr>
        </thead>
        <tbody>`;

    a.rows.forEach((r, i)=>{
      const profit = calcProfit(r.buy, r.sell);
      const total = calcTotal(r.shares, profit);
      html += `
          <tr>
            <td class="center">${i+1}</td>
            <td><input type="number" step="0.01" inputmode="decimal" value="${fmtNum(r.buy)}"
                oninput="onCellEdit('${a.id}', ${i}, 'buy', this.value)" /></td>
            <td><input type="number" step="0.01" inputmode="decimal" value="${fmtNum(r.sell)}"
                oninput="onCellEdit('${a.id}', ${i}, 'sell', this.value)" /></td>
            <td class="right">${fmtMoney(profit)}</td>
            <td><input type="number" step="1" value="${r.shares}"
                oninput="onCellEdit('${a.id}', ${i}, 'shares', this.value)"/></td>
            <td class="right">${fmtMoney(total)}</td>
          </tr>`;
    });

    html += `
        </tbody>
      </table>
    </div>`;
  }

  html += `</div>`;
  return html;
}

function render(){
  const container = $('assets');
  if(!state.assets.length){
    container.innerHTML = '<div class="card muted">No assets yet. Add one above.</div>';
    return;
  }
  container.innerHTML = state.assets.map(makeAssetCard).join('');
}

// Buttons
$('addBtn').onclick = () => {
  upsertAsset($('ticker').value.trim(), Number($('rungs').value||1), Number($('start').value||0), Number($('shares').value||1));
};

$('clearBtn').onclick = () => {
  if(confirm('Clear all assets on this device?')){
    localStorage.removeItem('ladder.singlefile.v1');
    state = {assets:[]}; render();
  }
};

$('saveBtn').onclick = () => {
  const blob = new Blob([JSON.stringify(state)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ladder_backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
};

$('restoreBtn').onclick = () => $('restoreFile').click();
$('restoreFile').onchange = (e) => {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(!data || !Array.isArray(data.assets)) throw new Error('Invalid file');
      state = data; save(); render();
    }catch(err){ alert('Invalid backup file.'); }
  };
  reader.readAsText(file);
  e.target.value = '';
};

$('csvBtn').onclick = () => {
  let rows = [['Asset','Rungs','Start','Row','#','Planned Buy','Planned Sell','Profit/Share','Planned Shares','Planned Total']];
  state.assets.forEach(a=>{
    a.rows.forEach((r, i)=>{
      const profit = calcProfit(r.buy, r.sell);
      const total = calcTotal(r.shares, profit);
      rows.push([a.name, a.rungs, a.startPrice, i+1, i+1, r.buy, r.sell, profit, r.shares, total]);
    });
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ladder_export.csv';
  a.click();
  URL.revokeObjectURL(a.href);
};

// initial render
render();
</script>
</body>
</html>
