<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Ladder App</title>
<style>
  :root{
    --bg:#f7f8fc;
    --card:#ffffff;
    --accent:#2e90fa;
    --accent2:#16a34a;
    --danger:#e11d48;
    --muted:#64748b;
    --text:#0f172a;
    --radius:14px;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background:var(--bg);
    color:var(--text);
    line-height:1.25;
  }
  header{
    background:linear-gradient(90deg,#00b4d8,#0077ff);
    color:white;
    padding:18px 16px;
    font-size:28px;
    font-weight:800;
    letter-spacing:0.3px;
  }
  .container{padding:16px;}
  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:16px;
    box-shadow: 0 8px 20px rgba(15,23,42,.06);
    margin-bottom:16px;
  }
  .row{display:flex; gap:12px; flex-wrap:wrap;}
  .col{flex:1 1 140px; min-width:140px;}
  label{display:block; font-weight:700; font-size:14px; margin:0 0 6px; color:var(--muted);}
  input[type="text"], input[type="number"], select{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; font-size:16px;
  }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:12px; border:0; color:#fff; background:var(--accent2);
    font-weight:700; font-size:16px;
  }
  .btn.secondary{background:var(--accent);}
  .btn.danger{background:var(--danger);}
  .btn.ghost{background:#eef2ff; color:#1e40af;}
  .btn.small{font-size:14px; padding:8px 12px; border-radius:10px;}
  .pill{display:inline-block; padding:8px 12px; border-radius:999px; background:#f1f5f9; color:#334155; font-weight:700; font-size:13px; margin:4px 6px 0 0;}
  table{width:100%; border-collapse:separate; border-spacing:0 10px;}
  th, td{padding:10px 8px; text-align:left;}
  thead th{font-size:13px; color:#334155;}
  tbody tr{background:#fff; border-radius:12px; box-shadow:0 6px 16px rgba(15,23,42,.06);}
  tbody td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px;}
  tbody td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px;}
  .num{font-variant-numeric: tabular-nums;}
  .cell-input{
    width:100%; text-align:center; font-variant-numeric: tabular-nums;
    padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; font-size:16px;
  }
  /* wider monetary fields for mobile */
  .w-money{min-width:110px;}
  .w-shares{min-width:68px; max-width:90px;}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap;}
  details.asset{border:1px solid #e5e7eb; border-radius:16px; padding:10px; background:#fff;}
  details.asset>summary{
    list-style:none;
    cursor:pointer;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 6px;
    font-weight:800; font-size:18px;
  }
  details.asset[open]>summary{border-bottom:1px dashed #e5e7eb; margin-bottom:8px;}
  summary::-webkit-details-marker{display:none;}
  .right{display:flex; gap:8px; align-items:center;}
  .muted{color:#64748b;}
  .hidden{display:none !important;}
  .section-title{font-weight:900; font-size:22px; margin:8px 0 12px;}
  .note{font-size:13px; color:#475569;}
</style>
</head>
<body>
<header>Ladder App</header>
<div class="container">
  <div class="card" id="formCard">
    <div class="row">
      <div class="col">
        <label for="ticker">Ticker / Name</label>
        <input id="ticker" type="text" placeholder="e.g., RIOT or MU">
      </div>
      <div class="col">
        <label for="rungs">Rungs</label>
        <select id="rungs">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div class="col">
        <label for="start">Start Price</label>
        <input id="start" type="number" step="0.01" placeholder="current price">
      </div>
      <div class="col">
        <label for="shares">Default Shares / row</label>
        <input id="shares" type="number" step="1" value="1">
      </div>
    </div>
    <div style="margin-top:12px" class="toolbar">
      <button id="addBtn" class="btn">+ Add / Replace Asset</button>
      <button id="saveBtn" class="btn ghost">Save Backup (JSON)</button>
      <button id="loadBtn" class="btn ghost">Restore Backup (JSON)</button>
      <input id="fileInput" class="hidden" type="file" accept="application/json">
      <button id="csvBtn" class="btn ghost">Export CSV (Excel)</button>
      <button id="clearBtn" class="btn danger">Clear All (this device)</button>
    </div>
    <div style="margin-top:10px" class="note">
      Baseline presets (locked): <span class="pill">Sell +2.5% / +4.5% / +7.0% / +10% (rungs 1–4)</span>
      <span class="pill">Buyback 1% / 2.5% / 3.5% / 5%</span>
      <span class="pill">20 cycles</span>
      <div class="pill">Row 1 Buy = Start Price</div>
      <div class="pill">nextBuy = prevSell × (1 − buyback%)</div>
      <div class="pill">sell = buy × (1 + sell%)</div>
    </div>
  </div>

  <div id="assetsRoot"></div>
</div>

<script>
const SELL_STEPS = [0.025, 0.045, 0.07, 0.10];
const BUYBACK_STEPS = [0.01, 0.025, 0.035, 0.05];
const CYCLES = 20;

const els = {
  ticker: document.getElementById('ticker'),
  rungs:  document.getElementById('rungs'),
  start:  document.getElementById('start'),
  shares: document.getElementById('shares'),
  addBtn: document.getElementById('addBtn'),
  saveBtn: document.getElementById('saveBtn'),
  loadBtn: document.getElementById('loadBtn'),
  fileInput: document.getElementById('fileInput'),
  csvBtn: document.getElementById('csvBtn'),
  clearBtn: document.getElementById('clearBtn'),
  root:   document.getElementById('assetsRoot')
};

function loadState(){
  try{
    return JSON.parse(localStorage.getItem('ladder_assets_v2')||'[]');
  }catch(e){ return []; }
}
function saveState(list){
  localStorage.setItem('ladder_assets_v2', JSON.stringify(list));
}
let state = loadState();

function fmt(n){ return Number(n).toFixed(2); }

function buildRows(start, rungIndex, defaultShares){
  const sellPct = SELL_STEPS[rungIndex];
  const buyback = BUYBACK_STEPS[rungIndex];
  const rows = [];
  let buy = Number(start);
  for(let i=0;i<CYCLES;i++){
    const sell = buy*(1+sellPct);
    const profit = sell - buy;
    rows.push({
      buy: +fmt(buy),
      sell: +fmt(sell),
      profit: +fmt(profit),
      shares: defaultShares
    });
    // next cycle
    buy = sell*(1 - buyback);
  }
  return rows;
}

function upsertAsset(){
  const name = (els.ticker.value||'').trim();
  const rungs = parseInt(els.rungs.value,10);
  const start = parseFloat(els.start.value);
  const defShares = parseInt(els.shares.value,10)||1;
  if(!name || isNaN(start)){ alert('Enter Ticker and Start Price'); return; }

  // Create asset with N rungs
  const asset = {
    name,
    start:+fmt(start),
    rungs,
    defShares,
    // each rung has rows
    ladders: Array.from({length:rungs}, (_,ri)=>buildRows(start, ri, defShares)),
    collapsed:false
  };

  // replace if exists
  const idx = state.findIndex(a=>a.name.toLowerCase()===name.toLowerCase());
  if(idx>=0) state[idx]=asset; else state.push(asset);
  saveState(state);
  render();
  // scroll asset into view
  const el = document.querySelector(`[data-asset="${name}"]`);
  if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
}

function render(){
  els.root.innerHTML='';
  if(state.length===0){
    const empty=document.createElement('div');
    empty.className='card'; empty.innerHTML='<div class="muted">No assets yet. Add one above.</div>';
    els.root.appendChild(empty); return;
  }
  state.forEach(asset=>{
    const wrapper=document.createElement('details');
    wrapper.className='asset card';
    wrapper.dataset.asset=asset.name;
    if(!asset.collapsed) wrapper.setAttribute('open','');

    const summary=document.createElement('summary');
    summary.innerHTML=`<div><span class="section-title">${asset.name}</span>
      <span class="pill">${asset.rungs} rung(s)</span>
      <span class="pill">start $${fmt(asset.start)}</span></div>
      <div class="right">
        <button class="btn small ghost" data-action="toggle">Toggle</button>
        <button class="btn small danger" data-action="delete">Delete</button>
      </div>`;
    wrapper.appendChild(summary);

    // badges for rung-level percentages
    const badges=document.createElement('div');
    for(let r=0;r<asset.rungs;r++){
      const pill=document.createElement('span');
      pill.className='pill';
      pill.textContent=`Rung ${r+1}: Sell ${Math.round(SELL_STEPS[r]*1000)/10}% • Buyback ${Math.round(BUYBACK_STEPS[r]*1000)/10}%`;
      badges.appendChild(pill);
    }
    wrapper.appendChild(badges);

    for(let r=0;r<asset.rungs;r++){
      const table=document.createElement('table');
      table.innerHTML=`
        <thead>
          <tr>
            <th class="muted">#</th>
            <th>Planned Buy</th>
            <th>Planned Sell</th>
            <th>Profit/Share</th>
            <th>Planned Shares</th>
            <th>Planned Total</th>
          </tr>
        </thead>
        <tbody></tbody>`;
      const tbody=table.querySelector('tbody');
      asset.ladders[r].forEach((row,i)=>{
        const tr=document.createElement('tr');
        const total = row.profit * (row.shares||0) + 0;
        tr.innerHTML = `
          <td class="num">${i+1}</td>
          <td><input class="cell-input w-money" type="number" step="0.01" value="${fmt(row.buy)}" data-role="buy"></td>
          <td><input class="cell-input w-money" type="number" step="0.01" value="${fmt(row.sell)}" data-role="sell"></td>
          <td class="num">$${fmt(row.profit)}</td>
          <td><input class="cell-input w-shares" type="number" step="1" value="${row.shares}" data-role="shares"></td>
          <td class="num" data-role="total">$${fmt(total)}</td>
        `;
        // listeners to keep profit/total aligned when user edits
        tr.querySelectorAll('input').forEach(inp=>{
          inp.addEventListener('input', (e)=>{
            const role=e.target.dataset.role;
            const value=parseFloat(e.target.value)||0;
            if(role==='buy'){ row.buy=value; }
            if(role==='sell'){ row.sell=value; }
            if(role==='shares'){ row.shares=parseInt(value,10)||0; }
            row.profit = +(row.sell - row.buy).toFixed(2);
            tr.children[3].textContent = '$'+fmt(row.profit);
            tr.querySelector('[data-role="total"]').textContent = '$'+fmt((row.shares||0)*row.profit);
            saveState(state);
          });
        });
        tbody.appendChild(tr);
      });
      const rungTitle=document.createElement('div');
      rungTitle.className='section-title';
      rungTitle.textContent=`Rung ${r+1}`;
      wrapper.appendChild(rungTitle);
      wrapper.appendChild(table);
    }

    // summary actions
    summary.addEventListener('click',(ev)=>{
      // stop default details toggle; we control with button
      const isBtn = ev.target.closest('button');
      if(!isBtn){ ev.preventDefault(); }
    });
    summary.querySelector('[data-action="toggle"]').addEventListener('click',(ev)=>{
      ev.stopPropagation();
      asset.collapsed = !wrapper.hasAttribute('open');
      if(wrapper.hasAttribute('open')) wrapper.removeAttribute('open'); else wrapper.setAttribute('open','');
      saveState(state);
    });
    summary.querySelector('[data-action="delete"]').addEventListener('click',(ev)=>{
      ev.stopPropagation();
      if(confirm('Delete this ladder?')){
        state = state.filter(a=>a.name!==asset.name);
        saveState(state); render();
      }
    });

    els.root.appendChild(wrapper);
  });
}

// CSV + backup helpers
els.saveBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='ladder_backup.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});
els.loadBtn.addEventListener('click', ()=> els.fileInput.click());
els.fileInput.addEventListener('change', (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload=()=>{ try{ state=JSON.parse(fr.result||'[]'); saveState(state); render(); }catch(err){ alert('Invalid JSON'); } };
  fr.readAsText(file);
});
els.csvBtn.addEventListener('click', ()=>{
  const rows = [['Ticker','Rung','#','Planned Buy','Planned Sell','Profit/Share','Planned Shares','Planned Total']];
  state.forEach(a=>a.ladders.forEach((ladder,ri)=>ladder.forEach((row,i)=>{
    rows.push([a.name, ri+1, i+1, row.buy, row.sell, row.profit, row.shares, +(row.profit*(row.shares||0)).toFixed(2)]);
  })));
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='ladder_export.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});
els.clearBtn.addEventListener('click', ()=>{
  if(confirm('Clear all data on this device?')){
    state=[]; saveState(state); render();
  }
});

els.addBtn.addEventListener('click', upsertAsset);

// initial render
render();
</script>
</body>
</html>
