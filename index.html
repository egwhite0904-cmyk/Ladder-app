<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ladder App ‚Äî Ladders + Charts</title>
<meta name="theme-color" content="#0a7">
<style>
:root{
  --fg:#111;--bg:#f7f7f7;--panel:#fff;--muted:#666;--accent:#0a7;
  --border:#e3e3e3;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
header{background:var(--accent);color:#fff;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:8px;position:sticky;top:0;z-index:1}
header h1{font-size:20px;margin:0;display:flex;align-items:center;gap:8px}
header h1 .logo{font-size:22px}
nav{display:flex;gap:8px}
button.tab{border:none;background:#fff1;color:#fff;padding:8px 14px;border-radius:10px;font-weight:600}
button.tab.active{background:#fff;color:#0a7}
.container{max-width:1000px;margin:14px auto;padding:0 12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:700px){.row{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);font-size:16px}
button.primary{background:var(--accent);color:#fff;border:none;font-weight:700}
button.danger{background:#c33;color:#fff;border:none}
.badge{display:inline-block;background:#eee;border:1px solid var(--border);border-radius:999px;padding:3px 10px;font-size:12px;color:#333;margin-right:6px}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px}
th{position:sticky;top:54px;background:var(--panel);z-index:1}
.small{font-size:12px;color:var(--muted)}
.right{text-align:right}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.notice{background:#fffbcc;border:1px solid #f3e69a;padding:10px;border-radius:10px;font-size:13px}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{background:#fafafa;border:1px solid var(--border);padding:10px;border-radius:10px}
.kpi .v{font-size:20px;font-weight:800}
footer{color:#888;font-size:12px;padding:30px 12px;text-align:center}
.help{cursor:help;border-bottom:1px dotted #777}
</style>
</head>
<body>
<header>
  <h1><span class="logo">üìà</span> Ladder App</h1>
  <nav>
    <button class="tab active" id="tab-ladders">Ladders</button>
    <button class="tab" id="tab-charts">Charts</button>
  </nav>
</header>

<div class="container">
  <section id="page-ladders">
    <div class="card">
      <div class="kpis" id="portfolio-kpis">
        <div class="kpi"><div class="small">Realized P/L (all)</div><div class="v" id="kpi-pl">$0.00</div></div>
        <div class="kpi"><div class="small"># of Assets</div><div class="v" id="kpi-assets">0</div></div>
        <div class="kpi"><div class="small">Open Rows</div><div class="v" id="kpi-open">0</div></div>
      </div>
    </div>

    <div class="card">
      <h3>Add / Edit Asset</h3>
      <div class="row">
        <div><label>Ticker / Name</label><input id="in-ticker" placeholder="e.g., RIOT or CVS"></div>
        <div>
          <label>Rungs</label>
          <select id="in-rungs">
            <option value="3">3 Rungs</option>
            <option value="4">4 Rungs</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Start Price</label><input id="in-start" inputmode="decimal" placeholder="current price"></div>
        <div><label>Default Shares per row</label><input id="in-shares" inputmode="numeric" value="1"></div>
      </div>
      <div class="row">
        <div>
          <button class="primary" id="btn-add">+ Add / Replace Asset</button>
        </div>
        <div class="small" style="align-self:center">
          <span class="help" title="Sell ladder % are fixed: 3 rungs = +2.5%, +4.5%, +7%. 4 rungs adds +9%. Buybacks: 3 rungs = 1%, 2.5%, 3.5%. 4 rungs adds 5%. Applies to all 20 cycles. Edit any value in the table inline.">‚ÑπÔ∏è Rungs use locked % (tap for details)</span>
        </div>
      </div>
    </div>

    <div id="assets"></div>
  </section>

  <section id="page-charts" style="display:none">
    <div class="card">
      <div class="row">
        <div><label>From</label><input id="date-from" type="date"></div>
        <div><label>To</label><input id="date-to" type="date"></div>
      </div>
      <div class="row">
        <div><button class="primary" id="btn-update-chart">Update Chart</button></div>
        <div style="align-self:center" class="small">Uses rows with Sell Date + Actual prices + Qty to compute realized P/L.</div>
      </div>
    </div>
    <div class="card">
      <canvas id="chart" height="180"></canvas>
    </div>
  </section>
</div>

<footer>Data auto-saves on this device ‚Ä¢ v23</footer>

<script>
// ---------- Config (locked %) ----------
const SELL_PCTS = { 3:[2.5,4.5,7], 4:[2.5,4.5,7,9] };
const BUYBK_PCTS = { 3:[1,2.5,3.5], 4:[1,2.5,3.5,5] };
const CYCLES = 20;

// ---------- State & storage ----------
const LS_KEY = 'ladder_app_v23';
let state = { assets: [] };
function load() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) state = JSON.parse(raw);
  } catch(e){ console.warn('load fail', e); }
}
function save() {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
load();

// ---------- Helpers ----------
const fmt = n => '$' + (Math.round(n*100)/100).toFixed(2);
function pct(n){ return n/100; }
function el(tag, attrs={}, ...kids){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') e.className=v;
    else if(k==='html') e.innerHTML=v;
    else e.setAttribute(k,v);
  });
  kids.forEach(k=>{ if(k) e.append(k); });
  return e;
}

// ---------- Build ladder rows for one rung ----------
function makeRungRows(startPrice, sellPct, buybkPct, cycles, defaultShares){
  const rows = [];
  // sell price is fixed off start for this rung
  const sell = startPrice*(1+pct(sellPct));
  const buy = sell*(1-pct(buybkPct)); // buyback relative to sell (your spec)
  const profitPerShare = sell-buy;
  for(let i=1;i<=cycles;i++){
    rows.push({
      cycle:i,
      plannedBuy: +buy.toFixed(2),
      plannedSell: +sell.toFixed(2),
      profitShare: +profitPerShare.toFixed(2),
      plannedShares: i===1? defaultShares*33 : defaultShares, // first row lives larger (tweak inline)
      plannedTotal: +(profitPerShare * (i===1? defaultShares*33 : defaultShares)).toFixed(2),
      sellDate:"", actualBuy:"", actualSell:"", qty:"", realized:0, status:""
    });
  }
  return rows;
}

// ---------- Asset rendering ----------
function render(){
  const wrap = document.getElementById('assets');
  wrap.innerHTML='';
  document.getElementById('kpi-assets').textContent = state.assets.length;
  let openRows=0, realized=0;
  state.assets.forEach(asset=>{
    // compute KPIs
    asset.rungs.forEach(r=>r.rows.forEach(row=>{
      if(row.status!=='closed') openRows++;
      realized += Number(row.realized||0);
    }));
    // card
    const card = el('div',{class:'card'});
    const title = el('div',{style:'display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;'});
    title.append(el('div',{html:`<span class="badge">${asset.ticker}</span> <span class="badge">${asset.rungs.length} rung(s)</span> <span class="badge">start ${fmt(asset.startPrice)}</span>`}));
    const btns = el('div',{class:'grid2'});
    const build = el('button',{class:'primary'},'Build Ladder');
    build.onclick = ()=>{
      // rebuild rows using current start (use locked %)
      asset.rungs = buildRungs(asset.startPrice, asset.rungs.length, asset.defaultShares);
      save(); render();
    };
    const csv = el('button',{},'Export CSV');
    csv.onclick = ()=> exportCSV(asset);
    const del = el('button',{class:'danger'},'Delete Ladder');
    del.onclick = ()=>{ if(confirm('Delete this asset ladder?')){ state.assets = state.assets.filter(a=>a.id!==asset.id); save(); render(); } };
    btns.append(build,csv);
    title.append(btns,del);
    card.append(title);

    const note = el('div',{class:'small',html:`Rungs use locked defaults: Sell ${SELL_PCTS[asset.rungs.length].map(x=>`+${x}%`).join(', ')} ‚Ä¢ Buyback ${BUYBK_PCTS[asset.rungs.length].map(x=>`${x}%`).join(', ')} ‚Ä¢ ${CYCLES} cycles. Edit any cell inline.`});
    card.append(note);

    // each rung table
    asset.rungs.forEach((rung,idx)=>{
      const h = el('h4',{html:`${asset.ticker} ‚Äî Rung ${idx+1} &nbsp; <span class="small">Sell +${rung.sellPct}% &nbsp;‚Ä¢&nbsp; Buyback ${rung.buybkPct}%</span>`});
      card.append(h);
      const table = el('table');
      table.append(el('thead',{}, el('tr',{},
        el('th',{},'#'),
        el('th',{},'Planned Buy'),
        el('th',{},'Planned Sell'),
        el('th',{},'Profit/Share'),
        el('th',{},'Planned Shares'),
        el('th',{},'Planned Total'),
        el('th',{},'Sell Date'),
        el('th',{},'Actual Buy'),
        el('th',{},'Actual Sell'),
        el('th',{},'Qty'),
        el('th',{},'Realized P/L'),
        el('th',{},'Status')
      )));
      const tb = el('tbody');
      rung.rows.forEach(row=>{
        const tr = el('tr',{});
        function makeNumCell(key, step='0.01'){
          const inp = el('input',{value: row[key]??'', type:'number', step:step});
          inp.onchange = ()=>{ row[key] = inp.value===''? '' : Number(inp.value); recalcRow(row); save(); renderKPIs(); };
          return inp;
        }
        function makeTxtCell(key){
          const inp = el('input',{value: row[key]??'', type:'text'});
          inp.onchange = ()=>{ row[key]=inp.value; if(key==='sellDate'){ /* noop */ } save(); renderKPIs(); };
          return inp;
        }
        tr.append(
          el('td',{}, row.cycle),
          el('td',{}, makeNumCell('plannedBuy')),
          el('td',{}, makeNumCell('plannedSell')),
          el('td',{}, el('span',{}, fmt(row.profitShare))),
          el('td',{}, makeNumCell('plannedShares','1')),
          el('td',{}, el('span',{}, fmt(row.plannedTotal))),
          el('td',{}, makeTxtCell('sellDate')),
          el('td',{}, makeNumCell('actualBuy')),
          el('td',{}, makeNumCell('actualSell')),
          el('td',{}, makeNumCell('qty','1')),
          el('td',{}, el('span',{}, fmt(row.realized||0))),
          el('td',{}, makeTxtCell('status'))
        );
        tb.append(tr);
      });
      table.append(tb);
      card.append(table);
    });
    wrap.append(card);
  });
  document.getElementById('kpi-open').textContent = openRows;
  document.getElementById('kpi-pl').textContent = fmt(realized);
}
function renderKPIs(){
  let open=0, r=0;
  state.assets.forEach(a=>a.rungs.forEach(g=>g.rows.forEach(row=>{
    if(row.status!=='closed') open++;
    r += Number(row.realized||0);
  })) );
  document.getElementById('kpi-open').textContent=open;
  document.getElementById('kpi-pl').textContent=fmt(r);
}

// recalc plannedTotal & realized when numbers change
function recalcRow(row){
  row.plannedTotal = Number(((row.profitShare||0)*(row.plannedShares||0)).toFixed(2));
  if(row.qty && row.actualBuy && row.actualSell){
    row.realized = Number(((row.actualSell-row.actualBuy)*row.qty).toFixed(2));
  } else {
    row.realized = 0;
  }
}

// build rungs from start price
function buildRungs(startPrice, rungCount, defaultShares){
  const sells = SELL_PCTS[rungCount];
  const buys = BUYBK_PCTS[rungCount];
  const rungs = [];
  for(let i=0;i<rungCount;i++){
    rungs.push({
      sellPct: sells[i],
      buybkPct: buys[i],
      rows: makeRungRows(startPrice, sells[i], buys[i], CYCLES, Number(defaultShares||1))
    });
  }
  return rungs;
}

// add/replace asset
document.getElementById('btn-add').onclick = ()=>{
  const ticker = (document.getElementById('in-ticker').value||'').trim().toUpperCase();
  const rungCount = Number(document.getElementById('in-rungs').value||3);
  const start = Number((document.getElementById('in-start').value||'').trim());
  const defShares = Number((document.getElementById('in-shares').value||'1').trim());
  if(!ticker || !start){ alert('Enter ticker and start price.'); return; }
  const ex = state.assets.find(a=>a.ticker===ticker);
  const asset = { id: ex? ex.id : (Date.now()+Math.random()).toString(36), ticker, startPrice:start, defaultShares:defShares, rungs:buildRungs(start, rungCount, defShares) };
  if(ex){
    const i = state.assets.findIndex(a=>a.id===ex.id);
    state.assets[i]=asset;
  }else{
    state.assets.push(asset);
  }
  save(); render();
};

// export CSV for one asset
function exportCSV(asset){
  const rows=[['Asset','Rung','Cycle','Planned Buy','Planned Sell','Profit/Share','Planned Shares','Planned Total','Sell Date','Actual Buy','Actual Sell','Qty','Realized','Status']];
  asset.rungs.forEach((r,ri)=>r.rows.forEach(row=>{
    rows.push([asset.ticker,ri+1,row.cycle,row.plannedBuy,row.plannedSell,row.profitShare,row.plannedShares,row.plannedTotal,row.sellDate,row.actualBuy,row.actualSell,row.qty,row.realized,row.status]);
  }));
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${asset.ticker}_ladder.csv`;
  a.click();
}

// tabs
document.getElementById('tab-ladders').onclick = ()=>{
  document.getElementById('tab-ladders').classList.add('active');
  document.getElementById('tab-charts').classList.remove('active');
  document.getElementById('page-ladders').style.display='block';
  document.getElementById('page-charts').style.display='none';
};
document.getElementById('tab-charts').onclick = ()=>{
  document.getElementById('tab-charts').classList.add('active');
  document.getElementById('tab-ladders').classList.remove('active');
  document.getElementById('page-charts').style.display='block';
  document.getElementById('page-ladders').style.display='none';
  drawChart();
};

// simple bar chart (no external libs)
function drawChart(){
  const c = document.getElementById('chart');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  // collect realized grouped by sellDate
  const from = document.getElementById('date-from').value;
  const to = document.getElementById('date-to').value;
  const byDate = {};
  state.assets.forEach(a=>a.rungs.forEach(g=>g.rows.forEach(row=>{
    const d=row.sellDate? row.sellDate.trim():'';
    if(!d) return;
    if(from && d<from) return;
    if(to && d>to) return;
    const val = Number(row.realized||0);
    byDate[d]=(byDate[d]||0)+val;
  })));
  const dates = Object.keys(byDate).sort();
  const vals = dates.map(d=>byDate[d]);

  // axes
  const W=c.width, H=c.height, pad=30;
  const max = Math.max(10, ...vals.map(v=>Math.abs(v))) * 1.2;
  ctx.strokeStyle='#ccc'; ctx.beginPath();
  ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();

  // bars
  const bw = (W-2*pad)/Math.max(1,dates.length);
  ctx.fillStyle='#8ec5ff';
  dates.forEach((d,i)=>{
    const v=vals[i];
    const h = (v/max)*(H-2*pad);
    const x = pad + i*bw + 2;
    const y = (v>=0)? (H-pad-h) : (H-pad);
    ctx.fillRect(x,y,bw-4,Math.abs(h));
  });
}

// init & first paint
render();
</script>
</body>
</html>
