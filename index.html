<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ladder App</title>
<meta name="theme-color" content="#0a7">
<style>
:root{
  --bg:#f6f7f8;--panel:#fff;--ink:#111;--muted:#666;--accent:#0a7;--warn:#d33;--ok:#0a7;
  --input:#f9fafb;--line:#e3e7eb;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 -apple-system,system-ui,Arial}
header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--accent);color:#fff;position:sticky;top:0;z-index:2}
header .logo{font-size:22px;font-weight:700}
header .logo:before{content:"ðŸªœ";margin-right:.4rem}
header .tabs{margin-left:auto;display:flex;gap:10px}
header .tabs button{border:0;border-radius:10px;padding:8px 12px;background:#fff1;border:1px solid #fff5;color:#fff}
header .tabs button.active{background:#fff;color:var(--accent);border-color:#fff}

main{max-width:900px;margin:16px auto;padding:0 12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:14px}
h1{font-size:20px;margin:0 0 10px}
h2{font-size:18px;margin:0 0 12px}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:640px){.grid{grid-template-columns:1fr}}

label{display:block;font-size:13px;color:var(--muted);margin:6px 0 4px}
input,select,button{width:100%;padding:11px 12px;border-radius:10px;border:1px solid var(--line);background:var(--input);font-size:16px}
input[type="number"]{font-variant-numeric:tabular-nums}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
button.danger{background:var(--warn);color:#fff;border-color:var(--warn)}
button.ghost{background:#fff}

.help{background:#fffbdd;border:1px solid #f0e6a6;border-radius:10px;padding:10px 12px;color:#6b6300;font-size:13px}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th,.table td{padding:8px 8px}
.table thead th{font-size:12px;color:var(--muted);text-align:left}
.row{display:grid;grid-template-columns:52px repeat(5, minmax(88px,1fr));gap:8px;align-items:center}
.row input{width:100%;padding:10px 10px;border-radius:9px;border:1px solid var(--line);background:#fff;font-size:16px}
.row .n{text-align:center;color:var(--muted)}
.badge{display:inline-flex;align-items:center;gap:6px;background:#eef7f1;border:1px solid #d7efe0;color:#0a6;border-radius:999px;padding:5px 10px;font-size:12px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.right{margin-left:auto}
.small{font-size:12px;color:var(--muted)}
footer{padding:24px 0 40px;color:#888;text-align:center}
.hide{display:none}
</style>
</head>
<body>
<header>
  <div class="logo">Ladder App</div>
  <div class="tabs">
    <button id="tabLadders" class="active">Ladders</button>
    <button id="tabCharts">Charts</button>
  </div>
  <div class="small">auto-save enabled</div>
</header>

<main>
  <!-- Add / Replace -->
  <section id="panelLadders">
    <div class="card">
      <h1>Add / Replace Asset</h1>
      <div class="grid">
        <div>
          <label>Ticker / Name</label>
          <input id="ticker" placeholder="e.g., RIOT or BTC">
        </div>
        <div>
          <label>Rungs</label>
          <select id="rungs">
            <option value="2">2 rungs</option>
            <option value="3" selected>3 rungs</option>
            <option value="4">4 rungs</option>
          </select>
        </div>
        <div>
          <label>Start Price</label>
          <input id="startPrice" inputmode="decimal" placeholder="current price">
        </div>
        <div>
          <label>Default Shares per row</label>
          <input id="defaultQty" inputmode="numeric" value="1">
        </div>
      </div>
      <div class="help" style="margin-top:12px">
        Presets (locked): Sell +2.5%, +4.5%, +7%, +10% (first 2â€“4 rungs based on selection).
        Buyback 1%, 2.5%, 3.5%, 5% (rungs 1â€“4). Row 1 Planned Buy equals Start Price;
        next rows use: <b>nextBuy = prevSell Ã— (1 âˆ’ buyback%)</b> and <b>sell = buy Ã— (1 + sell%)</b>. 20 cycles.
      </div>

      <div class="flex" style="margin-top:12px">
        <button id="addAsset" class="primary" style="min-width:180px">+ Add / Replace Asset</button>
        <button id="saveJson" class="ghost">Save Backup (JSON)</button>
        <button id="loadJson" class="ghost">Restore Backup (JSON)</button>
        <button id="clearAll" class="danger">Clear All (this device)</button>
      </div>
    </div>

    <div id="assets"></div>
  </section>

  <!-- Charts -->
  <section id="panelCharts" class="hide">
    <div class="card">
      <h1>Charts</h1>
      <p class="small">Charts view placeholder (kept so your link wonâ€™t break). Weâ€™ll plug the realized P/L chart here after your ladder tables are fully settled.</p>
    </div>
  </section>

  <footer class="small">v2.2 â€“ mobile-friendly inputs, CSV export, autosave, fixed add button</footer>
</main>

<script>
/* ========= Utilities ========= */
const $ = sel => document.querySelector(sel);
const el = (tag, cls) => { const e = document.createElement(tag); if(cls) e.className = cls; return e; };
const fmtMoney = n => isFinite(n) ? '$' + n.toFixed(2) : '';

const SELL_PCTS = [0.025, 0.045, 0.07, 0.10];      // rung 1..4
const BUYBACK_PCTS = [0.01, 0.025, 0.035, 0.05];   // rung 1..4
const CYCLES = 20;

const LS_KEY = 'ladder_assets_v22';

/* ========= State ========= */
let assets = loadAssets();

/* ========= Wiring ========= */
$('#tabLadders').onclick = () => { $('#panelLadders').classList.remove('hide'); $('#panelCharts').classList.add('hide'); $('#tabLadders').classList.add('active'); $('#tabCharts').classList.remove('active'); };
$('#tabCharts').onclick = () => { $('#panelCharts').classList.remove('hide'); $('#panelLadders').classList.add('hide'); $('#tabCharts').classList.add('active'); $('#tabLadders').classList.remove('active'); };

$('#addAsset').onclick = () => {
  const ticker = ($('#ticker').value || '').trim().toUpperCase();
  const start = parseFloat(($('#startPrice').value || '').trim());
  const rungs = parseInt($('#rungs').value,10);
  const qty = Math.max(0, parseInt($('#defaultQty').value,10) || 0);

  if(!ticker){ alert('Enter a ticker/name'); return; }
  if(!isFinite(start)){ alert('Enter a valid start price'); return; }

  const tables = [];
  for(let r=1;r<=rungs;r++){
    const sellPct = SELL_PCTS[r-1] || SELL_PCTS[SELL_PCTS.length-1];
    const buyback = BUYBACK_PCTS[r-1] || BUYBACK_PCTS[BUYBACK_PCTS.length-1];
    const rows = [];
    let buy = start;               // Row 1 buy = start price
    for(let i=1;i<=CYCLES;i++){
      const sell = buy * (1 + sellPct);
      const profit = sell - buy;
      rows.push({
        n:i,
        buy:+buy.toFixed(2),
        sell:+sell.toFixed(2),
        profit:+profit.toFixed(2),
        qty:qty
      });
      // next row buy uses previous row's sell with buyback %
      buy = sell * (1 - buyback);
    }
    tables.push({ rung:r, sellPct, buyback, rows });
  }

  // Replace or add
  const idx = assets.findIndex(a => a.ticker === ticker);
  const obj = { ticker, start:+start, rungs, qty, tables };
  if(idx>=0) assets[idx] = obj; else assets.push(obj);
  saveAssets(); renderAssets();
};

$('#saveJson').onclick = () => {
  const blob = new Blob([JSON.stringify(assets,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ladder_backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
};

$('#loadJson').onclick = () => {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.json,application/json';
  inp.onchange = () => {
    const file = inp.files[0]; if(!file) return;
    const fr = new FileReader();
    fr.onload = () => { try {
      assets = JSON.parse(fr.result); saveAssets(); renderAssets();
    } catch(e){ alert('Bad JSON'); } };
    fr.readAsText(file);
  };
  inp.click();
};

$('#clearAll').onclick = () => {
  if(confirm('Delete all ladders stored on this device?')){ assets = []; saveAssets(); renderAssets(); }
};

/* ========= Storage ========= */
function saveAssets(){ localStorage.setItem(LS_KEY, JSON.stringify(assets)); }
function loadAssets(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]') }catch(e){ return [] }
}

/* ========= Render ========= */
function renderAssets(){
  const wrap = $('#assets');
  wrap.innerHTML = '';
  if(!assets.length){
    const c = el('div','card small');
    c.textContent = 'No assets yet. Add one above, then tap â€œ+ Add / Replace Assetâ€.';
    wrap.appendChild(c);
    return;
  }

  assets.forEach(asset=>{
    const card = el('div','card');
    const head = el('div','flex');
    head.innerHTML = `
      <div class="badge">${asset.ticker}</div>
      <div class="badge">${asset.rungs} rung(s)</div>
      <div class="badge">start ${asset.start.toFixed(2)}</div>
      <span class="right"></span>
      <button class="ghost" data-act="csv">Export CSV (Excel)</button>
      <button class="danger" data-act="del">Delete Ladder</button>
    `;
    card.appendChild(head);

    const hint = el('div','small');
    hint.style.margin='8px 0 12px';
    hint.textContent = 'Rungs use locked defaults: Sell +2.5%, +4.5%, +7%, +10% â€¢ Buyback 1%, 2.5%, 3.5%, 5% â€¢ 20 cycles. Edit any cell inline.';
    card.appendChild(hint);

    asset.tables.forEach(t=>{
      const title = el('div','flex');
      title.style.margin='8px 0';
      title.innerHTML = `<div style="font-weight:700">${asset.ticker} â€” Rung ${t.rung}</div>
      <span class="badge">Sell +${(t.sellPct*100).toFixed(1)}%</span>
      <span class="badge">Buyback ${(t.buyback*100).toFixed(1)}%</span>`;
      card.appendChild(title);

      // table body
      for(const row of t.rows){
        const r = el('div','row');
        // wider boxes + tabular numbers
        r.innerHTML = `
          <div class="n">${row.n}</div>
          <input value="${row.buy.toFixed(2)}" inputmode="decimal">
          <input value="${row.sell.toFixed(2)}" inputmode="decimal">
          <div class="n">${fmtMoney(row.profit)}</div>
          <input value="${row.qty}" inputmode="numeric">
          <div class="n">${fmtMoney(row.profit * (row.qty||0))}</div>
        `;
        card.appendChild(r);
      }
    });

    // actions
    card.onclick = e=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const act = btn.dataset.act;
      if(act==='del'){
        if(confirm(`Delete ${asset.ticker}?`)){
          assets = assets.filter(a=>a!==asset); saveAssets(); renderAssets();
        }
      }else if(act==='csv'){
        exportCSV(asset);
      }
    };

    wrap.appendChild(card);
  });
}

/* ========= CSV ========= */
function exportCSV(asset){
  const rows = [["Ticker","Rung","#","Planned Buy","Planned Sell","Profit/Share","Planned Shares","Planned Total"]];
  asset.tables.forEach(t=>{
    t.rows.forEach(r=>{
      rows.push([asset.ticker, t.rung, r.n, r.buy.toFixed(2), r.sell.toFixed(2), r.profit.toFixed(2), r.qty, (r.profit*(r.qty||0)).toFixed(2)]);
    });
  });
  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${asset.ticker}_ladder.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ========= Init ========= */
renderAssets();
</script>
</body>
</html>
