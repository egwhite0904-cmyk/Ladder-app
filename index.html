<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ladder App â€” v3 (Linear, Autosave, Charts)</title>
<style>
:root{--bg:#f8f9fb;--panel:#fff;--fg:#111;--muted:#666;--accent:#0a7;--danger:#c33;border-color:#ddd}
html,body{margin:0;background:var(--bg);color:var(--fg);font:15px -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;background:var(--accent);color:#fff;display:flex;align-items:center;gap:12px;padding:10px 12px;z-index:5}
h1{font-size:18px;margin:0 6px 0 0}
.tabs button{font:600 16px -apple-system,system-ui;padding:10px 16px;border:0;border-radius:10px;background:#fff;color:#000;margin-right:8px}
.tabs button.active{background:#e6fff5}
main{padding:14px}
.card{background:var(--panel);border:1px solid #e6e6e6;border-radius:12px;padding:14px;margin:12px 0}
label{display:block;font-weight:600;margin:8px 0 4px}
input,select,button{font:15px -apple-system,system-ui;padding:9px 11px;border:1px solid #ccc;border-radius:10px}
input[type="number"]{width:120px}
.small{font-size:12px;color:var(--muted)}
.badge{display:inline-block;background:#eef;border:1px solid #ccd;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
.btn{cursor:pointer;background:#fff;border:1px solid #bbb}
.btn.primary{background:var(--accent);border-color:#05996e;color:#fff}
.btn.danger{background:#fee;border-color:#f8c;color:#b00}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid #e6e6e6;padding:8px;text-align:right}
.table th:nth-child(1), .table td:nth-child(1){text-align:center;width:36px}
.table input{width:100%;padding:6px 8px}
.savebar{font-size:12px;color:#fff;margin-left:auto;opacity:.8}
.warn{color:#ffd;opacity:.9;margin-left:10px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpis .box{background:#fff;border:1px solid #eee;border-radius:10px;padding:10px}
.kpis .val{font-weight:700;font-size:20px}
hr{border:none;border-top:1px solid #eee;margin:12px 0}
canvas{max-width:100%;background:#fff;border:1px solid #eee;border-radius:12px}
.tooltip{border-bottom:1px dashed #777;cursor:help}
</style>
</head>
<body>
<header>
  <h1>ðŸ“ˆ Ladder App</h1>
  <div class="tabs">
    <button id="tabLadders" class="active">Ladders</button>
    <button id="tabCharts">Charts</button>
  </div>
  <div class="savebar">
    <span id="saveDot">saved</span>
    <span id="privateWarn" class="warn" style="display:none">Private mode: data wonâ€™t persist</span>
  </div>
</header>

<main>
  <section id="viewLadders">
    <div class="card">
      <div class="kpis">
        <div class="box"><div class="small">Realized P/L (all)</div><div id="kpiPL" class="val">$0.00</div></div>
        <div class="box"><div class="small"># of Assets</div><div id="kpiAssets" class="val">0</div></div>
        <div class="box"><div class="small">Open Rows</div><div id="kpiOpen" class="val">0</div></div>
        <div class="box"><div class="small">Closed Rows</div><div id="kpiClosed" class="val">0</div></div>
      </div>
    </div>

    <div class="card">
      <h3>Add / Replace Asset</h3>
      <div class="flex">
        <div>
          <label>Ticker / Name</label>
          <input id="inTicker" placeholder="e.g., RIOT or CVS">
        </div>
        <div>
          <label>Rungs</label>
          <select id="inRungs">
            <option value="2">2 Rungs</option>
            <option value="3" selected>3 Rungs</option>
            <option value="4">4 Rungs</option>
          </select>
        </div>
        <div>
          <label>Start Price</label>
          <input id="inStart" type="number" step="0.01" placeholder="current price">
        </div>
      </div>
      <div class="small" style="margin-top:8px">
        Rungs use locked % (tap for details):
        <span class="badge tooltip" title="R1: Sell +2.5%, Buyback 1%">R1 2.5% / 1%</span>
        <span class="badge tooltip" title="R2: Sell +4.5%, Buyback 2.5%">R2 4.5% / 2.5%</span>
        <span class="badge tooltip" title="R3: Sell +7.0%, Buyback 3.5%">R3 7% / 3.5%</span>
        <span class="badge tooltip" title="R4: Sell +10.0%, Buyback 5.0%">R4 10% / 5%</span>
        <span class="badge">20 cycles</span>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn primary" id="btnAdd">+ Add / Replace Asset</button>
        <button class="btn" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
      </div>
    </div>

    <div id="assets"></div>
  </section>

  <section id="viewCharts" style="display:none">
    <div class="card">
      <h3>Totals & Charts</h3>
      <div class="flex">
        <div>
          <label>Year</label>
          <input id="chartYear" type="number" step="1" value="2025">
        </div>
        <div style="align-self:end">
          <button class="btn primary" id="btnYearTotal">Year Total</button>
        </div>
      </div>
      <hr>
      <div class="flex">
        <div>
          <label>From</label>
          <input id="fromDate" type="date">
        </div>
        <div>
          <label>To</label>
          <input id="toDate" type="date">
        </div>
        <div style="align-self:end">
          <button class="btn" id="btnUpdateChart">Update Chart</button>
        </div>
      </div>
      <div style="margin-top:10px" class="small">Chart shows realized P/L by sell date (Actual Sell Ã— Qty âˆ’ Actual Buy Ã— Qty) using saved rows.</div>
    </div>
    <div class="card">
      <div class="small">Portfolio Total:</div>
      <div id="chartTotal" class="val" style="margin:6px 0 10px 0">$0.00</div>
      <canvas id="plChart" height="240"></canvas>
    </div>
  </section>
</main>

<script>
// ---------------- State ----------------
let state = {
  assets: [] // [{ticker,startPrice,cycles,rungs:[{sellPct,buybackPct,rows:[]},...] }]
};
const STORAGE_KEY = "ladder_app_state_v3";

// Preset rungs
const PRESETS = [
  {sellPct:0.025, buybackPct:0.01},
  {sellPct:0.045, buybackPct:0.025},
  {sellPct:0.070, buybackPct:0.035},
  {sellPct:0.100, buybackPct:0.050},
];

// ---------------- Helpers ----------------
function $(id){return document.getElementById(id)}
function el(tag, attrs={}, children=[]) {
  const n = document.createElement(tag);
  for (const k in attrs) {
    if (k==="class") n.className = attrs[k];
    else if (k==="html") n.innerHTML = attrs[k];
    else n.setAttribute(k, attrs[k]);
  }
  (Array.isArray(children)?children:[children]).forEach(c => {
    if (typeof c==="string") n.appendChild(document.createTextNode(c));
    else if (c) n.appendChild(c);
  });
  return n;
}
function round2(n){return Math.round((+n + Number.EPSILON)*100)/100}
function fmt(n){ if(n===""||n==null||isNaN(n)) return "$0.00"; return "$"+round2(n).toFixed(2); }

function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    const sd=$('saveDot'); sd.textContent="saved"; sd.style.opacity=1; setTimeout(()=>sd.style.opacity=.6,700);
  }catch(e){ console.warn("save failed", e); }
}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const obj=JSON.parse(raw); if(!obj||!obj.assets) return false;
    state=obj; return true;
  }catch(e){ return false; }
}

// ---------------- Ladder build (LINEAR) ----------------
function buildLadderLinear(asset){
  const N = asset.cycles || 20;
  const P0 = parseFloat(asset.startPrice);
  asset.rungs.forEach(rung => {
    const S = rung.sellPct, B = rung.buybackPct;
    const STEP = round2(P0 * S);
    rung.rows = [];
    for (let i=1;i<=N;i++){
      const buy = round2(P0 + (i-1)*STEP);
      const sell = round2(buy + STEP);
      const pps = round2(sell - buy);
      rung.rows.push({
        cycle:i, plannedBuy:buy, plannedSell:sell, profitPerShare:pps,
        plannedShares:1, plannedTotal:pps*1,
        buyDate:"", sellDate:"", actualBuy:"", actualSell:"", filledQty:"",
        realizedPL:0, deltaVsPlan:0, cumRealized:0
      });
    }
  });
}

// ---------------- Renderers ----------------
function renderAll(){
  const cont=$('assets'); cont.innerHTML="";
  $('kpiAssets').textContent = state.assets.length;
  let open=0, closed=0, pl=0;
  state.assets.forEach((a,ai)=>{
    // compute KPIs from rows
    a.rungs.forEach(r=>{
      r.rows.forEach(row=>{
        const qty = parseFloat(row.filledQty||0);
        if(qty>0 && row.actualSell && row.actualBuy){
          row.realizedPL = round2((row.actualSell - row.actualBuy)*qty);
          closed++;
          pl += row.realizedPL;
        }else{
          open++;
        }
      });
    });

    const card = el('div',{class:'card'});
    const head = el('div', {class:'flex'}, [
      el('div',{html:`<strong>${a.ticker}</strong> <span class="badge">${a.rungs.length} rung(s)</span> <span class="badge">start $${a.startPrice}</span>`}),
      el('div', {style:"margin-left:auto"}, [
        el('button',{class:'btn primary', onclick:()=>{buildLadderLinear(a); saveState(); renderAll();}}, "Build Ladder"),
        el('button',{class:'btn', style:"margin-left:8px", onclick:()=>exportCSV(a)}, "Export CSV"),
        el('button',{class:'btn danger', style:"margin-left:8px", onclick:()=>{ if(confirm('Delete ladder?')){ state.assets.splice(ai,1); saveState(); renderAll(); } }}, "Delete Ladder")
      ])
    ]);
    card.appendChild(head);
    card.appendChild(el('div',{class:'small',html:`Rungs use locked defaults: Sell +2.5%, +4.5%, +7%, +10% â€¢ Buyback 1%, 2.5%, 3.5%, 5% â€¢ 20 cycles. Edit any cell inline.`}));

    a.rungs.forEach((r,ri)=>{
      card.appendChild(el('h4',{html:`${a.ticker} â€” Rung ${ri+1}  <span class="small">â€¢  Sell +${(r.sellPct*100).toFixed(1)}%  â€¢  Buyback ${(r.buybackPct*100).toFixed(1)}%</span>`}));
      const table = el('table',{class:'table'});
      table.appendChild(el('thead',{}, el('tr',{},[
        el('th',{},'#'),
        el('th',{},'Planned Buy'),
        el('th',{},'Planned Sell'),
        el('th',{},'Profit/Share'),
        el('th',{},'Planned Shares'),
        el('th',{},'Planned Total'),
        el('th',{},'Buy Date'),
        el('th',{},'Sell Date'),
        el('th',{},'Actual Buy'),
        el('th',{},'Actual Sell'),
        el('th',{},'Filled Qty'),
        el('th',{},'Realized P/L'),
        el('th',{},'Î” vs Plan'),
        el('th',{},'Cum Realized')
      ])));
      const tb = el('tbody');
      let cum = 0;
      r.rows.forEach((row,ri2)=>{
        // recalc live
        const qty = parseFloat(row.filledQty||0);
        const plannedPL = round2((row.plannedSell - row.plannedBuy) * (row.plannedShares||1));
        const realized = (qty>0 && row.actualSell && row.actualBuy) ? round2((row.actualSell-row.actualBuy)*qty) : 0;
        row.realizedPL = realized;
        row.plannedTotal = round2((row.profitPerShare || (row.plannedSell-row.plannedBuy)) * (row.plannedShares||1));
        const delta = round2(realized - row.plannedTotal);
        cum = round2(cum + realized);
        row.deltaVsPlan = delta; row.cumRealized = cum;

        const tr = el('tr');
        tr.appendChild(el('td',{}, String(row.cycle)));
        tr.appendChild(el('td',{}, inputNum(row,'plannedBuy',ai,ri,ri2)));
        tr.appendChild(el('td',{}, inputNum(row,'plannedSell',ai,ri,ri2)));
        tr.appendChild(el('td',{}, fmt(row.profitPerShare)));
        tr.appendChild(el('td',{}, inputNum(row,'plannedShares',ai,ri,ri2,0,0,1)));
        tr.appendChild(el('td',{}, fmt(row.plannedTotal)));
        tr.appendChild(el('td',{}, inputDate(row,'buyDate',ai,ri,ri2)));
        tr.appendChild(el('td',{}, inputDate(row,'sellDate',ai,ri,ri2)));
        tr.appendChild(el('td',{}, inputNum(row,'actualBuy',ai,ri,ri2)));
        tr.appendChild(el('td',{}, inputNum(row,'actualSell',ai,ri,ri2)));
        tr.appendChild(el('td',{}, inputNum(row,'filledQty',ai,ri,ri2,0,0,0)));
        tr.appendChild(el('td',{}, fmt(row.realizedPL)));
        tr.appendChild(el('td',{}, fmt(row.deltaVsPlan)));
        tr.appendChild(el('td',{}, fmt(row.cumRealized)));
        tb.appendChild(tr);
      });
      table.appendChild(tb);
      card.appendChild(table);
    });

    cont.appendChild(card);
  });

  $('kpiOpen').textContent=open;
  $('kpiClosed').textContent=closed;
  $('kpiPL').textContent=fmt(pl);
}

function inputNum(row, key, ai,ri,ri2,min=null,max=null,int0=0){
  const inp = el('input',{type:'number', step:'0.01', value: row[key]!==undefined?row[key]:""});
  if (min!=null) inp.min=min;
  if (max!=null) inp.max=max;
  if (int0===1) inp.step='1';
  inp.addEventListener('input', e=>{
    const v = e.target.value===""? "" : (int0? parseInt(e.target.value||0,10): parseFloat(e.target.value||0));
    state.assets[ai].rungs[ri].rows[ri2][key] = v;
    // update derived
    const r = state.assets[ai].rungs[ri].rows[ri2];
    r.profitPerShare = round2((r.plannedSell||0) - (r.plannedBuy||0));
    r.plannedTotal = round2((r.profitPerShare||0) * (r.plannedShares||0));
    saveState();
    renderAll();
  });
  return inp;
}
function inputDate(row, key, ai,ri,ri2){
  const inp = el('input',{type:'date', value: row[key]||""});
  inp.addEventListener('input', e=>{
    state.assets[ai].rungs[ri].rows[ri2][key] = e.target.value;
    saveState(); renderAll();
  });
  return inp;
}

// ---------------- CSV export ----------------
function exportCSV(asset){
  const rows = [];
  asset.rungs.forEach((r,ri)=>{
    r.rows.forEach(row=>{
      rows.push({
        ticker: asset.ticker, rung: ri+1, cycle: row.cycle,
        plannedBuy: row.plannedBuy, plannedSell: row.plannedSell,
        profitPerShare: row.profitPerShare, plannedShares: row.plannedShares,
        plannedTotal: row.plannedTotal, buyDate: row.buyDate, sellDate: row.sellDate,
        actualBuy: row.actualBuy, actualSell: row.actualSell, filledQty: row.filledQty,
        realizedPL: row.realizedPL, deltaVsPlan: row.deltaVsPlan, cumRealized: row.cumRealized
      });
    });
  });
  const header = Object.keys(rows[0]||{a:1}).join(",");
  const body = rows.map(r=>Object.values(r).join(",")).join("\\n");
  const csv = header+"\\n"+body;
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = asset.ticker+"_ladder.csv";
  document.body.appendChild(a); a.click(); a.remove();
}

// ---------------- Charts ----------------
function computePLByDate(fromIso, toIso){
  const map = new Map(); // date->pl
  state.assets.forEach(a=>a.rungs.forEach(r=>r.rows.forEach(row=>{
    if(!row.sellDate) return;
    if(fromIso && row.sellDate < fromIso) return;
    if(toIso && row.sellDate > toIso) return;
    const qty = parseFloat(row.filledQty||0);
    if(!(qty>0 && row.actualSell && row.actualBuy)) return;
    const pl = round2((row.actualSell - row.actualBuy)*qty);
    map.set(row.sellDate, round2((map.get(row.sellDate)||0)+pl));
  })));
  // sort by date
  return Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
}

function drawChart(points){
  const cvs = $('plChart');
  const ctx = cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  const w=cvs.width, h=cvs.height, pad=30;
  const labels = points.map(p=>p[0].slice(5)); // MM-DD
  const values = points.map(p=>p[1]);
  const max = Math.max(10, ...values.map(v=>Math.abs(v)));
  // axes
  ctx.strokeStyle="#ccc"; ctx.beginPath();
  ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();
  // bars
  const barW = (w - pad*2) / Math.max(1, values.length);
  values.forEach((v,i)=>{
    const x = pad + i*barW + barW*0.1;
    const y0 = h - pad;
    const y = y0 - (v/max)*(h - pad*2);
    ctx.fillStyle = v>=0 ? "#7ec8a5" : "#f7a6a6";
    ctx.fillRect(x, Math.min(y,y0), barW*0.8, Math.abs(y0-y));
    ctx.fillStyle="#666"; ctx.font="10px -apple-system,system-ui";
    ctx.fillText(labels[i], x, h-6);
  });
  const total = round2(values.reduce((a,b)=>a+b,0));
  $('chartTotal').textContent = fmt(total);
}

// ---------------- UI wiring ----------------
function addOrReplaceAsset(){
  const ticker = $('inTicker').value.trim() || "TICKER";
  const rCount = parseInt($('inRungs').value,10);
  const start = parseFloat($('inStart').value||0);
  let a = state.assets.find(x=>x.ticker.toUpperCase()===ticker.toUpperCase());
  const rungs = PRESETS.slice(0,rCount).map(p=>({sellPct:p.sellPct, buybackPct:p.buybackPct, rows:[]}));
  const obj = {ticker, startPrice: start, cycles:20, rungs};
  if (a) {
    a.startPrice = start; a.rungs = rungs; a.cycles=20;
    buildLadderLinear(a);
  } else {
    buildLadderLinear(obj);
    state.assets.push(obj);
  }
  saveState(); renderAll();
}

$('btnAdd').addEventListener('click', addOrReplaceAsset);
$('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download="ladder_state.json"; a.click();
});
$('btnImport').addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept=".json";
  inp.onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    const fr = new FileReader(); fr.onload = ()=>{
      try{ state = JSON.parse(fr.result); saveState(); renderAll(); alert("Imported."); }catch(e){ alert("Bad JSON"); }
    }; fr.readAsText(f);
  }; inp.click();
});

$('tabLadders').addEventListener('click', ()=>{
  $('tabLadders').classList.add('active'); $('tabCharts').classList.remove('active');
  $('viewLadders').style.display="block"; $('viewCharts').style.display="none";
});
$('tabCharts').addEventListener('click', ()=>{
  $('tabCharts').classList.add('active'); $('tabLadders').classList.remove('active');
  $('viewLadders').style.display="none"; $('viewCharts').style.display="block";
  // initialize chart from current month if empty
  const pts = computePLByDate($('fromDate').value||null, $('toDate').value||null);
  drawChart(pts);
});

$('btnYearTotal').addEventListener('click', ()=>{
  const y = $('chartYear').value || new Date().getFullYear();
  const pts = computePLByDate(`${y}-01-01`, `${y}-12-31`);
  drawChart(pts);
});
$('btnUpdateChart').addEventListener('click', ()=>{
  const pts = computePLByDate($('fromDate').value||null, $('toDate').value||null);
  drawChart(pts);
});

// on boot
document.addEventListener('DOMContentLoaded', ()=>{
  const restored = loadState();
  if (!restored){
    // sample to show structure
    state.assets = [];
  }
  try{ localStorage.setItem("__t","1"); }catch(e){ $('privateWarn').style.display='inline'; }
  renderAll();
  // global input watcher to autosave
  document.body.addEventListener('input', saveState, {capture:true});
  window.addEventListener('beforeunload', saveState);
});
</script>
</body>
</html>
