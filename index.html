<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App v5 â€” Ladders + Charts</title>
<link rel="icon" href="data:,">
<style>
:root{--fg:#111;--bg:#f7f7f7;--panel:#fff;--accent:#0a7;--muted:#666}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
header{position:sticky;top:0;background:#0a7;color:#fff;z-index:5}
header .wrap{display:flex;align-items:center;gap:12px;padding:12px 14px}
h1{font-size:20px;margin:0 8px 0 0}
.tabs{margin-left:auto;display:flex;gap:8px}
.tabs button{appearance:none;border:0;border-radius:10px;padding:8px 14px;background:rgba(255,255,255,.15);color:#fff;font-weight:600}
.tabs button.active{background:#fff;color:#0a7}
main{max-width:980px;margin:16px auto;padding:0 12px 48px}
.card{background:var(--panel);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:14px;margin:12px 0}
h2{margin:6px 0 10px}
label{display:block;font-weight:600;margin:8px 0 6px}
input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd}
.row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.row .wide{grid-column:1/-1}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.actions button{background:var(--accent);color:#fff;border:0}
.actions .muted{background:#444}
.actions .warn{background:#c33}
.small{font-size:12px;color:var(--muted)}
.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:left;padding:10px}
thead th{position:sticky;top:56px;background:var(--panel);z-index:3}
tbody tr{background:var(--panel)}
tbody td:first-child, thead th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
tbody td:last-child, thead th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
.badge{display:inline-block;background:#eef;border:1px solid #dde;padding:2px 8px;border-radius:20px;font-size:12px;margin-right:6px}
.tag{background:#eee;border-radius:6px;padding:2px 6px;font-size:12px;margin-left:6px}
.right{text-align:right}
.center{text-align:center}
input[type="date"]{padding:8px}
hr{border:0;border-top:1px solid #eee;margin:12px 0}
@media (max-width:720px){
  .row{grid-template-columns:1fr 1fr}
  .summary{grid-template-columns:1fr 1fr}
  thead{display:none}
  tbody tr{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
  tbody td{border-radius:8px !important}
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ðŸ“ˆ Ladder App</h1>
    <div class="tabs">
      <button id="tabLadders" class="active">Ladders</button>
      <button id="tabCharts">Charts</button>
    </div>
    <div class="small" id="autosaveFlag">Auto-save enabled</div>
  </div>
</header>

<main>
  <section id="viewLadders">
    <div class="card">
      <h2>Add / Replace Asset</h2>
      <div class="row">
        <div>
          <label>Ticker / Name</label>
          <input id="ticker" placeholder="e.g., RIOT or CVS">
        </div>
        <div>
          <label>Rungs</label>
          <select id="rungs">
            <option>2 rungs</option>
            <option selected>3 rungs</option>
            <option>4 rungs</option>
          </select>
        </div>
        <div>
          <label>Start Price</label>
          <input id="startPrice" type="number" step="0.01" placeholder="current price">
        </div>
        <div>
          <label>Default Shares / row</label>
          <input id="defaultShares" type="number" step="1" value="1">
        </div>
      </div>
      <div class="small" style="margin:8px 0">
        Presets (locked by rung count): 
        <b>Sell</b> +2.5%, +4.5%, +7%, +10% â€¢ 
        <b>Buyback</b> 1%, 2.5%, 3.5%, 5%.
        First N are applied when N rungs selected.
        <div><b>Row 1 Buy = your Start Price.</b> From row 2 onward: Buy = (current row Sell) Ã— (1 âˆ’ buyback%).</div>
      </div>
      <div class="actions">
        <button id="addAsset">+ Add / Replace Asset</button>
        <button class="muted" id="exportJson">Export JSON</button>
        <button class="muted" id="importJson">Import JSON</button>
        <button class="warn" id="clearAll">Clear All (this device)</button>
      </div>
    </div>

    <div id="assets"></div>
  </section>

  <section id="viewCharts" style="display:none">
    <div class="card">
      <h2>Totals & Chart</h2>
      <div class="summary">
        <div class="card">
          <div class="small">Portfolio Realized P/L</div>
          <div id="portfolioTotal" style="font-weight:800;font-size:20px">$0.00</div>
        </div>
        <div class="card">
          <div class="small"># Assets</div>
          <div id="assetCount" style="font-weight:800;font-size:20px">0</div>
        </div>
        <div class="card">
          <div class="small">Open Rows</div>
          <div id="openRows" style="font-weight:800;font-size:20px">0</div>
        </div>
        <div class="card">
          <div class="small">Closed Rows</div>
          <div id="closedRows" style="font-weight:800;font-size:20px">0</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>From</label>
          <input id="fromDate" type="date">
        </div>
        <div>
          <label>To</label>
          <input id="toDate" type="date">
        </div>
        <div class="wide">
          <button id="updateChart">Update Chart</button>
        </div>
      </div>
      <div class="card">
        <canvas id="plChart" height="240"></canvas>
      </div>
      <div class="small">Chart uses rows with a Sell Date plus Actual Buy/Sell and Filled Qty to compute realized P/L per day.</div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const LS_KEY = 'ladder_assets_v5';
const presetsSell = [0.025, 0.045, 0.07, 0.10];
const presetsBuyback = [0.01, 0.025, 0.035, 0.05];
const CYCLES = 20;

let assets = load();

function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || []; }catch(e){ return []; } }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(assets)); }

function fmt(n){ return Number(n).toFixed(2); }
function money(n){ return '$' + fmt(n); }

function buildRungRows(start, sellPct, buyPct, defaultShares){
  const rows = [];
  let sell = start * (1 + sellPct);
  for(let i=1;i<=CYCLES;i++){
    let buy;
    if(i===1){
      buy = start; // Row 1 planned buy = entry/start price
    }else{
      sell = sell * (1 + sellPct); // step to this cycle's sell
      buy = sell * (1 - buyPct);
    }
    // Profit/share uses this row's sell - buy
    const profit = sell - buy;
    rows.push({
      plannedBuy: Number(fmt(buy)),
      plannedSell: Number(fmt(sell)),
      profitShare: Number(fmt(profit)),
      plannedQty: defaultShares,
      plannedTotal: Number(fmt(profit * defaultShares)),
      sellDate: '',
      actualBuy: '',
      actualSell: '',
      filledQty: '',
      realizedPL: 0,
      deltaVsPlan: 0,
      cumRealized: 0
    });
  }
  return rows;
}

function addOrReplaceAsset(){
  const t = document.getElementById('ticker').value.trim();
  const rSel = document.getElementById('rungs').value;
  const nRungs = rSel.startsWith('2')?2:rSel.startsWith('3')?3:4;
  const start = parseFloat(document.getElementById('startPrice').value);
  const defShares = parseInt(document.getElementById('defaultShares').value||'1',10);
  if(!t || !isFinite(start)) { alert('Enter ticker and a valid start price'); return; }

  const sellPcts = presetsSell.slice(0,nRungs);
  const buyPcts  = presetsBuyback.slice(0,nRungs);

  const rungs = [];
  for(let i=0;i<nRungs;i++){
    rungs.push({
      name: `Rung ${i+1}`,
      sellPct: sellPcts[i],
      buyPct: buyPcts[i],
      rows: buildRungRows(start, sellPcts[i], buyPcts[i], defShares)
    });
  }

  // replace by ticker (case-insensitive)
  const ix = assets.findIndex(a => a.ticker.toLowerCase() === t.toLowerCase());
  const asset = { ticker:t, start:Number(fmt(start)), rungs };
  if(ix >= 0) assets[ix] = asset; else assets.push(asset);
  save();
  renderAssets();
  alert('Added / replaced');
}

function renderAssets(){
  const holder = document.getElementById('assets');
  holder.innerHTML = '';
  assets.forEach((a, ai)=>{
    const card = document.createElement('div');
    card.className = 'card';
    const badges = `<span class="badge">${a.ticker}</span><span class="badge">${a.rungs.length} rung(s)</span><span class="badge">start $${fmt(a.start)}</span>`;
    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <div>${badges}</div>
        <div class="actions">
          <button onclick="rebuild(${ai})">Build Ladder</button>
          <button class="muted" onclick="exportCSV(${ai})">Export CSV</button>
          <button class="warn" onclick="delAsset(${ai})">Delete Ladder</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Rungs use locked defaults: Sell +2.5%, +4.5%, +7%, +10% â€¢ Buyback 1%, 2.5%, 3.5%, 5% â€¢ 20 cycles. Edit any cell inline.</div>
      <div style="margin-top:8px">${a.rungs.map((r,ri)=>renderRung(a,ai,r,ri)).join('')}</div>
    `;
    holder.appendChild(card);
  });

  // charts summary counters
  document.getElementById('assetCount').textContent = assets.length;
  const {open, closed, total} = computePortfolio();
  document.getElementById('openRows').textContent = open;
  document.getElementById('closedRows').textContent = closed;
  document.getElementById('portfolioTotal').textContent = money(total);
}

function renderRung(a, ai, r, ri){
  let rows = '';
  r.rows.forEach((row, idx)=>{
    rows += `
      <tr>
        <td class="center">${idx+1}</td>
        <td><input inputmode="decimal" value="${fmt(row.plannedBuy)}" onchange="cell(${ai},${ri},${idx},'plannedBuy',this.value)"></td>
        <td><input inputmode="decimal" value="${fmt(row.plannedSell)}" onchange="cell(${ai},${ri},${idx},'plannedSell',this.value)"></td>
        <td class="right">${money(row.profitShare)}</td>
        <td><input inputmode="numeric" value="${row.plannedQty}" onchange="cell(${ai},${ri},${idx},'plannedQty',this.value)"></td>
        <td class="right">${money(row.plannedTotal)}</td>
        <td><input type="date" value="${row.sellDate}" onchange="cell(${ai},${ri},${idx},'sellDate',this.value)"></td>
        <td><input inputmode="decimal" placeholder="" value="${row.actualBuy}" onchange="cell(${ai},${ri},${idx},'actualBuy',this.value)"></td>
        <td><input inputmode="decimal" placeholder="" value="${row.actualSell}" onchange="cell(${ai},${ri},${idx},'actualSell',this.value)"></td>
        <td><input inputmode="numeric" placeholder="" value="${row.filledQty}" onchange="cell(${ai},${ri},${idx},'filledQty',this.value)"></td>
        <td class="right">${money(row.realizedPL||0)}</td>
      </tr>
    `;
  });

  return `
    <h3>${a.ticker} â€” ${r.name} <span class="tag">Sell +${(r.sellPct*100).toFixed(1)}%</span> <span class="tag">Buyback ${(r.buyPct*100).toFixed(1)}%</span></h3>
    <div class="small">Row 1 Planned Buy equals Start Price; subsequent rows apply the rung's %.</div>
    <div class="table">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Planned Buy</th>
            <th>Planned Sell</th>
            <th class="right">Profit/Share</th>
            <th>Planned Shares</th>
            <th class="right">Planned Total</th>
            <th>Sell Date</th>
            <th>Actual Buy</th>
            <th>Actual Sell</th>
            <th>Filled Qty</th>
            <th class="right">Realized P/L</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

function cell(ai,ri,idx,key,val){
  const a = assets[ai];
  const row = a.rungs[ri].rows[idx];
  // coerce
  if(['plannedBuy','plannedSell','actualBuy','actualSell'].includes(key)){
    row[key] = val===''? '' : Number(parseFloat(val).toFixed(2));
  }else if(key==='plannedQty' || key==='filledQty'){
    row[key] = val===''? '' : parseInt(val,10);
  }else if(key==='sellDate'){
    row[key] = val;
  }
  // recompute profit/plan totals
  row.profitShare = (row.plannedSell && row.plannedBuy)? Number((row.plannedSell - row.plannedBuy).toFixed(2)) : 0;
  row.plannedTotal = Number((row.profitShare * (row.plannedQty||0)).toFixed(2));
  // realized
  if(row.actualBuy!=='' && row.actualSell!=='' && row.filledQty){
    row.realizedPL = Number(((row.actualSell - row.actualBuy) * row.filledQty).toFixed(2));
  }else{
    row.realizedPL = 0;
  }
  save();
  renderAssets();
}

function exportCSV(ai){
  const a = assets[ai];
  let out = 'Ticker,Rung,#,Planned Buy,Planned Sell,Profit/Share,Planned Shares,Planned Total,Sell Date,Actual Buy,Actual Sell,Filled Qty,Realized P/L\n';
  a.rungs.forEach((r,ri)=>{
    r.rows.forEach((row,i)=>{
      out += [a.ticker, r.name, i+1, fmt(row.plannedBuy), fmt(row.plannedSell), fmt(row.profitShare), row.plannedQty, fmt(row.plannedTotal), row.sellDate, row.actualBuy, row.actualSell, row.filledQty, fmt(row.realizedPL||0)].join(',')+'\n';
    });
  });
  const blob = new Blob([out],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const aTag = document.createElement('a');
  aTag.href = url; aTag.download = `${a.ticker}_ladder.csv`; aTag.click();
  URL.revokeObjectURL(url);
}

function delAsset(ai){
  if(!confirm('Delete this ladder?')) return;
  assets.splice(ai,1);
  save(); renderAssets();
}

function rebuild(ai){
  // rebuild rows from presets using the asset's start
  const a = assets[ai];
  const nRungs = a.rungs.length;
  const sellPcts = presetsSell.slice(0,nRungs);
  const buyPcts = presetsBuyback.slice(0,nRungs);
  a.rungs = a.rungs.map((r,i)=> ({
    name: `Rung ${i+1}`,
    sellPct: sellPcts[i],
    buyPct: buyPcts[i],
    rows: buildRungRows(a.start, sellPcts[i], buyPcts[i], r.rows?.[0]?.plannedQty||1)
  }));
  save(); renderAssets();
}

function computePortfolio(){
  let open=0, closed=0, total=0;
  assets.forEach(a=>a.rungs.forEach(r=>r.rows.forEach(row=>{
    if(row.actualBuy!=='' && row.actualSell!=='' && row.filledQty){
      closed += 1; total += Number(row.realizedPL||0);
    }else{
      open += 1;
    }
  })) );
  return {open, closed, total:Number(total.toFixed(2))};
}

// charts
let chart;
function buildChart(){
  const ctx = document.getElementById('plChart').getContext('2d');
  if(chart) chart.destroy();
  const daily = new Map();
  assets.forEach(a=>a.rungs.forEach(r=>r.rows.forEach(row=>{
    if(row.sellDate && row.actualBuy!=='' && row.actualSell!=='' && row.filledQty){
      const d = row.sellDate;
      const pl = Number(((row.actualSell - row.actualBuy) * row.filledQty).toFixed(2));
      daily.set(d, (daily.get(d)||0) + pl);
    }
  })));
  // filter by date range
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  const labels = Array.from(daily.keys()).sort().filter(d => (!from || d>=from) && (!to || d<=to));
  const data = labels.map(d=>daily.get(d));

  chart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{label:'Realized P/L', data}]},
    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
  });
}

document.getElementById('addAsset').onclick = addOrReplaceAsset;
document.getElementById('exportJson').onclick = ()=>{
  const blob = new Blob([JSON.stringify(assets,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='ladder_assets.json'; a.click();
  URL.revokeObjectURL(url);
};
document.getElementById('importJson').onclick = ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
  inp.onchange = () => {
    const f = inp.files[0]; if(!f) return;
    const fr = new FileReader();
    fr.onload = e => { try{ assets = JSON.parse(e.target.result) || []; save(); renderAssets(); alert('Imported'); }catch(err){ alert('Invalid JSON'); } };
    fr.readAsText(f);
  };
  inp.click();
};
document.getElementById('clearAll').onclick = ()=>{
  if(!confirm('Clear all data saved on this device?')) return;
  assets = []; save(); renderAssets();
};

// tabs
document.getElementById('tabLadders').onclick = ()=>{
  document.getElementById('viewLadders').style.display='block';
  document.getElementById('viewCharts').style.display='none';
  document.getElementById('tabLadders').classList.add('active');
  document.getElementById('tabCharts').classList.remove('active');
};
document.getElementById('tabCharts').onclick = ()=>{
  document.getElementById('viewLadders').style.display='none';
  document.getElementById('viewCharts').style.display='block';
  document.getElementById('tabCharts').classList.add('active');
  document.getElementById('tabLadders').classList.remove('active');
  const {total} = computePortfolio();
  document.getElementById('portfolioTotal').textContent = money(total);
  buildChart();
};
document.getElementById('updateChart').onclick = buildChart;

// hydrate and go
renderAssets();
</script>
</body>
</html>
