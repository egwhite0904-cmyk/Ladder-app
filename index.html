<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ladder App</title>
<style>
:root{
  --green:#0aa36d; --green-2:#128c63; --red:#d33; --bg:#f5f7f8; --ink:#1f2937;
  --muted:#6b7280; --card:#fff; --border:#e5e7eb;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.45 -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
header{position:sticky;top:0;z-index:3;background:linear-gradient(0deg,var(--green-2),var(--green));color:#fff;padding:12px 16px;box-shadow:0 1px 0 rgba(0,0,0,.08)}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:20px}
.brand .logo{font-size:22px}
.tabs{display:flex;gap:12px;margin-top:8px}
.tab{background:#fff1;border:2px solid #fff3;color:#fff;padding:8px 14px;border-radius:12px}
.tab.active{background:#fff;color:var(--green);border-color:#fff}
.container{max-width:980px;margin:18px auto;padding:0 14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 1px 0 #00000008;margin-bottom:14px}
h2{margin:0 0 8px 0}
label{display:block;font-weight:600;margin:10px 0 6px 0}
input,select,button,textarea{font:inherit}
input[type="number"], input[type="text"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;min-height:44px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
.btn.green{background:var(--green);color:#fff}
.btn.gray{background:#1111;border:1px solid var(--border)}
.btn.red{background:var(--red);color:#fff}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#00000008;border:1px solid var(--border);font-weight:600;color:#374151}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:740px){.grid{grid-template-columns:1fr}}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-size:13px;text-align:left;color:#374151;padding:8px 10px}
.table td{padding:6px 8px;vertical-align:middle}
.cell{display:flex}
.cell input{width:100%;min-width:110px; /* wider fields so full amounts are visible */
  text-align:center}
#assets{display:flex;flex-direction:column;gap:12px}

/* Accordion */
.asset{border:1px solid var(--border);border-radius:12px;background:#fff;overflow:hidden}
.asset header{position:relative;background:#f8fafc;color:var(--ink);padding:12px 14px;display:flex;align-items:center;gap:8px;justify-content:space-between}
.asset header .title{font-weight:800}
.asset .meta{display:flex;gap:8px;flex-wrap:wrap}
.asset .body{display:none;padding:12px}
.asset.open .body{display:block}

/* helper ribbon */
.helper{position:fixed;right:10px;top:10px;background:#0b915f;color:#fff;border-radius:999px;padding:6px 10px;font-weight:700;box-shadow:0 2px 8px #0001}
.helper.bad{background:#999}

/* charts */
#chartArea{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;min-height:280px}

.note{color:var(--muted);font-size:13px}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#f3f4f6;border:1px solid var(--border);border-radius:6px;padding:1px 6px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <span class="logo">ðŸªœ</span>
    <div>Ladder App</div>
    <div id="ready" class="helper bad">â€¦</div>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="ladders">Ladders</button>
    <button class="tab" data-tab="charts">Charts</button>
  </div>
</header>

<div class="container">

  <!-- LADDERS TAB -->
  <section id="ladders" class="tabpane">
    <div class="card">
      <h2>Add / Replace Asset</h2>
      <div class="grid">
        <div>
          <label>Ticker / Name</label>
          <input id="sym" type="text" placeholder="e.g., RIOT or COIN">
        </div>
        <div>
          <label>Start Price</label>
          <input id="startPrice" inputmode="decimal" type="number" step="0.01" placeholder="current price">
        </div>
      </div>
      <p class="card note">
        <b>Presets (locked):</b> Sell <b>+2.5%</b>, <b>+4.5%</b>, <b>+7%</b>, <b>+10%</b> (rungs 1â€“4). Buyback <b>1%</b>, <b>2.5%</b>, <b>3.5%</b>, <b>5%</b> (rungs 1â€“4). 20 cycles.
        Row 1 <b>Planned Buy</b> equals Start Price; each next row uses: <span class="kbd">nextBuy = prevSell Ã— (1 âˆ’ buyback%)</span> and <span class="kbd">sell = buy Ã— (1 + sell%)</span>.
      </p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn green" id="addAsset">+ Add / Replace Asset</button>
        <button class="btn gray" id="saveJson">Save Backup (JSON)</button>
        <button class="btn gray" id="loadJson">Restore Backup (JSON)</button>
        <button class="btn gray" id="exportCsv">Export CSV (Excel)</button>
        <button class="btn red" id="clearAll">Clear All (this device)</button>
      </div>
    </div>

    <div id="assets"></div>
  </section>

  <!-- CHARTS TAB -->
  <section id="charts" class="tabpane" style="display:none">
    <div class="card">
      <h2>Totals & Charts</h2>
      <div id="chartArea">
        <canvas id="bar" width="800" height="320"></canvas>
      </div>
      <p class="note">Chart uses your local saved ladder rows where both <b>Sell Date</b> and <b>Actual Sell</b> are filled to compute realized P/L per date.</p>
    </div>
  </section>

</div>

<script>
// ----------------------- State & helpers -----------------------
const STORAGE_KEY = "ladder.v2.assets";
const el = sel => document.querySelector(sel);
const els = sel => [...document.querySelectorAll(sel)];
const fmt = n => (isNaN(+n)? "" : (+n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}));
const pct = p => (p/100);

// Locked presets
const SELL_PCTS  = [2.5, 4.5, 7, 10];
const BUYBACKS   = [1, 2.5, 3.5, 5];
const ROWS = 20;

let assets = load() || [];

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw? JSON.parse(raw): null;
  }catch(e){ return null; }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(assets));
  renderAssets();
}
function readyBadge(){
  const ok = (function(){
    try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); return true; }catch(e){return false;}
  })();
  const b = el("#ready");
  b.textContent = ok? "ready" : "no storage";
  b.classList.toggle("bad", !ok);
}

// ----------------------- UI Tabs -----------------------
els(".tab").forEach(t=>t.addEventListener("click",()=>{
  els(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const id = t.dataset.tab;
  els(".tabpane").forEach(p=>p.style.display = (p.id===id)?"block":"none");
  if(id==="charts") drawChart();
}));

// ----------------------- Build ladder rows -----------------------
function buildRows(rungIndex, startPrice){
  const sellPct = SELL_PCTS[Math.min(rungIndex, SELL_PCTS.length-1)];
  const buybackPct = BUYBACKS[Math.min(rungIndex, BUYBACKS.length-1)];
  const rows = [];
  let buy = +startPrice;
  for(let i=0;i<ROWS;i++){
    const sell = buy*(1+pct(sellPct));
    rows.push({
      cycle: i+1,
      plannedBuy: +buy.toFixed(2),
      plannedSell: +sell.toFixed(2),
      profitShare: +(sell - buy).toFixed(2),
      plannedShares: 1,
      plannedTotal: +(sell - buy).toFixed(2),
      buyDate:"", sellDate:"", actualBuy:"", actualSell:"", filledQty:"",
      realized: ""
    });
    // next buy starts from previous SELL stepped down by buyback%
    buy = sell*(1 - pct(buybackPct));
  }
  return {sellPct, buybackPct, rows};
}

// ----------------------- Render -----------------------
function renderAssets(){
  const wrap = el("#assets");
  wrap.innerHTML = "";
  assets.forEach((a,idx)=>{
    const card = document.createElement("div");
    card.className = "asset"+(idx===0?" open":"");
    card.innerHTML = `
      <header>
        <div class="title">${a.symbol.toUpperCase()}</div>
        <div class="meta">
          <span class="badge">${a.rungs} rung(s)</span>
          <span class="badge">start ${fmt(a.startPrice)}</span>
        </div>
        <div>
          <button class="btn gray" data-act="collapse">Toggle</button>
          <button class="btn red" data-act="delete">Delete Ladder</button>
        </div>
      </header>
      <div class="body"></div>
    `;
    // body table
    const body = card.querySelector(".body");
    for(let r=0;r<a.rungs;r++){
      const ladder = a.ladders[r];
      const rungDiv = document.createElement("div");
      rungDiv.className="card";
      rungDiv.innerHTML = `
        <h3 style="margin:0 0 8px"> ${a.symbol.toUpperCase()} â€” Rung ${r+1}
          <span class="badge">Sell +${ladder.sellPct}%</span>
          <span class="badge">Buyback ${ladder.buybackPct}%</span>
        </h3>
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Planned Buy</th>
              <th>Planned Sell</th>
              <th>Profit/Share</th>
              <th>Planned Shares</th>
              <th>Planned Total</th>
              <th>Buy Date</th>
              <th>Sell Date</th>
              <th>Actual Buy</th>
              <th>Actual Sell</th>
              <th>Filled Qty</th>
              <th>Realized P/L</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;
      const tbody = rungDiv.querySelector("tbody");
      ladder.rows.forEach((row,i)=>{
        const tr = document.createElement("tr");
        function tdInput(val, attrs=""){ 
          return `<td class="cell"><input ${attrs} value="${val!==undefined && val!==null? val : ""}"></td>`;
        }
        tr.innerHTML = `
          <td>${i+1}</td>
          ${tdInput(row.plannedBuy,'inputmode="decimal" step="0.01"')}
          ${tdInput(row.plannedSell,'inputmode="decimal" step="0.01"')}
          <td>$${fmt(row.profitShare)}</td>
          ${tdInput(row.plannedShares,'inputmode="numeric" step="1"')}
          <td>$${fmt(row.plannedTotal)}</td>
          ${tdInput(row.buyDate,'placeholder="e.g., 2025-08-20"')}
          ${tdInput(row.sellDate,'placeholder="e.g., 2025-08-25"')}
          ${tdInput(row.actualBuy,'inputmode="decimal" step="0.01"')}
          ${tdInput(row.actualSell,'inputmode="decimal" step="0.01"')}
          ${tdInput(row.filledQty,'inputmode="numeric" step="1"')}
          <td>${row.realized? "$"+fmt(row.realized): ""}</td>
        `;
        // attach input handlers to recompute derived totals
        tr.querySelectorAll("input").forEach((inp,ci)=>{
          inp.addEventListener("change", e=>{
            const v = inp.value.trim();
            // map cell to model
            const keys = ["plannedBuy","plannedSell",null,"plannedShares",null,"buyDate","sellDate","actualBuy","actualSell","filledQty"];
            const key = keys[[1,2,3,4,5,6,7,8,9,10].indexOf(ci+1)];
            if(key){ ladder.rows[i][key] = (key.includes("Date")? v : (v===""? "" : +(+v).toFixed(2))); }
            // derived fields
            const pb = +ladder.rows[i].plannedBuy || 0;
            const ps = +ladder.rows[i].plannedSell || 0;
            ladder.rows[i].profitShare = +(ps - pb).toFixed(2);
            const sh = +ladder.rows[i].plannedShares || 0;
            ladder.rows[i].plannedTotal = +(ladder.rows[i].profitShare * sh).toFixed(2);
            const ab = +ladder.rows[i].actualBuy || 0;
            const as = +ladder.rows[i].actualSell || 0;
            const fq = +ladder.rows[i].filledQty || 0;
            ladder.rows[i].realized = +((as - ab) * fq).toFixed(2);
            save();
          });
        });
        tbody.appendChild(tr);
      });
      body.appendChild(rungDiv);
    }
    // listeners for header buttons
    card.querySelector('[data-act="collapse"]').addEventListener("click",()=>{
      // accordion: close others
      els(".asset").forEach(x=>{ if(x!==card) x.classList.remove("open"); });
      card.classList.toggle("open");
    });
    card.querySelector('[data-act="delete"]').addEventListener("click",()=>{
      if(confirm("Delete this ladder?")){ assets.splice(idx,1); save(); }
    });
    wrap.appendChild(card);
  });
}

// ----------------------- Add/Replace asset -----------------------
function addOrReplace(){
  const symbol = (el("#sym").value || "").trim();
  const start = +(el("#startPrice").value || "").trim();
  if(!symbol || !isFinite(start)){ alert("Enter symbol and start price."); return; }
  const rungs = 4; // allow up to 4 rungs by default; you can edit count later by removing ladders
  const ladders = [];
  for(let r=0;r<rungs;r++) ladders.push(buildRows(r, start));
  const existing = assets.findIndex(a=>a.symbol.toUpperCase()===symbol.toUpperCase());
  const payload = {symbol,startPrice:start,rungs:ladders.length,ladders};
  if(existing>=0) assets[existing]=payload; else assets.unshift(payload);
  save();
  // reset inputs
  el("#sym").value=""; el("#startPrice").value="";
  // open the new/updated one
  setTimeout(()=>{
    const first = el("#assets .asset");
    if(first){ els(".asset").forEach(x=>x.classList.remove("open")); first.classList.add("open"); }
  },0);
}

// ----------------------- CSV & JSON -----------------------
function exportCsv(){
  const lines = [["Symbol","Rung","#","PlannedBuy","PlannedSell","ProfitShare","PlannedShares","PlannedTotal","BuyDate","SellDate","ActualBuy","ActualSell","FilledQty","RealizedPL"]];
  assets.forEach(a=>{
    a.ladders.forEach((lad,ri)=>{
      lad.rows.forEach(row=>{
        lines.push([a.symbol, ri+1, row.cycle, row.plannedBuy, row.plannedSell, row.profitShare, row.plannedShares, row.plannedTotal, row.buyDate, row.sellDate, row.actualBuy, row.actualSell, row.filledQty, row.realized]);
      });
    });
  });
  const csv = lines.map(r=>r.map(v=>String(v).replace(/"/g,'""')).map(v=>`"${v}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "ladder_export.csv"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function saveJsonFile(){
  const blob = new Blob([JSON.stringify(assets,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="ladder_backup.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function loadJsonFile(){
  const inp = document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange = () => {
    const f = inp.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => { try{ assets = JSON.parse(reader.result); save(); }catch(e){ alert("Invalid JSON"); } };
    reader.readAsText(f);
  };
  inp.click();
}

// ----------------------- Charts -----------------------
function drawChart(){
  const canvas = el("#bar");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Aggregate realized P/L by sellDate
  const map = {};
  assets.forEach(a=>a.ladders.forEach(l=>l.rows.forEach(r=>{
    if(r.sellDate && r.actualSell && r.actualBuy && r.filledQty){
      const d = r.sellDate;
      const pl = (r.actualSell - r.actualBuy) * r.filledQty;
      map[d] = (map[d]||0) + pl;
    }
  })));
  const labels = Object.keys(map).sort();
  const data = labels.map(k=>map[k]);
  // simple bar chart without external libs
  const W = canvas.width, H = canvas.height, pad=40;
  const max = Math.max(1, ...data.map(v=>Math.abs(v)));
  const barW = (W - pad*2) / (labels.length||1);
  // axes
  ctx.strokeStyle = "#94a3b8";
  ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();
  // bars
  data.forEach((v,i)=>{
    const h = (Math.abs(v)/max) * (H - pad*2);
    const x = pad + i*barW + barW*0.1;
    const y = v>=0 ? (H-pad - h) : (H-pad);
    ctx.fillStyle = v>=0 ? "#60a5fa" : "#f87171";
    ctx.fillRect(x, y, barW*0.8, h);
    // label
    ctx.fillStyle="#111827"; ctx.font="12px system-ui"; ctx.textAlign="center";
    ctx.fillText(labels[i], x+barW*0.4, H-pad+14);
  });
}

// ----------------------- Events -----------------------
el("#addAsset").addEventListener("click", addOrReplace);
el("#saveJson").addEventListener("click", saveJsonFile);
el("#loadJson").addEventListener("click", loadJsonFile);
el("#exportCsv").addEventListener("click", exportCsv);
el("#clearAll").addEventListener("click", ()=>{ if(confirm("Clear all ladders from this device?")) { assets=[]; save(); }});

// Initial render
readyBadge();
renderAssets();
</script>
</body>
</html>
